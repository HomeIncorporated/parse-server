"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ImportRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var middlewares = _interopRequireWildcard(require("../middlewares"));

var _multer = _interopRequireDefault(require("multer"));

var _rest = _interopRequireDefault(require("../rest"));

var _node = require("parse/node");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ImportRouter {
  getOneSchema(req) {
    const className = req.params.className;
    return req.config.database.loadSchema({
      clearCache: true
    }).then(schemaController => schemaController.getOneSchema(className)).catch(error => {
      if (error === undefined) {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`));
      } else {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.'));
      }
    });
  }

  importRestObject(req, restObject, targetClass) {
    if (targetClass) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.owningId
      }, {
        [req.params.relationName]: {
          "__op": "AddRelation",
          "objects": [{
            "__type": "Pointer",
            "className": targetClass,
            "objectId": restObject.relatedId
          }]
        }
      }, undefined, req.info.clientSDK, {
        allowObjectId: true
      }).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return Promise.reject(new _node.Parse.Error(_node.Parse.Error.OBJECT_NOT_FOUND, 'Object not found'));
        } else {
          return Promise.reject(error);
        }
      });
    }

    if (restObject.createdAt) {
      delete restObject.createdAt;
    }

    if (restObject.updatedAt) {
      delete restObject.updatedAt;
    }

    if (restObject.objectId) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.objectId
      }, restObject, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return _rest.default.create(req.config, req.auth, req.params.className, restObject, undefined, req.info.clientSDK, {
            allowObjectId: true
          });
        } else {
          return Promise.reject(error);
        }
      });
    }

    return _rest.default.create(req.config, req.auth, req.params.className, restObject);
  }

  getRestObjects(req) {
    return new Promise(resolve => {
      let restObjects = [];
      let importFile;

      try {
        importFile = JSON.parse(req.file.buffer.toString());
      } catch (e) {
        throw new Error('Failed to parse JSON based on the file sent');
      }

      if (Array.isArray(importFile)) {
        restObjects = importFile;
      } else if (Array.isArray(importFile.results)) {
        restObjects = importFile.results;
      } else if (Array.isArray(importFile.rows)) {
        restObjects = importFile.rows;
      }

      if (!restObjects) {
        throw new Error('No data to import');
      }

      if (req.body.feedbackEmail) {
        if (!req.config.emailAdapter) {
          throw new Error('You have to setup a Mail Adapter.');
        }
      }

      resolve(restObjects);
    });
  }

  handleImport(req) {
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);
    let promise = null;

    if (req.params.relationName) {
      promise = this.getOneSchema(req).then(response => {
        if (!response.fields.hasOwnProperty(req.params.relationName)) {
          throw new Error(`Relation ${req.params.relationName} does not exist in ${req.params.className}.`);
        } else if (response.fields[req.params.relationName].type !== 'Relation') {
          throw new Error(`Class ${response.fields[req.params.relationName].targetClass} does not have Relation type.`);
        }

        const targetClass = response.fields[req.params.relationName].targetClass;
        return Promise.all([this.getRestObjects(req), targetClass]);
      });
    } else {
      promise = Promise.all([this.getRestObjects(req)]);
    }

    promise = promise.then(([restObjects, targetClass]) => {
      return restObjects.reduce((item, object, index) => {
        item.pageArray.push(this.importRestObject.bind(this, req, object, targetClass));

        if (index && index % 100 === 0 || index === restObjects.length - 1) {
          const pageArray = item.pageArray.slice(0);
          item.pageArray = [];
          item.mainPromise = item.mainPromise.then(results => {
            return Promise.all(results.concat(pageArray.map(func => func())));
          });
        }

        return item;
      }, {
        pageArray: [],
        mainPromise: Promise.resolve([])
      }).mainPromise;
    }).then(results => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We have successfully imported your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}.`,
          to: req.body.feedbackEmail,
          subject: 'Import completed'
        });
      } else {
        return Promise.resolve({
          response: results
        });
      }
    }).catch(error => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We could not import your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}. Error: ${error}`,
          to: req.body.feedbackEmail,
          subject: 'Import failed'
        });
      } else {
        throw new Error('Internal server error: ' + error);
      }
    });

    if (req.body.feedbackEmail && emailControllerAdapter) {
      promise = Promise.resolve({
        response: 'We are importing your data. You will be notified by e-mail once it is completed.'
      });
    }

    return promise;
  }

  wrapPromiseRequest(req, res, handler) {
    return handler(req).then(data => {
      res.json(data);
    }).catch(err => {
      res.status(400).send({
        message: err.message
      });
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    const upload = (0, _multer.default)();
    router.post('/import_data/:className', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    router.post('/import_relation_data/:className/:relationName', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    return router;
  }

}

exports.ImportRouter = ImportRouter;
var _default = ImportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ltcG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJJbXBvcnRSb3V0ZXIiLCJnZXRPbmVTY2hlbWEiLCJyZXEiLCJjbGFzc05hbWUiLCJwYXJhbXMiLCJjb25maWciLCJkYXRhYmFzZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwidGhlbiIsInNjaGVtYUNvbnRyb2xsZXIiLCJjYXRjaCIsImVycm9yIiwidW5kZWZpbmVkIiwiUHJvbWlzZSIsInJlamVjdCIsIlBhcnNlIiwiRXJyb3IiLCJJTlZBTElEX0NMQVNTX05BTUUiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiLCJpbXBvcnRSZXN0T2JqZWN0IiwicmVzdE9iamVjdCIsInRhcmdldENsYXNzIiwicmVzdCIsInVwZGF0ZSIsImF1dGgiLCJvYmplY3RJZCIsIm93bmluZ0lkIiwicmVsYXRpb25OYW1lIiwicmVsYXRlZElkIiwiaW5mbyIsImNsaWVudFNESyIsImFsbG93T2JqZWN0SWQiLCJjb2RlIiwiT0JKRUNUX05PVF9GT1VORCIsImNyZWF0ZWRBdCIsInVwZGF0ZWRBdCIsImNyZWF0ZSIsImdldFJlc3RPYmplY3RzIiwicmVzb2x2ZSIsInJlc3RPYmplY3RzIiwiaW1wb3J0RmlsZSIsIkpTT04iLCJwYXJzZSIsImZpbGUiLCJidWZmZXIiLCJ0b1N0cmluZyIsImUiLCJBcnJheSIsImlzQXJyYXkiLCJyZXN1bHRzIiwicm93cyIsImJvZHkiLCJmZWVkYmFja0VtYWlsIiwiZW1haWxBZGFwdGVyIiwiaGFuZGxlSW1wb3J0IiwiZW1haWxDb250cm9sbGVyQWRhcHRlciIsInByb21pc2UiLCJyZXNwb25zZSIsImZpZWxkcyIsImhhc093blByb3BlcnR5IiwidHlwZSIsImFsbCIsInJlZHVjZSIsIml0ZW0iLCJvYmplY3QiLCJpbmRleCIsInBhZ2VBcnJheSIsInB1c2giLCJiaW5kIiwibGVuZ3RoIiwic2xpY2UiLCJtYWluUHJvbWlzZSIsImNvbmNhdCIsIm1hcCIsImZ1bmMiLCJzZW5kTWFpbCIsInRleHQiLCJ0byIsInN1YmplY3QiLCJ3cmFwUHJvbWlzZVJlcXVlc3QiLCJyZXMiLCJoYW5kbGVyIiwiZGF0YSIsImpzb24iLCJlcnIiLCJzdGF0dXMiLCJzZW5kIiwibWVzc2FnZSIsImV4cHJlc3NSb3V0ZXIiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwidXBsb2FkIiwicG9zdCIsInNpbmdsZSIsIm1pZGRsZXdhcmVzIiwiYWxsb3dDcm9zc0RvbWFpbiIsImhhbmRsZVBhcnNlSGVhZGVycyIsImVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRU8sTUFBTUEsWUFBTixDQUFtQjtBQUV4QkMsRUFBQUEsWUFBWSxDQUFDQyxHQUFELEVBQU07QUFFaEIsVUFBTUMsU0FBUyxHQUFHRCxHQUFHLENBQUNFLE1BQUosQ0FBV0QsU0FBN0I7QUFFQSxXQUFPRCxHQUFHLENBQUNHLE1BQUosQ0FBV0MsUUFBWCxDQUFvQkMsVUFBcEIsQ0FBK0I7QUFBQ0MsTUFBQUEsVUFBVSxFQUFFO0FBQWIsS0FBL0IsRUFDSkMsSUFESSxDQUNDQyxnQkFBZ0IsSUFBSUEsZ0JBQWdCLENBQUNULFlBQWpCLENBQThCRSxTQUE5QixDQURyQixFQUVKUSxLQUZJLENBRUVDLEtBQUssSUFBSTtBQUNkLFVBQUlBLEtBQUssS0FBS0MsU0FBZCxFQUF5QjtBQUN2QixlQUFPQyxPQUFPLENBQUNDLE1BQVIsQ0FBZSxJQUFJQyxZQUFNQyxLQUFWLENBQWdCRCxZQUFNQyxLQUFOLENBQVlDLGtCQUE1QixFQUNuQixTQUFRZixTQUFVLGtCQURDLENBQWYsQ0FBUDtBQUVELE9BSEQsTUFHTztBQUNMLGVBQU9XLE9BQU8sQ0FBQ0MsTUFBUixDQUFlLElBQUlDLFlBQU1DLEtBQVYsQ0FBZ0JELFlBQU1DLEtBQU4sQ0FBWUUscUJBQTVCLEVBQ3BCLHlCQURvQixDQUFmLENBQVA7QUFFRDtBQUNGLEtBVkks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WSxnREFBWixFQUNFRCxNQUFNLENBQUNFLE1BQVAsQ0FBYyxZQUFkLENBREYsRUFFRUMsV0FBVyxDQUFDQyxnQkFGZCxFQUdFRCxXQUFXLENBQUNFLGtCQUhkLEVBSUVGLFdBQVcsQ0FBQ0csc0JBSmQsRUFLRSxDQUFDakcsR0FBRCxFQUFNK0UsR0FBTixLQUFjLEtBQUtELGtCQUFMLENBQXdCOUUsR0FBeEIsRUFBNkIrRSxHQUE3QixFQUFrQyxLQUFLMUIsWUFBTCxDQUFrQmMsSUFBbEIsQ0FBdUIsSUFBdkIsQ0FBbEMsQ0FMaEI7QUFRQSxXQUFPcUIsTUFBUDtBQUNEOztBQWpOdUI7OztlQW9OWDFGLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyAgICAgICAgICBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGxvYWRBZGFwdGVyIH0gZnJvbSAnLi4vQWRhcHRlcnMvQWRhcHRlckxvYWRlcic7XG5pbXBvcnQgKiBhcyBtaWRkbGV3YXJlcyBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgbXVsdGVyICAgICAgICAgICBmcm9tICdtdWx0ZXInO1xuaW1wb3J0IHJlc3QgICAgICAgICAgICAgZnJvbSAnLi4vcmVzdCc7XG5pbXBvcnQgeyBQYXJzZSB9ICAgICAgICBmcm9tICdwYXJzZS9ub2RlJztcblxuZXhwb3J0IGNsYXNzIEltcG9ydFJvdXRlciB7XG5cbiAgZ2V0T25lU2NoZW1hKHJlcSkge1xuXG4gICAgY29uc3QgY2xhc3NOYW1lID0gcmVxLnBhcmFtcy5jbGFzc05hbWU7XG5cbiAgICByZXR1cm4gcmVxLmNvbmZpZy5kYXRhYmFzZS5sb2FkU2NoZW1hKHtjbGVhckNhY2hlOiB0cnVlfSlcbiAgICAgIC50aGVuKHNjaGVtYUNvbnRyb2xsZXIgPT4gc2NoZW1hQ29udHJvbGxlci5nZXRPbmVTY2hlbWEoY2xhc3NOYW1lKSlcbiAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgIGlmIChlcnJvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0NMQVNTX05BTUUsXG4gICAgICAgICAgICBgQ2xhc3MgJHtjbGFzc05hbWV9IGRvZXMgbm90IGV4aXN0LmApKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICAgICAgICdEYXRhYmFzZSBhZGFwdGVyIGVycm9yLicpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBpbXBvcnRSZXN0T2JqZWN0KHJlcSwgcmVzdE9iamVjdCwgdGFyZ2V0Q2xhc3MpIHtcbiAgICBpZiAodGFyZ2V0Q2xhc3MpIHtcbiAgICAgIHJldHVybiByZXN0LnVwZGF0ZShyZXEuY29uZmlnLCByZXEuYXV0aCwgcmVxLnBhcmFtcy5jbGFzc05hbWUsIHtvYmplY3RJZDogcmVzdE9iamVjdC5vd25pbmdJZH0sIHtcbiAgICAgICAgW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXToge1xuICAgICAgICAgIFwiX19vcFwiOiBcIkFkZFJlbGF0aW9uXCIsXG4gICAgICAgICAgXCJvYmplY3RzXCI6IFt7XCJfX3R5cGVcIjogXCJQb2ludGVyXCIsIFwiY2xhc3NOYW1lXCI6IHRhcmdldENsYXNzLCBcIm9iamVjdElkXCI6IHJlc3RPYmplY3QucmVsYXRlZElkfV1cbiAgICAgICAgfVxuICAgICAgfSwgdW5kZWZpbmVkLCByZXEuaW5mby5jbGllbnRTREssIHthbGxvd09iamVjdElkOiB0cnVlfSlcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikge1xuICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kJykpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHJlc3RPYmplY3QuY3JlYXRlZEF0KSB7XG4gICAgICBkZWxldGUgcmVzdE9iamVjdC5jcmVhdGVkQXQ7XG4gICAgfVxuXG4gICAgaWYgKHJlc3RPYmplY3QudXBkYXRlZEF0KSB7XG4gICAgICBkZWxldGUgcmVzdE9iamVjdC51cGRhdGVkQXQ7XG4gICAgfVxuXG4gICAgaWYgKHJlc3RPYmplY3Qub2JqZWN0SWQpIHtcbiAgICAgIHJldHVybiByZXN0XG4gICAgICAgIC51cGRhdGUocmVxLmNvbmZpZywgcmVxLmF1dGgsIHJlcS5wYXJhbXMuY2xhc3NOYW1lLCB7b2JqZWN0SWQ6IHJlc3RPYmplY3Qub2JqZWN0SWR9LCByZXN0T2JqZWN0LCByZXEuaW5mby5jbGllbnRTREspXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3QuY3JlYXRlKFxuICAgICAgICAgICAgICByZXEuY29uZmlnLFxuICAgICAgICAgICAgICByZXEuYXV0aCxcbiAgICAgICAgICAgICAgcmVxLnBhcmFtcy5jbGFzc05hbWUsXG4gICAgICAgICAgICAgIHJlc3RPYmplY3QsXG4gICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgcmVxLmluZm8uY2xpZW50U0RLLFxuICAgICAgICAgICAgICB7YWxsb3dPYmplY3RJZDogdHJ1ZX1cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiByZXN0LmNyZWF0ZShyZXEuY29uZmlnLCByZXEuYXV0aCwgcmVxLnBhcmFtcy5jbGFzc05hbWUsIHJlc3RPYmplY3QpO1xuICB9XG5cbiAgZ2V0UmVzdE9iamVjdHMocmVxKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG5cbiAgICAgIGxldCByZXN0T2JqZWN0cyA9IFtdO1xuICAgICAgbGV0IGltcG9ydEZpbGU7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGltcG9ydEZpbGUgPSBKU09OLnBhcnNlKHJlcS5maWxlLmJ1ZmZlci50b1N0cmluZygpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcGFyc2UgSlNPTiBiYXNlZCBvbiB0aGUgZmlsZSBzZW50Jyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGltcG9ydEZpbGUpKSB7XG4gICAgICAgIHJlc3RPYmplY3RzID0gaW1wb3J0RmlsZTtcbiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShpbXBvcnRGaWxlLnJlc3VsdHMpKSB7XG4gICAgICAgIHJlc3RPYmplY3RzID0gaW1wb3J0RmlsZS5yZXN1bHRzO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGltcG9ydEZpbGUucm93cykpIHtcbiAgICAgICAgcmVzdE9iamVjdHMgPSBpbXBvcnRGaWxlLnJvd3M7XG4gICAgICB9XG5cbiAgICAgIGlmICghcmVzdE9iamVjdHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBkYXRhIHRvIGltcG9ydCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAocmVxLmJvZHkuZmVlZGJhY2tFbWFpbCkge1xuICAgICAgICBpZiAoIXJlcS5jb25maWcuZW1haWxBZGFwdGVyKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgaGF2ZSB0byBzZXR1cCBhIE1haWwgQWRhcHRlci4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXNvbHZlKHJlc3RPYmplY3RzKTtcbiAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUltcG9ydChyZXEpIHtcblxuICAgIGNvbnN0IGVtYWlsQ29udHJvbGxlckFkYXB0ZXIgPSBsb2FkQWRhcHRlcihyZXEuY29uZmlnLmVtYWlsQWRhcHRlcik7XG5cbiAgICBsZXQgcHJvbWlzZSA9IG51bGw7XG5cbiAgICBpZiAocmVxLnBhcmFtcy5yZWxhdGlvbk5hbWUpIHtcbiAgICAgIHByb21pc2UgPSB0aGlzLmdldE9uZVNjaGVtYShyZXEpXG4gICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIGlmICghcmVzcG9uc2UuZmllbGRzLmhhc093blByb3BlcnR5KHJlcS5wYXJhbXMucmVsYXRpb25OYW1lKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWxhdGlvbiAke3JlcS5wYXJhbXMucmVsYXRpb25OYW1lfSBkb2VzIG5vdCBleGlzdCBpbiAke3JlcS5wYXJhbXMuY2xhc3NOYW1lfS5gKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmZpZWxkc1tyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV0udHlwZSAhPT0gJ1JlbGF0aW9uJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDbGFzcyAke3Jlc3BvbnNlLmZpZWxkc1tyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV0udGFyZ2V0Q2xhc3N9IGRvZXMgbm90IGhhdmUgUmVsYXRpb24gdHlwZS5gKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCB0YXJnZXRDbGFzcyA9IHJlc3BvbnNlLmZpZWxkc1tyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV0udGFyZ2V0Q2xhc3M7XG5cbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW3RoaXMuZ2V0UmVzdE9iamVjdHMocmVxKSwgdGFyZ2V0Q2xhc3NdKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcHJvbWlzZSA9IFByb21pc2UuYWxsKFt0aGlzLmdldFJlc3RPYmplY3RzKHJlcSldKTtcbiAgICB9XG5cbiAgICBwcm9taXNlID0gcHJvbWlzZVxuICAgICAgLnRoZW4oKFtyZXN0T2JqZWN0cywgdGFyZ2V0Q2xhc3NdKSA9PiB7XG5cbiAgICAgICAgcmV0dXJuIHJlc3RPYmplY3RzLnJlZHVjZSgoaXRlbSwgb2JqZWN0LCBpbmRleCkgPT4ge1xuXG4gICAgICAgICAgaXRlbS5wYWdlQXJyYXkucHVzaCh0aGlzLmltcG9ydFJlc3RPYmplY3QuYmluZCh0aGlzLCByZXEsIG9iamVjdCwgdGFyZ2V0Q2xhc3MpKTtcblxuICAgICAgICAgIGlmIChpbmRleCAmJiBpbmRleCAlIDEwMCA9PT0gMCB8fCBpbmRleCA9PT0gKHJlc3RPYmplY3RzLmxlbmd0aCAtIDEpKSB7XG5cbiAgICAgICAgICAgIGNvbnN0IHBhZ2VBcnJheSA9IGl0ZW0ucGFnZUFycmF5LnNsaWNlKDApO1xuICAgICAgICAgICAgaXRlbS5wYWdlQXJyYXkgPSBbXTtcblxuICAgICAgICAgICAgaXRlbS5tYWluUHJvbWlzZSA9IGl0ZW0ubWFpblByb21pc2VcbiAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVzdWx0cy5jb25jYXQocGFnZUFycmF5Lm1hcChmdW5jID0+IGZ1bmMoKSkpKTtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfSwgeyBwYWdlQXJyYXk6IFtdLCBtYWluUHJvbWlzZSA6IFByb21pc2UucmVzb2x2ZShbXSkgfSkubWFpblByb21pc2U7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgaWYgKHJlcS5ib2R5LmZlZWRiYWNrRW1haWwpIHtcbiAgICAgICAgICBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICAgIHRleHQ6IGBXZSBoYXZlIHN1Y2Nlc3NmdWxseSBpbXBvcnRlZCB5b3VyIGRhdGEgdG8gdGhlIGNsYXNzICR7cmVxLnBhcmFtcy5jbGFzc05hbWV9JHtyZXEucGFyYW1zLnJlbGF0aW9uTmFtZSA/ICcsIHJlbGF0aW9uICcgKyByZXEucGFyYW1zLnJlbGF0aW9uTmFtZSA6ICcnIH0uYCxcbiAgICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgICAgc3ViamVjdDogJ0ltcG9ydCBjb21wbGV0ZWQnXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlc3BvbnNlOiByZXN1bHRzIH0pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICBpZiAocmVxLmJvZHkuZmVlZGJhY2tFbWFpbCkge1xuICAgICAgICAgIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgICAgdGV4dDogYFdlIGNvdWxkIG5vdCBpbXBvcnQgeW91ciBkYXRhIHRvIHRoZSBjbGFzcyAke3JlcS5wYXJhbXMuY2xhc3NOYW1lfSR7cmVxLnBhcmFtcy5yZWxhdGlvbk5hbWUgPyAnLCByZWxhdGlvbiAnICsgcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWUgOiAnJyB9LiBFcnJvcjogJHtlcnJvcn1gLFxuICAgICAgICAgICAgdG86IHJlcS5ib2R5LmZlZWRiYWNrRW1haWwsXG4gICAgICAgICAgICBzdWJqZWN0OiAnSW1wb3J0IGZhaWxlZCdcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludGVybmFsIHNlcnZlciBlcnJvcjogJyArIGVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICB9KTtcblxuICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsICYmIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIpIHtcbiAgICAgIHByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoeyByZXNwb25zZTogJ1dlIGFyZSBpbXBvcnRpbmcgeW91ciBkYXRhLiBZb3Ugd2lsbCBiZSBub3RpZmllZCBieSBlLW1haWwgb25jZSBpdCBpcyBjb21wbGV0ZWQuJyB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfVxuXG4gIHdyYXBQcm9taXNlUmVxdWVzdChyZXEsIHJlcywgaGFuZGxlcikge1xuICAgIHJldHVybiBoYW5kbGVyKHJlcSlcbiAgICAgIC50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgIHJlcy5qc29uKGRhdGEpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHsgbWVzc2FnZTogZXJyLm1lc3NhZ2UgfSk7XG4gICAgICB9KVxuICB9XG5cbiAgZXhwcmVzc1JvdXRlcigpIHtcbiAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIGNvbnN0IHVwbG9hZCA9IG11bHRlcigpO1xuXG4gICAgcm91dGVyLnBvc3QoJy9pbXBvcnRfZGF0YS86Y2xhc3NOYW1lJyxcbiAgICAgIHVwbG9hZC5zaW5nbGUoJ2ltcG9ydEZpbGUnKSxcbiAgICAgIG1pZGRsZXdhcmVzLmFsbG93Q3Jvc3NEb21haW4sXG4gICAgICBtaWRkbGV3YXJlcy5oYW5kbGVQYXJzZUhlYWRlcnMsXG4gICAgICBtaWRkbGV3YXJlcy5lbmZvcmNlTWFzdGVyS2V5QWNjZXNzLFxuICAgICAgKHJlcSwgcmVzKSA9PiB0aGlzLndyYXBQcm9taXNlUmVxdWVzdChyZXEsIHJlcywgdGhpcy5oYW5kbGVJbXBvcnQuYmluZCh0aGlzKSlcbiAgICApO1xuXG4gICAgcm91dGVyLnBvc3QoJy9pbXBvcnRfcmVsYXRpb25fZGF0YS86Y2xhc3NOYW1lLzpyZWxhdGlvbk5hbWUnLFxuICAgICAgdXBsb2FkLnNpbmdsZSgnaW1wb3J0RmlsZScpLFxuICAgICAgbWlkZGxld2FyZXMuYWxsb3dDcm9zc0RvbWFpbixcbiAgICAgIG1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIG1pZGRsZXdhcmVzLmVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsXG4gICAgICAocmVxLCByZXMpID0+IHRoaXMud3JhcFByb21pc2VSZXF1ZXN0KHJlcSwgcmVzLCB0aGlzLmhhbmRsZUltcG9ydC5iaW5kKHRoaXMpKVxuICAgICk7XG5cbiAgICByZXR1cm4gcm91dGVyO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEltcG9ydFJvdXRlcjtcbiJdfQ==