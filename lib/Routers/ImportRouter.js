'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ImportRouter = undefined;

var _express = require('express');

var _express2 = _interopRequireDefault(_express);

var _AdapterLoader = require('../Adapters/AdapterLoader');

var _middlewares = require('../middlewares');

var middlewares = _interopRequireWildcard(_middlewares);

var _multer = require('multer');

var _multer2 = _interopRequireDefault(_multer);

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

var _node = require('parse/node');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ImportRouter {

  getOneSchema(req) {

    const className = req.params.className;

    return req.config.database.loadSchema({ clearCache: true }).then(schemaController => schemaController.getOneSchema(className)).catch(error => {
      if (error === undefined) {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`));
      } else {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.'));
      }
    });
  }

  importRestObject(req, restObject, targetClass) {
    if (targetClass) {
      return _rest2.default.update(req.config, req.auth, req.params.className, { objectId: restObject.owningId }, {
        [req.params.relationName]: {
          "__op": "AddRelation",
          "objects": [{ "__type": "Pointer", "className": targetClass, "objectId": restObject.relatedId }]
        }
      }, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return Promise.reject(new _node.Parse.Error(_node.Parse.Error.OBJECT_NOT_FOUND, 'Object not found'));
        } else {
          return Promise.reject(error);
        }
      });
    }

    if (restObject.createdAt) {
      delete restObject.createdAt;
    }

    if (restObject.updatedAt) {
      delete restObject.updatedAt;
    }

    if (restObject.objectId) {
      return _rest2.default.update(req.config, req.auth, req.params.className, { objectId: restObject.objectId }, restObject, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return _rest2.default.create(req.config, req.auth, req.params.className, restObject, req.info.clientSDK, { allowObjectId: true });
        } else {
          return Promise.reject(error);
        }
      });
    }

    return _rest2.default.create(req.config, req.auth, req.params.className, restObject);
  }

  getRestObjects(req) {
    return new Promise(resolve => {

      let restObjects = [];
      let importFile;

      try {
        importFile = JSON.parse(req.file.buffer.toString());
      } catch (e) {
        throw new Error('Failed to parse JSON based on the file sent');
      }

      if (Array.isArray(importFile)) {
        restObjects = importFile;
      } else if (Array.isArray(importFile.results)) {
        restObjects = importFile.results;
      } else if (Array.isArray(importFile.rows)) {
        restObjects = importFile.rows;
      }

      if (!restObjects) {
        throw new Error('No data to import');
      }

      if (req.body.feedbackEmail) {
        if (!req.config.emailAdapter) {
          throw new Error('You have to setup a Mail Adapter.');
        }
      }

      resolve(restObjects);
    });
  }

  handleImport(req) {

    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);

    let promise = null;

    if (req.params.relationName) {
      promise = this.getOneSchema(req).then(response => {
        if (!response.fields.hasOwnProperty(req.params.relationName)) {
          throw new Error(`Relation ${req.params.relationName} does not exist in ${req.params.className}.`);
        } else if (response.fields[req.params.relationName].type !== 'Relation') {
          throw new Error(`Class ${response.fields[req.params.relationName].targetClass} does not have Relation type.`);
        }

        const targetClass = response.fields[req.params.relationName].targetClass;

        return Promise.all([this.getRestObjects(req), targetClass]);
      });
    } else {
      promise = Promise.all([this.getRestObjects(req)]);
    }

    promise = promise.then(([restObjects, targetClass]) => {

      return restObjects.reduce((item, object, index) => {

        item.pageArray.push(this.importRestObject.bind(this, req, object, targetClass));

        if (index && index % 100 === 0 || index === restObjects.length - 1) {

          const pageArray = item.pageArray.slice(0);
          item.pageArray = [];

          item.mainPromise = item.mainPromise.then(results => {
            return Promise.all(results.concat(pageArray.map(func => func())));
          });
        }

        return item;
      }, { pageArray: [], mainPromise: Promise.resolve([]) }).mainPromise;
    }).then(results => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We have successfully imported your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}.`,
          to: req.body.feedbackEmail,
          subject: 'Import completed'
        });
      } else {
        return Promise.resolve({ response: results });
      }
    }).catch(error => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We could not import your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}. Error: ${error}`,
          to: req.body.feedbackEmail,
          subject: 'Import failed'
        });
      } else {
        throw new Error('Internal server error: ' + error);
      }
    });

    if (req.body.feedbackEmail && emailControllerAdapter) {
      promise = Promise.resolve({ response: 'We are importing your data. You will be notified by e-mail once it is completed.' });
    }

    return promise;
  }

  wrapPromiseRequest(req, res, handler) {
    return handler(req).then(data => {
      res.json(data);
    }).catch(err => {
      res.status(400).send({ message: err.message });
    });
  }

  expressRouter() {
    const router = _express2.default.Router();
    const upload = (0, _multer2.default)();

    router.post('/import_data/:className', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));

    router.post('/import_relation_data/:className/:relationName', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));

    return router;
  }
}

exports.ImportRouter = ImportRouter;
exports.default = ImportRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ltcG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJtaWRkbGV3YXJlcyIsIkltcG9ydFJvdXRlciIsImdldE9uZVNjaGVtYSIsInJlcSIsImNsYXNzTmFtZSIsInBhcmFtcyIsImNvbmZpZyIsImRhdGFiYXNlIiwibG9hZFNjaGVtYSIsImNsZWFyQ2FjaGUiLCJ0aGVuIiwic2NoZW1hQ29udHJvbGxlciIsImNhdGNoIiwiZXJyb3IiLCJ1bmRlZmluZWQiLCJQcm9taXNlIiwicmVqZWN0IiwiUGFyc2UiLCJFcnJvciIsIklOVkFMSURfQ0xBU1NfTkFNRSIsIklOVEVSTkFMX1NFUlZFUl9FUlJPUiIsImltcG9ydFJlc3RPYmplY3QiLCJyZXN0T2JqZWN0IiwidGFyZ2V0Q2xhc3MiLCJyZXN0IiwidXBkYXRlIiwiYXV0aCIsIm9iamVjdElkIiwib3duaW5nSWQiLCJyZWxhdGlvbk5hbWUiLCJyZWxhdGVkSWQiLCJpbmZvIiwiY2xpZW50U0RLIiwiY29kZSIsIk9CSkVDVF9OT1RfRk9VTkQiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJjcmVhdGUiLCJhbGxvd09iamVjdElkIiwiZ2V0UmVzdE9iamVjdHMiLCJyZXNvbHZlIiwicmVzdE9iamVjdHMiLCJpbXBvcnRGaWxlIiwiSlNPTiIsInBhcnNlIiwiZmlsZSIsImJ1ZmZlciIsInRvU3RyaW5nIiwiZSIsIkFycmF5IiwiaXNBcnJheSIsInJlc3VsdHMiLCJyb3dzIiwiYm9keSIsImZlZWRiYWNrRW1haWwiLCJlbWFpbEFkYXB0ZXIiLCJoYW5kbGVJbXBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwicHJvbWlzZSIsInJlc3BvbnNlIiwiZmllbGRzIiwiaGFzT3duUHJvcGVydHkiLCJ0eXBlIiwiYWxsIiwicmVkdWNlIiwiaXRlbSIsIm9iamVjdCIsImluZGV4IiwicGFnZUFycmF5IiwicHVzaCIsImJpbmQiLCJsZW5ndGgiLCJzbGljZSIsIm1haW5Qcm9taXNlIiwiY29uY2F0IiwibWFwIiwiZnVuYyIsInNlbmRNYWlsIiwidGV4dCIsInRvIiwic3ViamVjdCIsIndyYXBQcm9taXNlUmVxdWVzdCIsInJlcyIsImhhbmRsZXIiLCJkYXRhIiwianNvbiIsImVyciIsInN0YXR1cyIsInNlbmQiLCJtZXNzYWdlIiwiZXhwcmVzc1JvdXRlciIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWQiLCJwb3N0Iiwic2luZ2xlIiwiYWxsb3dDcm9zc0RvbWFpbiIsImhhbmRsZVBhcnNlSGVhZGVycyIsImVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOztJQUFZQSxXOztBQUNaOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRU8sTUFBTUMsWUFBTixDQUFtQjs7QUFFeEJDLGVBQWFDLEdBQWIsRUFBa0I7O0FBRWhCLFVBQU1DLFlBQVlELElBQUlFLE1BQUosQ0FBV0QsU0FBN0I7O0FBRUEsV0FBT0QsSUFBSUcsTUFBSixDQUFXQyxRQUFYLENBQW9CQyxVQUFwQixDQUErQixFQUFDQyxZQUFZLElBQWIsRUFBL0IsRUFDSkMsSUFESSxDQUNDQyxvQkFBb0JBLGlCQUFpQlQsWUFBakIsQ0FBOEJFLFNBQTlCLENBRHJCLEVBRUpRLEtBRkksQ0FFRUMsU0FBUztBQUNkLFVBQUlBLFVBQVVDLFNBQWQsRUFBeUI7QUFDdkIsZUFBT0MsUUFBUUMsTUFBUixDQUFlLElBQUlDLFlBQU1DLEtBQVYsQ0FBZ0JELFlBQU1DLEtBQU4sQ0FBWUMsa0JBQTVCLEVBQ25CLFNBQVFmLFNBQVUsa0JBREMsQ0FBZixDQUFQO0FBRUQsT0FIRCxNQUdPO0FBQ0wsZUFBT1csUUFBUUMsTUFBUixDQUFlLElBQUlDLFlBQU1DLEtBQVYsQ0FBZ0JELFlBQU1DLEtBQU4sQ0FBWUUscUJBQTVCLEVBQ3BCLHlCQURvQixDQUFmLENBQVA7QUFFRDtBQUNGLEtBVkksQ0FBUDtBQVdEOztBQUVEQyxtQkFBaUJsQixHQUFqQixFQUFzQm1CLFVBQXRCLEVB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QUdFakcsWUFBWWtHLGtCQUhkLEVBSUVsRyxZQUFZbUcsc0JBSmQsRUFLRSxDQUFDaEcsR0FBRCxFQUFNK0UsR0FBTixLQUFjLEtBQUtELGtCQUFMLENBQXdCOUUsR0FBeEIsRUFBNkIrRSxHQUE3QixFQUFrQyxLQUFLMUIsWUFBTCxDQUFrQmMsSUFBbEIsQ0FBdUIsSUFBdkIsQ0FBbEMsQ0FMaEI7O0FBUUEsV0FBT3FCLE1BQVA7QUFDRDtBQWhOdUI7O1FBQWIxRixZLEdBQUFBLFk7a0JBbU5FQSxZIiwiZmlsZSI6IkltcG9ydFJvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzICAgICAgICAgIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgbG9hZEFkYXB0ZXIgfSBmcm9tICcuLi9BZGFwdGVycy9BZGFwdGVyTG9hZGVyJztcbmltcG9ydCAqIGFzIG1pZGRsZXdhcmVzIGZyb20gJy4uL21pZGRsZXdhcmVzJztcbmltcG9ydCBtdWx0ZXIgICAgICAgICAgIGZyb20gJ211bHRlcic7XG5pbXBvcnQgcmVzdCAgICAgICAgICAgICBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IFBhcnNlIH0gICAgICAgIGZyb20gJ3BhcnNlL25vZGUnO1xuXG5leHBvcnQgY2xhc3MgSW1wb3J0Um91dGVyIHtcblxuICBnZXRPbmVTY2hlbWEocmVxKSB7XG5cbiAgICBjb25zdCBjbGFzc05hbWUgPSByZXEucGFyYW1zLmNsYXNzTmFtZTtcblxuICAgIHJldHVybiByZXEuY29uZmlnLmRhdGFiYXNlLmxvYWRTY2hlbWEoe2NsZWFyQ2FjaGU6IHRydWV9KVxuICAgICAgLnRoZW4oc2NoZW1hQ29udHJvbGxlciA9PiBzY2hlbWFDb250cm9sbGVyLmdldE9uZVNjaGVtYShjbGFzc05hbWUpKVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgaWYgKGVycm9yID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfQ0xBU1NfTkFNRSxcbiAgICAgICAgICAgIGBDbGFzcyAke2NsYXNzTmFtZX0gZG9lcyBub3QgZXhpc3QuYCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgICAgICAgJ0RhdGFiYXNlIGFkYXB0ZXIgZXJyb3IuJykpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIGltcG9ydFJlc3RPYmplY3QocmVxLCByZXN0T2JqZWN0LCB0YXJnZXRDbGFzcykge1xuICAgIGlmICh0YXJnZXRDbGFzcykge1xuICAgICAgcmV0dXJuIHJlc3QudXBkYXRlKHJlcS5jb25maWcsIHJlcS5hdXRoLCByZXEucGFyYW1zLmNsYXNzTmFtZSwge29iamVjdElkOiByZXN0T2JqZWN0Lm93bmluZ0lkfSwge1xuICAgICAgICBbcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVdOiB7XG4gICAgICAgICAgXCJfX29wXCI6IFwiQWRkUmVsYXRpb25cIixcbiAgICAgICAgICBcIm9iamVjdHNcIjogW3tcIl9fdHlwZVwiOiBcIlBvaW50ZXJcIiwgXCJjbGFzc05hbWVcIjogdGFyZ2V0Q2xhc3MsIFwib2JqZWN0SWRcIjogcmVzdE9iamVjdC5yZWxhdGVkSWR9XVxuICAgICAgICB9XG4gICAgICB9LCByZXEuaW5mby5jbGllbnRTREspXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELCAnT2JqZWN0IG5vdCBmb3VuZCcpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0LmNyZWF0ZWRBdCkge1xuICAgICAgZGVsZXRlIHJlc3RPYmplY3QuY3JlYXRlZEF0O1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0LnVwZGF0ZWRBdCkge1xuICAgICAgZGVsZXRlIHJlc3RPYmplY3QudXBkYXRlZEF0O1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0Lm9iamVjdElkKSB7XG4gICAgICByZXR1cm4gcmVzdFxuICAgICAgICAudXBkYXRlKHJlcS5jb25maWcsIHJlcS5hdXRoLCByZXEucGFyYW1zLmNsYXNzTmFtZSwge29iamVjdElkOiByZXN0T2JqZWN0Lm9iamVjdElkfSwgcmVzdE9iamVjdCwgcmVxLmluZm8uY2xpZW50U0RLKVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09IFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQpIHtcbiAgICAgICAgICAgIHJldHVybiByZXN0LmNyZWF0ZShcbiAgICAgICAgICAgICAgcmVxLmNvbmZpZyxcbiAgICAgICAgICAgICAgcmVxLmF1dGgsXG4gICAgICAgICAgICAgIHJlcS5wYXJhbXMuY2xhc3NOYW1lLFxuICAgICAgICAgICAgICByZXN0T2JqZWN0LFxuICAgICAgICAgICAgICByZXEuaW5mby5jbGllbnRTREssXG4gICAgICAgICAgICAgIHthbGxvd09iamVjdElkOiB0cnVlfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3QuY3JlYXRlKHJlcS5jb25maWcsIHJlcS5hdXRoLCByZXEucGFyYW1zLmNsYXNzTmFtZSwgcmVzdE9iamVjdCk7XG4gIH1cblxuICBnZXRSZXN0T2JqZWN0cyhyZXEpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblxuICAgICAgbGV0IHJlc3RPYmplY3RzID0gW107XG4gICAgICBsZXQgaW1wb3J0RmlsZTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgaW1wb3J0RmlsZSA9IEpTT04ucGFyc2UocmVxLmZpbGUuYnVmZmVyLnRvU3RyaW5nKCkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBwYXJzZSBKU09OIGJhc2VkIG9uIHRoZSBmaWxlIHNlbnQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaW1wb3J0RmlsZSkpIHtcbiAgICAgICAgcmVzdE9iamVjdHMgPSBpbXBvcnRGaWxlO1xuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGltcG9ydEZpbGUucmVzdWx0cykpIHtcbiAgICAgICAgcmVzdE9iamVjdHMgPSBpbXBvcnRGaWxlLnJlc3VsdHM7XG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaW1wb3J0RmlsZS5yb3dzKSkge1xuICAgICAgICByZXN0T2JqZWN0cyA9IGltcG9ydEZpbGUucm93cztcbiAgICAgIH1cblxuICAgICAgaWYgKCFyZXN0T2JqZWN0cykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGRhdGEgdG8gaW1wb3J0Jyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsKSB7XG4gICAgICAgIGlmICghcmVxLmNvbmZpZy5lbWFpbEFkYXB0ZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBoYXZlIHRvIHNldHVwIGEgTWFpbCBBZGFwdGVyLicpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJlc29sdmUocmVzdE9iamVjdHMpO1xuICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlSW1wb3J0KHJlcSkge1xuXG4gICAgY29uc3QgZW1haWxDb250cm9sbGVyQWRhcHRlciA9IGxvYWRBZGFwdGVyKHJlcS5jb25maWcuZW1haWxBZGFwdGVyKTtcblxuICAgIGxldCBwcm9taXNlID0gbnVsbDtcblxuICAgIGlmIChyZXEucGFyYW1zLnJlbGF0aW9uTmFtZSkge1xuICAgICAgcHJvbWlzZSA9IHRoaXMuZ2V0T25lU2NoZW1hKHJlcSlcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgaWYgKCFyZXNwb25zZS5maWVsZHMuaGFzT3duUHJvcGVydHkocmVxLnBhcmFtcy5yZWxhdGlvbk5hbWUpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlbGF0aW9uICR7cmVxLnBhcmFtcy5yZWxhdGlvbk5hbWV9IGRvZXMgbm90IGV4aXN0IGluICR7cmVxLnBhcmFtcy5jbGFzc05hbWV9LmApO1xuICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZmllbGRzW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXS50eXBlICE9PSAnUmVsYXRpb24nKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENsYXNzICR7cmVzcG9uc2UuZmllbGRzW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXS50YXJnZXRDbGFzc30gZG9lcyBub3QgaGF2ZSBSZWxhdGlvbiB0eXBlLmApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHRhcmdldENsYXNzID0gcmVzcG9uc2UuZmllbGRzW3JlcS5wYXJhbXMucmVsYXRpb25OYW1lXS50YXJnZXRDbGFzcztcblxuICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbdGhpcy5nZXRSZXN0T2JqZWN0cyhyZXEpLCB0YXJnZXRDbGFzc10pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBwcm9taXNlID0gUHJvbWlzZS5hbGwoW3RoaXMuZ2V0UmVzdE9iamVjdHMocmVxKV0pO1xuICAgIH1cblxuICAgIHByb21pc2UgPSBwcm9taXNlXG4gICAgICAudGhlbigoW3Jlc3RPYmplY3RzLCB0YXJnZXRDbGFzc10pID0+IHtcblxuICAgICAgICByZXR1cm4gcmVzdE9iamVjdHMucmVkdWNlKChpdGVtLCBvYmplY3QsIGluZGV4KSA9PiB7XG5cbiAgICAgICAgICBpdGVtLnBhZ2VBcnJheS5wdXNoKHRoaXMuaW1wb3J0UmVzdE9iamVjdC5iaW5kKHRoaXMsIHJlcSwgb2JqZWN0LCB0YXJnZXRDbGFzcykpO1xuXG4gICAgICAgICAgaWYgKGluZGV4ICYmIGluZGV4ICUgMTAwID09PSAwIHx8IGluZGV4ID09PSAocmVzdE9iamVjdHMubGVuZ3RoIC0gMSkpIHtcblxuICAgICAgICAgICAgY29uc3QgcGFnZUFycmF5ID0gaXRlbS5wYWdlQXJyYXkuc2xpY2UoMCk7XG4gICAgICAgICAgICBpdGVtLnBhZ2VBcnJheSA9IFtdO1xuXG4gICAgICAgICAgICBpdGVtLm1haW5Qcm9taXNlID0gaXRlbS5tYWluUHJvbWlzZVxuICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChyZXN1bHRzLmNvbmNhdChwYWdlQXJyYXkubWFwKGZ1bmMgPT4gZnVuYygpKSkpO1xuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICB9LCB7IHBhZ2VBcnJheTogW10sIG1haW5Qcm9taXNlIDogUHJvbWlzZS5yZXNvbHZlKFtdKSB9KS5tYWluUHJvbWlzZTtcbiAgICAgIH0pXG4gICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICBpZiAocmVxLmJvZHkuZmVlZGJhY2tFbWFpbCkge1xuICAgICAgICAgIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgICAgdGV4dDogYFdlIGhhdmUgc3VjY2Vzc2Z1bGx5IGltcG9ydGVkIHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtyZXEucGFyYW1zLmNsYXNzTmFtZX0ke3JlcS5wYXJhbXMucmVsYXRpb25OYW1lID8gJywgcmVsYXRpb24gJyArIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lIDogJycgfS5gLFxuICAgICAgICAgICAgdG86IHJlcS5ib2R5LmZlZWRiYWNrRW1haWwsXG4gICAgICAgICAgICBzdWJqZWN0OiAnSW1wb3J0IGNvbXBsZXRlZCdcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzcG9uc2U6IHJlc3VsdHMgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsKSB7XG4gICAgICAgICAgZW1haWxDb250cm9sbGVyQWRhcHRlci5zZW5kTWFpbCh7XG4gICAgICAgICAgICB0ZXh0OiBgV2UgY291bGQgbm90IGltcG9ydCB5b3VyIGRhdGEgdG8gdGhlIGNsYXNzICR7cmVxLnBhcmFtcy5jbGFzc05hbWV9JHtyZXEucGFyYW1zLnJlbGF0aW9uTmFtZSA/ICcsIHJlbGF0aW9uICcgKyByZXEucGFyYW1zLnJlbGF0aW9uTmFtZSA6ICcnIH0uIEVycm9yOiAke2Vycm9yfWAsXG4gICAgICAgICAgICB0bzogcmVxLmJvZHkuZmVlZGJhY2tFbWFpbCxcbiAgICAgICAgICAgIHN1YmplY3Q6ICdJbXBvcnQgZmFpbGVkJ1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW50ZXJuYWwgc2VydmVyIGVycm9yOiAnICsgZXJyb3IpO1xuICAgICAgICB9XG5cbiAgICAgIH0pO1xuXG4gICAgaWYgKHJlcS5ib2R5LmZlZWRiYWNrRW1haWwgJiYgZW1haWxDb250cm9sbGVyQWRhcHRlcikge1xuICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSh7IHJlc3BvbnNlOiAnV2UgYXJlIGltcG9ydGluZyB5b3VyIGRhdGEuIFlvdSB3aWxsIGJlIG5vdGlmaWVkIGJ5IGUtbWFpbCBvbmNlIGl0IGlzIGNvbXBsZXRlZC4nIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG5cbiAgd3JhcFByb21pc2VSZXF1ZXN0KHJlcSwgcmVzLCBoYW5kbGVyKSB7XG4gICAgcmV0dXJuIGhhbmRsZXIocmVxKVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgcmVzLmpzb24oZGF0YSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLnNlbmQoeyBtZXNzYWdlOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgIH0pXG4gIH1cblxuICBleHByZXNzUm91dGVyKCkge1xuICAgIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG4gICAgY29uc3QgdXBsb2FkID0gbXVsdGVyKCk7XG5cbiAgICByb3V0ZXIucG9zdCgnL2ltcG9ydF9kYXRhLzpjbGFzc05hbWUnLFxuICAgICAgdXBsb2FkLnNpbmdsZSgnaW1wb3J0RmlsZScpLFxuICAgICAgbWlkZGxld2FyZXMuYWxsb3dDcm9zc0RvbWFpbixcbiAgICAgIG1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIG1pZGRsZXdhcmVzLmVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsXG4gICAgICAocmVxLCByZXMpID0+IHRoaXMud3JhcFByb21pc2VSZXF1ZXN0KHJlcSwgcmVzLCB0aGlzLmhhbmRsZUltcG9ydC5iaW5kKHRoaXMpKVxuICAgICk7XG5cbiAgICByb3V0ZXIucG9zdCgnL2ltcG9ydF9yZWxhdGlvbl9kYXRhLzpjbGFzc05hbWUvOnJlbGF0aW9uTmFtZScsXG4gICAgICB1cGxvYWQuc2luZ2xlKCdpbXBvcnRGaWxlJyksXG4gICAgICBtaWRkbGV3YXJlcy5hbGxvd0Nyb3NzRG9tYWluLFxuICAgICAgbWlkZGxld2FyZXMuaGFuZGxlUGFyc2VIZWFkZXJzLFxuICAgICAgbWlkZGxld2FyZXMuZW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgICAgIChyZXEsIHJlcykgPT4gdGhpcy53cmFwUHJvbWlzZVJlcXVlc3QocmVxLCByZXMsIHRoaXMuaGFuZGxlSW1wb3J0LmJpbmQodGhpcykpXG4gICAgKTtcblxuICAgIHJldHVybiByb3V0ZXI7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSW1wb3J0Um91dGVyO1xuIl19