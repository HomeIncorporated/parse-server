"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ImportRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var middlewares = _interopRequireWildcard(require("../middlewares"));

var _multer = _interopRequireDefault(require("multer"));

var _rest = _interopRequireDefault(require("../rest"));

var _node = require("parse/node");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class ImportRouter {
  getOneSchema(req) {
    const className = req.params.className;
    return req.config.database.loadSchema({
      clearCache: true
    }).then(schemaController => schemaController.getOneSchema(className)).catch(error => {
      if (error === undefined) {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`));
      } else {
        return Promise.reject(new _node.Parse.Error(_node.Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.'));
      }
    });
  }

  importRestObject(req, restObject, targetClass) {
    if (targetClass) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.owningId
      }, {
        [req.params.relationName]: {
          __op: 'AddRelation',
          objects: [{
            __type: 'Pointer',
            className: targetClass,
            objectId: restObject.relatedId
          }]
        }
      }, undefined, req.info.clientSDK, {
        allowObjectId: true
      }).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return Promise.reject(new _node.Parse.Error(_node.Parse.Error.OBJECT_NOT_FOUND, 'Object not found'));
        } else {
          return Promise.reject(error);
        }
      });
    }

    if (restObject.createdAt) {
      delete restObject.createdAt;
    }

    if (restObject.updatedAt) {
      delete restObject.updatedAt;
    }

    if (restObject.objectId) {
      return _rest.default.update(req.config, req.auth, req.params.className, {
        objectId: restObject.objectId
      }, restObject, undefined, req.info.clientSDK).catch(function (error) {
        if (error.code === _node.Parse.Error.OBJECT_NOT_FOUND) {
          return _rest.default.create(req.config, req.auth, req.params.className, restObject, undefined, req.info.clientSDK, {
            allowObjectId: true
          });
        } else {
          return Promise.reject(error);
        }
      });
    }

    return _rest.default.create(req.config, req.auth, req.params.className, restObject);
  }

  getRestObjects(req) {
    return new Promise(resolve => {
      let restObjects = [];
      let importFile;

      try {
        importFile = JSON.parse(req.file.buffer.toString());
      } catch (e) {
        throw new Error('Failed to parse JSON based on the file sent');
      }

      if (Array.isArray(importFile)) {
        restObjects = importFile;
      } else if (Array.isArray(importFile.results)) {
        restObjects = importFile.results;
      } else if (Array.isArray(importFile.rows)) {
        restObjects = importFile.rows;
      }

      if (!restObjects) {
        throw new Error('No data to import');
      }

      if (req.body.feedbackEmail) {
        if (!req.config.emailAdapter) {
          throw new Error('You have to setup a Mail Adapter.');
        }
      }

      resolve(restObjects);
    });
  }

  handleImport(req) {
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);
    let promise = null;

    if (req.params.relationName) {
      promise = this.getOneSchema(req).then(response => {
        if (!response.fields.hasOwnProperty(req.params.relationName)) {
          throw new Error(`Relation ${req.params.relationName} does not exist in ${req.params.className}.`);
        } else if (response.fields[req.params.relationName].type !== 'Relation') {
          throw new Error(`Class ${response.fields[req.params.relationName].targetClass} does not have Relation type.`);
        }

        const targetClass = response.fields[req.params.relationName].targetClass;
        return Promise.all([this.getRestObjects(req), targetClass]);
      });
    } else {
      promise = Promise.all([this.getRestObjects(req)]);
    }

    promise = promise.then(([restObjects, targetClass]) => {
      return restObjects.reduce((item, object, index) => {
        item.pageArray.push(this.importRestObject.bind(this, req, object, targetClass));

        if (index && index % 100 === 0 || index === restObjects.length - 1) {
          const pageArray = item.pageArray.slice(0);
          item.pageArray = [];
          item.mainPromise = item.mainPromise.then(results => {
            return Promise.all(results.concat(pageArray.map(func => func())));
          });
        }

        return item;
      }, {
        pageArray: [],
        mainPromise: Promise.resolve([])
      }).mainPromise;
    }).then(results => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We have successfully imported your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}.`,
          to: req.body.feedbackEmail,
          subject: 'Import completed'
        });
      } else {
        return Promise.resolve({
          response: results
        });
      }
    }).catch(error => {
      if (req.body.feedbackEmail) {
        emailControllerAdapter.sendMail({
          text: `We could not import your data to the class ${req.params.className}${req.params.relationName ? ', relation ' + req.params.relationName : ''}. Error: ${error}`,
          to: req.body.feedbackEmail,
          subject: 'Import failed'
        });
      } else {
        throw new Error('Internal server error: ' + error);
      }
    });

    if (req.body.feedbackEmail && emailControllerAdapter) {
      promise = Promise.resolve({
        response: 'We are importing your data. You will be notified by e-mail once it is completed.'
      });
    }

    return promise;
  }

  wrapPromiseRequest(req, res, handler) {
    return handler(req).then(data => {
      res.json(data);
    }).catch(err => {
      res.status(400).send({
        message: err.message
      });
    });
  }

  expressRouter() {
    const router = _express.default.Router();

    const upload = (0, _multer.default)();
    router.post('/import_data/:className', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    router.post('/import_relation_data/:className/:relationName', upload.single('importFile'), middlewares.allowCrossDomain, middlewares.handleParseHeaders, middlewares.enforceMasterKeyAccess, (req, res) => this.wrapPromiseRequest(req, res, this.handleImport.bind(this)));
    return router;
  }

}

exports.ImportRouter = ImportRouter;
var _default = ImportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ltcG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJJbXBvcnRSb3V0ZXIiLCJnZXRPbmVTY2hlbWEiLCJyZXEiLCJjbGFzc05hbWUiLCJwYXJhbXMiLCJjb25maWciLCJkYXRhYmFzZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwidGhlbiIsInNjaGVtYUNvbnRyb2xsZXIiLCJjYXRjaCIsImVycm9yIiwidW5kZWZpbmVkIiwiUHJvbWlzZSIsInJlamVjdCIsIlBhcnNlIiwiRXJyb3IiLCJJTlZBTElEX0NMQVNTX05BTUUiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiLCJpbXBvcnRSZXN0T2JqZWN0IiwicmVzdE9iamVjdCIsInRhcmdldENsYXNzIiwicmVzdCIsInVwZGF0ZSIsImF1dGgiLCJvYmplY3RJZCIsIm93bmluZ0lkIiwicmVsYXRpb25OYW1lIiwiX19vcCIsIm9iamVjdHMiLCJfX3R5cGUiLCJyZWxhdGVkSWQiLCJpbmZvIiwiY2xpZW50U0RLIiwiYWxsb3dPYmplY3RJZCIsImNvZGUiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwiY3JlYXRlZEF0IiwidXBkYXRlZEF0IiwiY3JlYXRlIiwiZ2V0UmVzdE9iamVjdHMiLCJyZXNvbHZlIiwicmVzdE9iamVjdHMiLCJpbXBvcnRGaWxlIiwiSlNPTiIsInBhcnNlIiwiZmlsZSIsImJ1ZmZlciIsInRvU3RyaW5nIiwiZSIsIkFycmF5IiwiaXNBcnJheSIsInJlc3VsdHMiLCJyb3dzIiwiYm9keSIsImZlZWRiYWNrRW1haWwiLCJlbWFpbEFkYXB0ZXIiLCJoYW5kbGVJbXBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwicHJvbWlzZSIsInJlc3BvbnNlIiwiZmllbGRzIiwiaGFzT3duUHJvcGVydHkiLCJ0eXBlIiwiYWxsIiwicmVkdWNlIiwiaXRlbSIsIm9iamVjdCIsImluZGV4IiwicGFnZUFycmF5IiwicHVzaCIsImJpbmQiLCJsZW5ndGgiLCJzbGljZSIsIm1haW5Qcm9taXNlIiwiY29uY2F0IiwibWFwIiwiZnVuYyIsInNlbmRNYWlsIiwidGV4dCIsInRvIiwic3ViamVjdCIsIndyYXBQcm9taXNlUmVxdWVzdCIsInJlcyIsImhhbmRsZXIiLCJkYXRhIiwianNvbiIsImVyciIsInN0YXR1cyIsInNlbmQiLCJtZXNzYWdlIiwiZXhwcmVzc1JvdXRlciIsInJvdXRlciIsImV4cHJlc3MiLCJSb3V0ZXIiLCJ1cGxvYWQiLCJwb3N0Iiwic2luZ2xlIiwibWlkZGxld2FyZXMiLCJhbGxvd0Nyb3NzRG9tYWluIiwiaGFuZGxlUGFyc2VIZWFkZXJzIiwiZW5mb3JjZU1hc3RlcktleUFjY2VzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFFTyxNQUFNQSxZQUFOLENBQW1CO0FBQ3hCQyxFQUFBQSxZQUFZLENBQUNDLEdBQUQsRUFBTTtBQUNoQixVQUFNQyxTQUFTLEdBQUdELEdBQUcsQ0FBQ0UsTUFBSixDQUFXRCxTQUE3QjtBQUVBLFdBQU9ELEdBQUcsQ0FBQ0csTUFBSixDQUFXQyxRQUFYLENBQ0pDLFVBREksQ0FDTztBQUFFQyxNQUFBQSxVQUFVLEVBQUU7QUFBZCxLQURQLEVBRUpDLElBRkksQ0FFQ0MsZ0JBQWdCLElBQUlBLGdCQUFnQixDQUFDVCxZQUFqQixDQUE4QkUsU0FBOUIsQ0FGckIsRUFHSlEsS0FISSxDQUdFQyxLQUFLLElBQUk7QUFDZCxVQUFJQSxLQUFLLEtBQUtDLFNBQWQsRUFBeUI7QUFDdkIsZUFBT0MsT0FBTyxDQUFDQyxNQUFSLENBQ0wsSUFBSUMsWUFBTUMsS0FBVixDQUNFRCxZQUFNQyxLQUFOLENBQVlDLGtCQURkLEVBRUcsU0FBUWYsU0FBVSxrQkFGckIsQ0FESyxDQUFQO0FBTUQsT0FQRCxNQU9PO0FBQ0wsZUFBT1csT0FBTyxDQUFDQyxNQUFSLENBQ0wsSUFBSUMsWUFBTUMsS0FBVixDQUNFRCxZQUFNQyxLQUFOLENBQVlFLHFCQURkLEVBRUUseUJBRkYsQ0FESyxDQUFQ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QUwsQ0FBa0JjLElBQWxCLENBQXVCLElBQXZCLENBQWxDLENBUEo7QUFVQXFCLElBQUFBLE1BQU0sQ0FBQ0ksSUFBUCxDQUNFLGdEQURGLEVBRUVELE1BQU0sQ0FBQ0UsTUFBUCxDQUFjLFlBQWQsQ0FGRixFQUdFQyxXQUFXLENBQUNDLGdCQUhkLEVBSUVELFdBQVcsQ0FBQ0Usa0JBSmQsRUFLRUYsV0FBVyxDQUFDRyxzQkFMZCxFQU1FLENBQUNwRyxHQUFELEVBQU1rRixHQUFOLEtBQ0UsS0FBS0Qsa0JBQUwsQ0FBd0JqRixHQUF4QixFQUE2QmtGLEdBQTdCLEVBQWtDLEtBQUsxQixZQUFMLENBQWtCYyxJQUFsQixDQUF1QixJQUF2QixDQUFsQyxDQVBKO0FBVUEsV0FBT3FCLE1BQVA7QUFDRDs7QUFoUnVCOzs7ZUFtUlg3RixZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBsb2FkQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL0FkYXB0ZXJMb2FkZXInO1xuaW1wb3J0ICogYXMgbWlkZGxld2FyZXMgZnJvbSAnLi4vbWlkZGxld2FyZXMnO1xuaW1wb3J0IG11bHRlciBmcm9tICdtdWx0ZXInO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi4vcmVzdCc7XG5pbXBvcnQgeyBQYXJzZSB9IGZyb20gJ3BhcnNlL25vZGUnO1xuXG5leHBvcnQgY2xhc3MgSW1wb3J0Um91dGVyIHtcbiAgZ2V0T25lU2NoZW1hKHJlcSkge1xuICAgIGNvbnN0IGNsYXNzTmFtZSA9IHJlcS5wYXJhbXMuY2xhc3NOYW1lO1xuXG4gICAgcmV0dXJuIHJlcS5jb25maWcuZGF0YWJhc2VcbiAgICAgIC5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZSB9KVxuICAgICAgLnRoZW4oc2NoZW1hQ29udHJvbGxlciA9PiBzY2hlbWFDb250cm9sbGVyLmdldE9uZVNjaGVtYShjbGFzc05hbWUpKVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgaWYgKGVycm9yID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXG4gICAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICAgIFBhcnNlLkVycm9yLklOVkFMSURfQ0xBU1NfTkFNRSxcbiAgICAgICAgICAgICAgYENsYXNzICR7Y2xhc3NOYW1lfSBkb2VzIG5vdCBleGlzdC5gXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoXG4gICAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICAgIFBhcnNlLkVycm9yLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICAgICAgICAgJ0RhdGFiYXNlIGFkYXB0ZXIgZXJyb3IuJ1xuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgaW1wb3J0UmVzdE9iamVjdChyZXEsIHJlc3RPYmplY3QsIHRhcmdldENsYXNzKSB7XG4gICAgaWYgKHRhcmdldENsYXNzKSB7XG4gICAgICByZXR1cm4gcmVzdFxuICAgICAgICAudXBkYXRlKFxuICAgICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgICAgcmVxLmF1dGgsXG4gICAgICAgICAgcmVxLnBhcmFtcy5jbGFzc05hbWUsXG4gICAgICAgICAgeyBvYmplY3RJZDogcmVzdE9iamVjdC5vd25pbmdJZCB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFtyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV06IHtcbiAgICAgICAgICAgICAgX19vcDogJ0FkZFJlbGF0aW9uJyxcbiAgICAgICAgICAgICAgb2JqZWN0czogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIF9fdHlwZTogJ1BvaW50ZXInLFxuICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiB0YXJnZXRDbGFzcyxcbiAgICAgICAgICAgICAgICAgIG9iamVjdElkOiByZXN0T2JqZWN0LnJlbGF0ZWRJZCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICByZXEuaW5mby5jbGllbnRTREssXG4gICAgICAgICAgeyBhbGxvd09iamVjdElkOiB0cnVlIH1cbiAgICAgICAgKVxuICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KFxuICAgICAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgJ09iamVjdCBub3QgZm91bmQnKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0LmNyZWF0ZWRBdCkge1xuICAgICAgZGVsZXRlIHJlc3RPYmplY3QuY3JlYXRlZEF0O1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0LnVwZGF0ZWRBdCkge1xuICAgICAgZGVsZXRlIHJlc3RPYmplY3QudXBkYXRlZEF0O1xuICAgIH1cblxuICAgIGlmIChyZXN0T2JqZWN0Lm9iamVjdElkKSB7XG4gICAgICByZXR1cm4gcmVzdFxuICAgICAgICAudXBkYXRlKFxuICAgICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgICAgcmVxLmF1dGgsXG4gICAgICAgICAgcmVxLnBhcmFtcy5jbGFzc05hbWUsXG4gICAgICAgICAgeyBvYmplY3RJZDogcmVzdE9iamVjdC5vYmplY3RJZCB9LFxuICAgICAgICAgIHJlc3RPYmplY3QsXG4gICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgIHJlcS5pbmZvLmNsaWVudFNES1xuICAgICAgICApXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgIGlmIChlcnJvci5jb2RlID09PSBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdC5jcmVhdGUoXG4gICAgICAgICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgICAgICAgIHJlcS5hdXRoLFxuICAgICAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgcmVzdE9iamVjdCxcbiAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICByZXEuaW5mby5jbGllbnRTREssXG4gICAgICAgICAgICAgIHsgYWxsb3dPYmplY3RJZDogdHJ1ZSB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3QuY3JlYXRlKHJlcS5jb25maWcsIHJlcS5hdXRoLCByZXEucGFyYW1zLmNsYXNzTmFtZSwgcmVzdE9iamVjdCk7XG4gIH1cblxuICBnZXRSZXN0T2JqZWN0cyhyZXEpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBsZXQgcmVzdE9iamVjdHMgPSBbXTtcbiAgICAgIGxldCBpbXBvcnRGaWxlO1xuXG4gICAgICB0cnkge1xuICAgICAgICBpbXBvcnRGaWxlID0gSlNPTi5wYXJzZShyZXEuZmlsZS5idWZmZXIudG9TdHJpbmcoKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHBhcnNlIEpTT04gYmFzZWQgb24gdGhlIGZpbGUgc2VudCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShpbXBvcnRGaWxlKSkge1xuICAgICAgICByZXN0T2JqZWN0cyA9IGltcG9ydEZpbGU7XG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaW1wb3J0RmlsZS5yZXN1bHRzKSkge1xuICAgICAgICByZXN0T2JqZWN0cyA9IGltcG9ydEZpbGUucmVzdWx0cztcbiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShpbXBvcnRGaWxlLnJvd3MpKSB7XG4gICAgICAgIHJlc3RPYmplY3RzID0gaW1wb3J0RmlsZS5yb3dzO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXJlc3RPYmplY3RzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YSB0byBpbXBvcnQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlcS5ib2R5LmZlZWRiYWNrRW1haWwpIHtcbiAgICAgICAgaWYgKCFyZXEuY29uZmlnLmVtYWlsQWRhcHRlcikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignWW91IGhhdmUgdG8gc2V0dXAgYSBNYWlsIEFkYXB0ZXIuJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmVzb2x2ZShyZXN0T2JqZWN0cyk7XG4gICAgfSk7XG4gIH1cblxuICBoYW5kbGVJbXBvcnQocmVxKSB7XG4gICAgY29uc3QgZW1haWxDb250cm9sbGVyQWRhcHRlciA9IGxvYWRBZGFwdGVyKHJlcS5jb25maWcuZW1haWxBZGFwdGVyKTtcblxuICAgIGxldCBwcm9taXNlID0gbnVsbDtcblxuICAgIGlmIChyZXEucGFyYW1zLnJlbGF0aW9uTmFtZSkge1xuICAgICAgcHJvbWlzZSA9IHRoaXMuZ2V0T25lU2NoZW1hKHJlcSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgIGlmICghcmVzcG9uc2UuZmllbGRzLmhhc093blByb3BlcnR5KHJlcS5wYXJhbXMucmVsYXRpb25OYW1lKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBSZWxhdGlvbiAke3JlcS5wYXJhbXMucmVsYXRpb25OYW1lfSBkb2VzIG5vdCBleGlzdCBpbiAke1xuICAgICAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZVxuICAgICAgICAgICAgfS5gXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICByZXNwb25zZS5maWVsZHNbcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVdLnR5cGUgIT09ICdSZWxhdGlvbidcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENsYXNzICR7XG4gICAgICAgICAgICAgIHJlc3BvbnNlLmZpZWxkc1tyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV0udGFyZ2V0Q2xhc3NcbiAgICAgICAgICAgIH0gZG9lcyBub3QgaGF2ZSBSZWxhdGlvbiB0eXBlLmBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0Q2xhc3MgPVxuICAgICAgICAgIHJlc3BvbnNlLmZpZWxkc1tyZXEucGFyYW1zLnJlbGF0aW9uTmFtZV0udGFyZ2V0Q2xhc3M7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFt0aGlzLmdldFJlc3RPYmplY3RzKHJlcSksIHRhcmdldENsYXNzXSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJvbWlzZSA9IFByb21pc2UuYWxsKFt0aGlzLmdldFJlc3RPYmplY3RzKHJlcSldKTtcbiAgICB9XG5cbiAgICBwcm9taXNlID0gcHJvbWlzZVxuICAgICAgLnRoZW4oKFtyZXN0T2JqZWN0cywgdGFyZ2V0Q2xhc3NdKSA9PiB7XG4gICAgICAgIHJldHVybiByZXN0T2JqZWN0cy5yZWR1Y2UoXG4gICAgICAgICAgKGl0ZW0sIG9iamVjdCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGl0ZW0ucGFnZUFycmF5LnB1c2goXG4gICAgICAgICAgICAgIHRoaXMuaW1wb3J0UmVzdE9iamVjdC5iaW5kKHRoaXMsIHJlcSwgb2JqZWN0LCB0YXJnZXRDbGFzcylcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgKGluZGV4ICYmIGluZGV4ICUgMTAwID09PSAwKSB8fFxuICAgICAgICAgICAgICBpbmRleCA9PT0gcmVzdE9iamVjdHMubGVuZ3RoIC0gMVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHBhZ2VBcnJheSA9IGl0ZW0ucGFnZUFycmF5LnNsaWNlKDApO1xuICAgICAgICAgICAgICBpdGVtLnBhZ2VBcnJheSA9IFtdO1xuXG4gICAgICAgICAgICAgIGl0ZW0ubWFpblByb21pc2UgPSBpdGVtLm1haW5Qcm9taXNlLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgICAgICAgICAgICAgcmVzdWx0cy5jb25jYXQocGFnZUFycmF5Lm1hcChmdW5jID0+IGZ1bmMoKSkpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgeyBwYWdlQXJyYXk6IFtdLCBtYWluUHJvbWlzZTogUHJvbWlzZS5yZXNvbHZlKFtdKSB9XG4gICAgICAgICkubWFpblByb21pc2U7XG4gICAgICB9KVxuICAgICAgLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgIGlmIChyZXEuYm9keS5mZWVkYmFja0VtYWlsKSB7XG4gICAgICAgICAgZW1haWxDb250cm9sbGVyQWRhcHRlci5zZW5kTWFpbCh7XG4gICAgICAgICAgICB0ZXh0OiBgV2UgaGF2ZSBzdWNjZXNzZnVsbHkgaW1wb3J0ZWQgeW91ciBkYXRhIHRvIHRoZSBjbGFzcyAke1xuICAgICAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZVxuICAgICAgICAgICAgfSR7XG4gICAgICAgICAgICAgIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lXG4gICAgICAgICAgICAgICAgPyAnLCByZWxhdGlvbiAnICsgcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVcbiAgICAgICAgICAgICAgICA6ICcnXG4gICAgICAgICAgICB9LmAsXG4gICAgICAgICAgICB0bzogcmVxLmJvZHkuZmVlZGJhY2tFbWFpbCxcbiAgICAgICAgICAgIHN1YmplY3Q6ICdJbXBvcnQgY29tcGxldGVkJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVzcG9uc2U6IHJlc3VsdHMgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICBpZiAocmVxLmJvZHkuZmVlZGJhY2tFbWFpbCkge1xuICAgICAgICAgIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgICAgdGV4dDogYFdlIGNvdWxkIG5vdCBpbXBvcnQgeW91ciBkYXRhIHRvIHRoZSBjbGFzcyAke1xuICAgICAgICAgICAgICByZXEucGFyYW1zLmNsYXNzTmFtZVxuICAgICAgICAgICAgfSR7XG4gICAgICAgICAgICAgIHJlcS5wYXJhbXMucmVsYXRpb25OYW1lXG4gICAgICAgICAgICAgICAgPyAnLCByZWxhdGlvbiAnICsgcmVxLnBhcmFtcy5yZWxhdGlvbk5hbWVcbiAgICAgICAgICAgICAgICA6ICcnXG4gICAgICAgICAgICB9LiBFcnJvcjogJHtlcnJvcn1gLFxuICAgICAgICAgICAgdG86IHJlcS5ib2R5LmZlZWRiYWNrRW1haWwsXG4gICAgICAgICAgICBzdWJqZWN0OiAnSW1wb3J0IGZhaWxlZCcsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3I6ICcgKyBlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgaWYgKHJlcS5ib2R5LmZlZWRiYWNrRW1haWwgJiYgZW1haWxDb250cm9sbGVyQWRhcHRlcikge1xuICAgICAgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIHJlc3BvbnNlOlxuICAgICAgICAgICdXZSBhcmUgaW1wb3J0aW5nIHlvdXIgZGF0YS4gWW91IHdpbGwgYmUgbm90aWZpZWQgYnkgZS1tYWlsIG9uY2UgaXQgaXMgY29tcGxldGVkLicsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfVxuXG4gIHdyYXBQcm9taXNlUmVxdWVzdChyZXEsIHJlcywgaGFuZGxlcikge1xuICAgIHJldHVybiBoYW5kbGVyKHJlcSlcbiAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICByZXMuanNvbihkYXRhKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmVzLnN0YXR1cyg0MDApLnNlbmQoeyBtZXNzYWdlOiBlcnIubWVzc2FnZSB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZXhwcmVzc1JvdXRlcigpIHtcbiAgICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAgIGNvbnN0IHVwbG9hZCA9IG11bHRlcigpO1xuXG4gICAgcm91dGVyLnBvc3QoXG4gICAgICAnL2ltcG9ydF9kYXRhLzpjbGFzc05hbWUnLFxuICAgICAgdXBsb2FkLnNpbmdsZSgnaW1wb3J0RmlsZScpLFxuICAgICAgbWlkZGxld2FyZXMuYWxsb3dDcm9zc0RvbWFpbixcbiAgICAgIG1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIG1pZGRsZXdhcmVzLmVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsXG4gICAgICAocmVxLCByZXMpID0+XG4gICAgICAgIHRoaXMud3JhcFByb21pc2VSZXF1ZXN0KHJlcSwgcmVzLCB0aGlzLmhhbmRsZUltcG9ydC5iaW5kKHRoaXMpKVxuICAgICk7XG5cbiAgICByb3V0ZXIucG9zdChcbiAgICAgICcvaW1wb3J0X3JlbGF0aW9uX2RhdGEvOmNsYXNzTmFtZS86cmVsYXRpb25OYW1lJyxcbiAgICAgIHVwbG9hZC5zaW5nbGUoJ2ltcG9ydEZpbGUnKSxcbiAgICAgIG1pZGRsZXdhcmVzLmFsbG93Q3Jvc3NEb21haW4sXG4gICAgICBtaWRkbGV3YXJlcy5oYW5kbGVQYXJzZUhlYWRlcnMsXG4gICAgICBtaWRkbGV3YXJlcy5lbmZvcmNlTWFzdGVyS2V5QWNjZXNzLFxuICAgICAgKHJlcSwgcmVzKSA9PlxuICAgICAgICB0aGlzLndyYXBQcm9taXNlUmVxdWVzdChyZXEsIHJlcywgdGhpcy5oYW5kbGVJbXBvcnQuYmluZCh0aGlzKSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJvdXRlcjtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBJbXBvcnRSb3V0ZXI7XG4iXX0=