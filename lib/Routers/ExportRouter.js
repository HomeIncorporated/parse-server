"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExportRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var _rest = _interopRequireDefault(require("../rest"));

var _archiver = _interopRequireDefault(require("archiver"));

var _tmp = _interopRequireDefault(require("tmp"));

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DefaultExportExportProgressCollectionName = "_ExportProgress";
const relationSchema = {
  fields: {
    relatedId: {
      type: 'String'
    },
    owningId: {
      type: 'String'
    }
  }
};

class ExportRouter extends _PromiseRouter.default {
  exportClassPage(req, name, jsonFileStream, where, skip, limit) {
    const databaseController = req.config.database;
    const options = {
      skip,
      limit
    };
    const findPromise = name.indexOf('_Join') === 0 ? databaseController.adapter.find(name, relationSchema, where, options) : _rest.default.find(req.config, req.auth, name, where, options);
    return findPromise.then(data => {
      if (Array.isArray(data)) {
        data = {
          results: data
        };
      }

      if (skip && data.results.length) {
        jsonFileStream.write(',\n');
      }

      jsonFileStream.write(JSON.stringify(data.results, null, 2).substr(1).slice(0, -1));
    });
  }

  exportClass(req, data) {
    const databaseController = req.config.database;

    const tmpJsonFile = _tmp.default.fileSync();

    const jsonFileStream = _fs.default.createWriteStream(tmpJsonFile.name);

    jsonFileStream.write('{\n"results" : [\n');
    const findPromise = data.name.indexOf('_Join') === 0 ? databaseController.adapter.count(data.name, relationSchema, data.where) : _rest.default.find(req.config, req.auth, data.name, data.where, {
      count: true,
      limit: 0
    });
    return findPromise.then(result => {
      if (Number.isInteger(result)) {
        result = {
          count: result
        };
      }

      let i = 0;
      const pageLimit = 1000;
      let promise = Promise.resolve();

      for (i = 0; i < result.count; i += pageLimit) {
        const skip = i;
        promise = promise.then(() => {
          return this.exportClassPage(req, data.name, jsonFileStream, data.where, skip, pageLimit);
        });
      }

      return promise;
    }).then(() => {
      jsonFileStream.end(']\n}');
      return new Promise(resolve => {
        jsonFileStream.on('close', () => {
          tmpJsonFile._name = `${data.name.replace(/:/g, 'êž‰')}.json`;
          resolve(tmpJsonFile);
        });
      });
    });
  }

  handleExportProgress(req) {
    const databaseController = req.config.database;
    const query = {
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    return databaseController.find(DefaultExportExportProgressCollectionName, query).then(response => {
      return {
        response
      };
    });
  }

  handleExport(req) {
    const databaseController = req.config.database;
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);

    if (!emailControllerAdapter) {
      return Promise.reject(new Error('You have to setup a Mail Adapter.'));
    }

    const exportProgress = {
      id: req.body.name,
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    databaseController.create(DefaultExportExportProgressCollectionName, exportProgress).then(() => {
      return databaseController.loadSchema({
        clearCache: true
      });
    }).then(schemaController => schemaController.getOneSchema(req.body.name, true)).then(schema => {
      const classNames = [req.body.name];
      Object.keys(schema.fields).forEach(fieldName => {
        const field = schema.fields[fieldName];

        if (field.type === 'Relation') {
          classNames.push(`_Join:${fieldName}:${req.body.name}`);
        }
      });
      const promisses = classNames.map(name => {
        return this.exportClass(req, {
          name
        });
      });
      return Promise.all(promisses);
    }).then(jsonFiles => {
      return new Promise(resolve => {
        const tmpZipFile = _tmp.default.fileSync();

        const tmpZipStream = _fs.default.createWriteStream(tmpZipFile.name);

        const zip = (0, _archiver.default)('zip');
        zip.pipe(tmpZipStream);
        jsonFiles.forEach(tmpJsonFile => {
          zip.append(_fs.default.readFileSync(tmpJsonFile.name), {
            name: tmpJsonFile._name
          });
          tmpJsonFile.removeCallback();
        });
        zip.finalize();
        tmpZipStream.on('close', () => {
          const buf = _fs.default.readFileSync(tmpZipFile.name);

          tmpZipFile.removeCallback();
          resolve(buf);
        });
      });
    }).then(zippedFile => {
      const filesController = req.config.filesController;
      return filesController.createFile(req.config, req.body.name, zippedFile, 'application/zip');
    }).then(fileData => {
      return emailControllerAdapter.sendMail({
        text: `We have successfully exported your data from the class ${req.body.name}.\n
        Please download from ${fileData.url}`,
        link: fileData.url,
        to: req.body.feedbackEmail,
        subject: 'Export completed'
      });
    }).catch(error => {
      return emailControllerAdapter.sendMail({
        text: `We could not export your data to the class ${req.body.name}. Error: ${error}`,
        to: req.body.feedbackEmail,
        subject: 'Export failed'
      });
    }).then(() => {
      return databaseController.destroy(DefaultExportExportProgressCollectionName, exportProgress);
    });
    return Promise.resolve({
      response: 'We are exporting your data. You will be notified by e-mail once it is completed.'
    });
  }

  mountRoutes() {
    this.route('PUT', '/export_data', req => {
      return this.handleExport(req);
    });
    this.route('GET', '/export_progress', req => {
      return this.handleExportProgress(req);
    });
  }

}

exports.ExportRouter = ExportRouter;
var _default = ExportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0V4cG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSIsInJlbGF0aW9uU2NoZW1hIiwiZmllbGRzIiwicmVsYXRlZElkIiwidHlwZSIsIm93bmluZ0lkIiwiRXhwb3J0Um91dGVyIiwiUHJvbWlzZVJvdXRlciIsImV4cG9ydENsYXNzUGFnZSIsInJlcSIsIm5hbWUiLCJqc29uRmlsZVN0cmVhbSIsIndoZXJlIiwic2tpcCIsImxpbWl0IiwiZGF0YWJhc2VDb250cm9sbGVyIiwiY29uZmlnIiwiZGF0YWJhc2UiLCJvcHRpb25zIiwiZmluZFByb21pc2UiLCJpbmRleE9mIiwiYWRhcHRlciIsImZpbmQiLCJyZXN0IiwiYXV0aCIsInRoZW4iLCJkYXRhIiwiQXJyYXkiLCJpc0FycmF5IiwicmVzdWx0cyIsImxlbmd0aCIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsInN1YnN0ciIsInNsaWNlIiwiZXhwb3J0Q2xhc3MiLCJ0bXBKc29uRmlsZSIsInRtcCIsImZpbGVTeW5jIiwiZnMiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImNvdW50IiwicmVzdWx0IiwiTnVtYmVyIiwiaXNJbnRlZ2VyIiwiaSIsInBhZ2VMaW1pdCIsInByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsImVuZCIsIm9uIiwiX25hbWUiLCJyZXBsYWNlIiwiaGFuZGxlRXhwb3J0UHJvZ3Jlc3MiLCJxdWVyeSIsIm1hc3RlcktleSIsImluZm8iLCJhcHBsaWNhdGlvbklkIiwiYXBwSWQiLCJyZXNwb25zZSIsImhhbmRsZUV4cG9ydCIsImVtYWlsQ29udHJvbGxlckFkYXB0ZXIiLCJlbWFpbEFkYXB0ZXIiLCJyZWplY3QiLCJFcnJvciIsImV4cG9ydFByb2dyZXNzIiwiaWQiLCJib2R5IiwiY3JlYXRlIiwibG9hZFNjaGVtYSIsImNsZWFyQ2FjaGUiLCJzY2hlbWFDb250cm9sbGVyIiwiZ2V0T25lU2NoZW1hIiwic2NoZW1hIiwiY2xhc3NOYW1lcyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiZmllbGROYW1lIiwiZmllbGQiLCJwdXNoIiwicHJvbWlzc2VzIiwibWFwIiwiYWxsIiwianNvbkZpbGVzIiwidG1wWmlwRmlsZSIsInRtcFppcFN0cmVhbSIsInppcCIsInBpcGUiLCJhcHBlbmQiLCJyZWFkRmlsZVN5bmMiLCJyZW1vdmVDYWxsYmFjayIsImZpbmFsaXplIiwiYnVmIiwiemlwcGVkRmlsZSIsImZpbGVzQ29udHJvbGxlciIsImNyZWF0ZUZpbGUiLCJmaWxlRGF0YSIsInNlbmRNYWlsIiwidGV4dCIsInVybCIsImxpbmsiLCJ0byIsImZlZWRiYWNrRW1haWwiLCJzdWJqZWN0IiwiY2F0Y2giLCJlcnJvciIsImRlc3Ryb3kiLCJtb3VudFJvdXRlcyIsInJvdXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSx5Q0FBeUMsR0FBRyxpQkFBbEQ7QUFDQSxNQUFNQyxjQUFjLEdBQUc7QUFBRUMsRUFBQUEsTUFBTSxFQUFFO0FBQUVDLElBQUFBLFNBQVMsRUFBRTtBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFiO0FBQWlDQyxJQUFBQSxRQUFRLEVBQUU7QUFBRUQsTUFBQUEsSUFBSSxFQUFFO0FBQVI7QUFBM0M7QUFBVixDQUF2Qjs7QUFFTyxNQUFNRSxZQUFOLFNBQTJCQyxzQkFBM0IsQ0FBeUM7QUFFOUNDLEVBQUFBLGVBQWUsQ0FBQ0MsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLGNBQVosRUFBNEJDLEtBQTVCLEVBQW1DQyxJQUFuQyxFQUF5Q0MsS0FBekMsRUFBZ0Q7QUFFN0QsVUFBTUMsa0JBQWtCLEdBQUdOLEdBQUcsQ0FBQ08sTUFBSixDQUFXQyxRQUF0QztBQUVBLFVBQU1DLE9BQU8sR0FBSTtBQUNmTCxNQUFBQSxJQURlO0FBRWZDLE1BQUFBO0FBRmUsS0FBakI7QUFLQSxVQUFNSyxXQUFX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YUFGd0I7QUFHckNDLFFBQUFBLE9BQU8sRUFBRTtBQUg0QixPQUFoQyxDQUFQO0FBS0QsS0FuRUgsRUFvRUdqRixJQXBFSCxDQW9FUSxNQUFNO0FBQ1YsYUFBT1Ysa0JBQWtCLENBQUM4RixPQUFuQixDQUEyQjdHLHlDQUEzQixFQUFzRW1FLGNBQXRFLENBQVA7QUFDRCxLQXRFSDtBQXdFQSxXQUFPbEIsT0FBTyxDQUFDQyxPQUFSLENBQWdCO0FBQUNXLE1BQUFBLFFBQVEsRUFBRTtBQUFYLEtBQWhCLENBQVA7QUFDRDs7QUFFRGlELEVBQUFBLFdBQVcsR0FBRztBQUNaLFNBQUtDLEtBQUwsQ0FDRSxLQURGLEVBRUUsY0FGRixFQUdHdEcsR0FBRCxJQUFTO0FBQUUsYUFBTyxLQUFLcUQsWUFBTCxDQUFrQnJELEdBQWxCLENBQVA7QUFBZ0MsS0FIN0M7QUFNQSxTQUFLc0csS0FBTCxDQUNFLEtBREYsRUFFRSxrQkFGRixFQUdHdEcsR0FBRCxJQUFTO0FBQUUsYUFBTyxLQUFLOEMsb0JBQUwsQ0FBMEI5QyxHQUExQixDQUFQO0FBQXdDLEtBSHJEO0FBTUQ7O0FBdE02Qzs7O2VBeU1qQ0gsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlUm91dGVyICAgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgeyBsb2FkQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL0FkYXB0ZXJMb2FkZXInO1xuaW1wb3J0IHJlc3QgICAgICAgICAgICBmcm9tICcuLi9yZXN0JztcbmltcG9ydCBhcmNoaXZlciAgICAgICAgZnJvbSAnYXJjaGl2ZXInO1xuaW1wb3J0IHRtcCAgICAgICAgICAgICBmcm9tICd0bXAnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcblxuY29uc3QgRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUgPSBcIl9FeHBvcnRQcm9ncmVzc1wiO1xuY29uc3QgcmVsYXRpb25TY2hlbWEgPSB7IGZpZWxkczogeyByZWxhdGVkSWQ6IHsgdHlwZTogJ1N0cmluZycgfSwgb3duaW5nSWQ6IHsgdHlwZTogJ1N0cmluZycgfSB9IH07XG5cbmV4cG9ydCBjbGFzcyBFeHBvcnRSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcblxuICBleHBvcnRDbGFzc1BhZ2UocmVxLCBuYW1lLCBqc29uRmlsZVN0cmVhbSwgd2hlcmUsIHNraXAsIGxpbWl0KSB7XG5cbiAgICBjb25zdCBkYXRhYmFzZUNvbnRyb2xsZXIgPSByZXEuY29uZmlnLmRhdGFiYXNlO1xuXG4gICAgY29uc3Qgb3B0aW9ucyA9ICB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXRcbiAgICB9O1xuXG4gICAgY29uc3QgZmluZFByb21pc2UgPSBuYW1lLmluZGV4T2YoJ19Kb2luJykgPT09IDAgP1xuICAgICAgZGF0YWJhc2VDb250cm9sbGVyLmFkYXB0ZXIuZmluZChuYW1lLCByZWxhdGlvblNjaGVtYSwgd2hlcmUsIG9wdGlvbnMpXG4gICAgICA6IHJlc3QuZmluZChyZXEuY29uZmlnLCByZXEuYXV0aCwgbmFtZSwgIHdoZXJlLCBvcHRpb25zKTtcblxuICAgIHJldHVybiBmaW5kUHJvbWlzZVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgICBkYXRhID0geyByZXN1bHRzIDogZGF0YSB9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNraXAgJiYgZGF0YS5yZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICAgIGpzb25GaWxlU3RyZWFtLndyaXRlKCcsXFxuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBqc29uRmlsZVN0cmVhbS53cml0ZShKU09OLnN0cmluZ2lmeShkYXRhLnJlc3VsdHMsIG51bGwsIDIpLnN1YnN0cigxKS5zbGljZSgwLC0xKSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGV4cG9ydENsYXNzKHJlcSwgZGF0YSkge1xuXG5cbiAgICBjb25zdCBkYXRhYmFzZUNvbnRyb2xsZXIgPSByZXEuY29uZmlnLmRhdGFiYXNlO1xuICAgIGNvbnN0IHRtcEpzb25GaWxlID0gdG1wLmZpbGVTeW5jKCk7XG4gICAgY29uc3QganNvbkZpbGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSh0bXBKc29uRmlsZS5uYW1lKTtcblxuICAgIGpzb25GaWxlU3RyZWFtLndyaXRlKCd7XFxuXCJyZXN1bHRzXCIgOiBbXFxuJyk7XG5cbiAgICBjb25zdCBmaW5kUHJvbWlzZSA9IGRhdGEubmFtZS5pbmRleE9mKCdfSm9pbicpID09PSAwID9cbiAgICAgIGRhdGFiYXNlQ29udHJvbGxlci5hZGFwdGVyLmNvdW50KGRhdGEubmFtZSwgcmVsYXRpb25TY2hlbWEsIGRhdGEud2hlcmUpXG4gICAgICA6IHJlc3QuZmluZChyZXEuY29uZmlnLCByZXEuYXV0aCwgZGF0YS5uYW1lLCAgZGF0YS53aGVyZSwgeyBjb3VudDogdHJ1ZSwgbGltaXQ6IDAgfSk7XG5cbiAgICByZXR1cm4gZmluZFByb21pc2VcbiAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcblxuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihyZXN1bHQpKSB7XG4gICAgICAgICAgcmVzdWx0ID0geyBjb3VudDogcmVzdWx0IH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGNvbnN0IHBhZ2VMaW1pdCA9IDEwMDA7XG4gICAgICAgIGxldCBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cblxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVzdWx0LmNvdW50OyBpICs9IHBhZ2VMaW1pdCkge1xuXG4gICAgICAgICAgY29uc3Qgc2tpcCA9IGk7XG4gICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRDbGFzc1BhZ2UocmVxLCBkYXRhLm5hbWUsIGpzb25GaWxlU3RyZWFtLCBkYXRhLndoZXJlLCBza2lwLCBwYWdlTGltaXQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgIGpzb25GaWxlU3RyZWFtLmVuZCgnXVxcbn0nKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblxuICAgICAgICAgIGpzb25GaWxlU3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgICAgIHRtcEpzb25GaWxlLl9uYW1lID0gYCR7ZGF0YS5uYW1lLnJlcGxhY2UoLzovZywn6p6JJyl9Lmpzb25gO1xuXG4gICAgICAgICAgICByZXNvbHZlKHRtcEpzb25GaWxlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRXhwb3J0UHJvZ3Jlc3MocmVxKSB7XG5cbiAgICBjb25zdCBkYXRhYmFzZUNvbnRyb2xsZXIgPSByZXEuY29uZmlnLmRhdGFiYXNlO1xuXG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICBtYXN0ZXJLZXk6IHJlcS5pbmZvLm1hc3RlcktleSxcbiAgICAgIGFwcGxpY2F0aW9uSWQ6IHJlcS5pbmZvLmFwcElkXG4gICAgfTtcblxuICAgIHJldHVybiBkYXRhYmFzZUNvbnRyb2xsZXIuZmluZChEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSwgcXVlcnkpXG4gICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgcmVzcG9uc2UgfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRXhwb3J0KHJlcSkge1xuXG4gICAgY29uc3QgZGF0YWJhc2VDb250cm9sbGVyID0gcmVxLmNvbmZpZy5kYXRhYmFzZTtcblxuICAgIGNvbnN0IGVtYWlsQ29udHJvbGxlckFkYXB0ZXIgPSBsb2FkQWRhcHRlcihyZXEuY29uZmlnLmVtYWlsQWRhcHRlcik7XG5cbiAgICBpZiAoIWVtYWlsQ29udHJvbGxlckFkYXB0ZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ1lvdSBoYXZlIHRvIHNldHVwIGEgTWFpbCBBZGFwdGVyLicpKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHBvcnRQcm9ncmVzcyA9IHtcbiAgICAgIGlkOiByZXEuYm9keS5uYW1lLFxuICAgICAgbWFzdGVyS2V5OiByZXEuaW5mby5tYXN0ZXJLZXksXG4gICAgICBhcHBsaWNhdGlvbklkOiByZXEuaW5mby5hcHBJZFxuICAgIH07XG5cbiAgICBkYXRhYmFzZUNvbnRyb2xsZXIuY3JlYXRlKERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLCBleHBvcnRQcm9ncmVzcylcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZX0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKHNjaGVtYUNvbnRyb2xsZXIgPT4gc2NoZW1hQ29udHJvbGxlci5nZXRPbmVTY2hlbWEocmVxLmJvZHkubmFtZSwgdHJ1ZSkpXG4gICAgICAudGhlbigoc2NoZW1hKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsYXNzTmFtZXMgPSBbIHJlcS5ib2R5Lm5hbWUgXTtcbiAgICAgICAgT2JqZWN0LmtleXMoc2NoZW1hLmZpZWxkcykuZm9yRWFjaCgoZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSBzY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG5cbiAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gJ1JlbGF0aW9uJykge1xuICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKGBfSm9pbjoke2ZpZWxkTmFtZX06JHtyZXEuYm9keS5uYW1lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzc2VzID0gY2xhc3NOYW1lcy5tYXAoKG5hbWUpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5leHBvcnRDbGFzcyhyZXEsIHsgbmFtZSB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc3NlcylcbiAgICAgIH0pXG4gICAgICAudGhlbigoanNvbkZpbGVzKSA9PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgY29uc3QgdG1wWmlwRmlsZSA9IHRtcC5maWxlU3luYygpO1xuICAgICAgICAgIGNvbnN0IHRtcFppcFN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRtcFppcEZpbGUubmFtZSk7XG5cbiAgICAgICAgICBjb25zdCB6aXAgID0gYXJjaGl2ZXIoJ3ppcCcpO1xuICAgICAgICAgIHppcC5waXBlKHRtcFppcFN0cmVhbSk7XG5cbiAgICAgICAgICBqc29uRmlsZXMuZm9yRWFjaCh0bXBKc29uRmlsZSA9PiB7XG4gICAgICAgICAgICB6aXAuYXBwZW5kKGZzLnJlYWRGaWxlU3luYyh0bXBKc29uRmlsZS5uYW1lKSwgeyBuYW1lOiAgdG1wSnNvbkZpbGUuX25hbWUgfSk7XG4gICAgICAgICAgICB0bXBKc29uRmlsZS5yZW1vdmVDYWxsYmFjaygpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgemlwLmZpbmFsaXplKCk7XG5cbiAgICAgICAgICB0bXBaaXBTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBidWYgPSBmcy5yZWFkRmlsZVN5bmModG1wWmlwRmlsZS5uYW1lKTtcbiAgICAgICAgICAgIHRtcFppcEZpbGUucmVtb3ZlQ2FsbGJhY2soKTtcbiAgICAgICAgICAgIHJlc29sdmUoYnVmKTtcblxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgfSlcbiAgICAgIC50aGVuKCh6aXBwZWRGaWxlKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzQ29udHJvbGxlciA9IHJlcS5jb25maWcuZmlsZXNDb250cm9sbGVyO1xuICAgICAgICByZXR1cm4gZmlsZXNDb250cm9sbGVyLmNyZWF0ZUZpbGUocmVxLmNvbmZpZywgcmVxLmJvZHkubmFtZSwgemlwcGVkRmlsZSwgJ2FwcGxpY2F0aW9uL3ppcCcpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKChmaWxlRGF0YSkgPT4ge1xuXG4gICAgICAgIHJldHVybiBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICB0ZXh0OiBgV2UgaGF2ZSBzdWNjZXNzZnVsbHkgZXhwb3J0ZWQgeW91ciBkYXRhIGZyb20gdGhlIGNsYXNzICR7cmVxLmJvZHkubmFtZX0uXFxuXG4gICAgICAgIFBsZWFzZSBkb3dubG9hZCBmcm9tICR7ZmlsZURhdGEudXJsfWAsXG4gICAgICAgICAgbGluazogZmlsZURhdGEudXJsLFxuICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgIHN1YmplY3Q6ICdFeHBvcnQgY29tcGxldGVkJ1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIHJldHVybiBlbWFpbENvbnRyb2xsZXJBZGFwdGVyLnNlbmRNYWlsKHtcbiAgICAgICAgICB0ZXh0OiBgV2UgY291bGQgbm90IGV4cG9ydCB5b3VyIGRhdGEgdG8gdGhlIGNsYXNzICR7cmVxLmJvZHkubmFtZX0uIEVycm9yOiAke2Vycm9yfWAsXG4gICAgICAgICAgdG86IHJlcS5ib2R5LmZlZWRiYWNrRW1haWwsXG4gICAgICAgICAgc3ViamVjdDogJ0V4cG9ydCBmYWlsZWQnXG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGFiYXNlQ29udHJvbGxlci5kZXN0cm95KERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLCBleHBvcnRQcm9ncmVzcyk7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiAnV2UgYXJlIGV4cG9ydGluZyB5b3VyIGRhdGEuIFlvdSB3aWxsIGJlIG5vdGlmaWVkIGJ5IGUtbWFpbCBvbmNlIGl0IGlzIGNvbXBsZXRlZC4nfSk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BVVCcsXG4gICAgICAnL2V4cG9ydF9kYXRhJyxcbiAgICAgIChyZXEpID0+IHsgcmV0dXJuIHRoaXMuaGFuZGxlRXhwb3J0KHJlcSk7IH1cbiAgICApO1xuXG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdHRVQnLFxuICAgICAgJy9leHBvcnRfcHJvZ3Jlc3MnLFxuICAgICAgKHJlcSkgPT4geyByZXR1cm4gdGhpcy5oYW5kbGVFeHBvcnRQcm9ncmVzcyhyZXEpOyB9XG4gICAgKTtcblxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEV4cG9ydFJvdXRlcjtcbiJdfQ==