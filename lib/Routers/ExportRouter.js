"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ExportRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _AdapterLoader = require("../Adapters/AdapterLoader");

var _rest = _interopRequireDefault(require("../rest"));

var _archiver = _interopRequireDefault(require("archiver"));

var _tmp = _interopRequireDefault(require("tmp"));

var _fs = _interopRequireDefault(require("fs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DefaultExportExportProgressCollectionName = '_ExportProgress';
const relationSchema = {
  fields: {
    relatedId: {
      type: 'String'
    },
    owningId: {
      type: 'String'
    }
  }
};

class ExportRouter extends _PromiseRouter.default {
  exportClassPage(req, name, jsonFileStream, where, skip, limit) {
    const databaseController = req.config.database;
    const options = {
      skip,
      limit
    };
    const findPromise = name.indexOf('_Join') === 0 ? databaseController.adapter.find(name, relationSchema, where, options) : _rest.default.find(req.config, req.auth, name, where, options);
    return findPromise.then(data => {
      if (Array.isArray(data)) {
        data = {
          results: data
        };
      }

      if (skip && data.results.length) {
        jsonFileStream.write(',\n');
      }

      jsonFileStream.write(JSON.stringify(data.results, null, 2).substr(1).slice(0, -1));
    });
  }

  exportClass(req, data) {
    const databaseController = req.config.database;

    const tmpJsonFile = _tmp.default.fileSync();

    const jsonFileStream = _fs.default.createWriteStream(tmpJsonFile.name);

    jsonFileStream.write('{\n"results" : [\n');
    const hasJoin = data.name.indexOf('_Join') === 0;
    let findPromise = null;

    if (hasJoin) {
      findPromise = databaseController.adapter.count(data.name, relationSchema, data.where);
    } else {
      findPromise = _rest.default.find(req.config, req.auth, data.name, data.where, {
        count: true,
        limit: 0
      });
    }

    return findPromise.then(result => {
      if (Number.isInteger(result)) {
        result = {
          count: result
        };
      }

      let i = 0;
      const pageLimit = 1000;
      let promise = Promise.resolve();

      for (i = 0; i < result.count; i += pageLimit) {
        const skip = i;
        promise = promise.then(() => {
          return this.exportClassPage(req, data.name, jsonFileStream, data.where, skip, pageLimit);
        });
      }

      return promise;
    }).then(() => {
      jsonFileStream.end(']\n}');
      return new Promise(resolve => {
        jsonFileStream.on('close', () => {
          tmpJsonFile._name = `${data.name.replace(/:/g, 'êž‰')}.json`;
          resolve(tmpJsonFile);
        });
      });
    });
  }

  handleExportProgress(req) {
    const databaseController = req.config.database;
    const query = {
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    return databaseController.find(DefaultExportExportProgressCollectionName, query).then(response => {
      return {
        response
      };
    });
  }

  handleExport(req) {
    const databaseController = req.config.database;
    const emailControllerAdapter = (0, _AdapterLoader.loadAdapter)(req.config.emailAdapter);

    if (!emailControllerAdapter) {
      return Promise.reject(new Error('You have to setup a Mail Adapter.'));
    }

    const exportProgress = {
      id: req.body.name,
      masterKey: req.info.masterKey,
      applicationId: req.info.appId
    };
    databaseController.create(DefaultExportExportProgressCollectionName, exportProgress).then(() => {
      return databaseController.loadSchema({
        clearCache: true
      });
    }).then(schemaController => schemaController.getOneSchema(req.body.name, true)).then(schema => {
      const classNames = [req.body.name];
      Object.keys(schema.fields).forEach(fieldName => {
        const field = schema.fields[fieldName];

        if (field.type === 'Relation') {
          classNames.push(`_Join:${fieldName}:${req.body.name}`);
        }
      });
      const promisses = classNames.map(name => {
        return this.exportClass(req, {
          name
        });
      });
      return Promise.all(promisses);
    }).then(jsonFiles => {
      return new Promise(resolve => {
        const tmpZipFile = _tmp.default.fileSync();

        const tmpZipStream = _fs.default.createWriteStream(tmpZipFile.name);

        const zip = (0, _archiver.default)('zip');
        zip.pipe(tmpZipStream);
        jsonFiles.forEach(tmpJsonFile => {
          zip.append(_fs.default.readFileSync(tmpJsonFile.name), {
            name: tmpJsonFile._name
          });
          tmpJsonFile.removeCallback();
        });
        zip.finalize();
        tmpZipStream.on('close', () => {
          const buf = _fs.default.readFileSync(tmpZipFile.name);

          tmpZipFile.removeCallback();
          resolve(buf);
        });
      });
    }).then(zippedFile => {
      const filesController = req.config.filesController;
      return filesController.createFile(req.config, req.body.name, zippedFile, 'application/zip');
    }).then(fileData => {
      return emailControllerAdapter.sendMail({
        text: `We have successfully exported your data from the class ${req.body.name}.\n
        Please download from ${fileData.url}`,
        link: fileData.url,
        to: req.body.feedbackEmail,
        subject: 'Export completed'
      });
    }).catch(error => {
      return emailControllerAdapter.sendMail({
        text: `We could not export your data to the class ${req.body.name}. Error: ${error}`,
        to: req.body.feedbackEmail,
        subject: 'Export failed'
      });
    }).then(() => {
      return databaseController.destroy(DefaultExportExportProgressCollectionName, exportProgress);
    });
    return Promise.resolve({
      response: 'We are exporting your data. You will be notified by e-mail once it is completed.'
    });
  }

  mountRoutes() {
    this.route('PUT', '/export_data', req => {
      return this.handleExport(req);
    });
    this.route('GET', '/export_progress', req => {
      return this.handleExportProgress(req);
    });
  }

}

exports.ExportRouter = ExportRouter;
var _default = ExportRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0V4cG9ydFJvdXRlci5qcyJdLCJuYW1lcyI6WyJEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSIsInJlbGF0aW9uU2NoZW1hIiwiZmllbGRzIiwicmVsYXRlZElkIiwidHlwZSIsIm93bmluZ0lkIiwiRXhwb3J0Um91dGVyIiwiUHJvbWlzZVJvdXRlciIsImV4cG9ydENsYXNzUGFnZSIsInJlcSIsIm5hbWUiLCJqc29uRmlsZVN0cmVhbSIsIndoZXJlIiwic2tpcCIsImxpbWl0IiwiZGF0YWJhc2VDb250cm9sbGVyIiwiY29uZmlnIiwiZGF0YWJhc2UiLCJvcHRpb25zIiwiZmluZFByb21pc2UiLCJpbmRleE9mIiwiYWRhcHRlciIsImZpbmQiLCJyZXN0IiwiYXV0aCIsInRoZW4iLCJkYXRhIiwiQXJyYXkiLCJpc0FycmF5IiwicmVzdWx0cyIsImxlbmd0aCIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsInN1YnN0ciIsInNsaWNlIiwiZXhwb3J0Q2xhc3MiLCJ0bXBKc29uRmlsZSIsInRtcCIsImZpbGVTeW5jIiwiZnMiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImhhc0pvaW4iLCJjb3VudCIsInJlc3VsdCIsIk51bWJlciIsImlzSW50ZWdlciIsImkiLCJwYWdlTGltaXQiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJlbmQiLCJvbiIsIl9uYW1lIiwicmVwbGFjZSIsImhhbmRsZUV4cG9ydFByb2dyZXNzIiwicXVlcnkiLCJtYXN0ZXJLZXkiLCJpbmZvIiwiYXBwbGljYXRpb25JZCIsImFwcElkIiwicmVzcG9uc2UiLCJoYW5kbGVFeHBvcnQiLCJlbWFpbENvbnRyb2xsZXJBZGFwdGVyIiwiZW1haWxBZGFwdGVyIiwicmVqZWN0IiwiRXJyb3IiLCJleHBvcnRQcm9ncmVzcyIsImlkIiwiYm9keSIsImNyZWF0ZSIsImxvYWRTY2hlbWEiLCJjbGVhckNhY2hlIiwic2NoZW1hQ29udHJvbGxlciIsImdldE9uZVNjaGVtYSIsInNjaGVtYSIsImNsYXNzTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImZpZWxkTmFtZSIsImZpZWxkIiwicHVzaCIsInByb21pc3NlcyIsIm1hcCIsImFsbCIsImpzb25GaWxlcyIsInRtcFppcEZpbGUiLCJ0bXBaaXBTdHJlYW0iLCJ6aXAiLCJwaXBlIiwiYXBwZW5kIiwicmVhZEZpbGVTeW5jIiwicmVtb3ZlQ2FsbGJhY2siLCJmaW5hbGl6ZSIsImJ1ZiIsInppcHBlZEZpbGUiLCJmaWxlc0NvbnRyb2xsZXIiLCJjcmVhdGVGaWxlIiwiZmlsZURhdGEiLCJzZW5kTWFpbCIsInRleHQiLCJ1cmwiLCJsaW5rIiwidG8iLCJmZWVkYmFja0VtYWlsIiwic3ViamVjdCIsImNhdGNoIiwiZXJyb3IiLCJkZXN0cm95IiwibW91bnRSb3V0ZXMiLCJyb3V0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEseUNBQXlDLEdBQUcsaUJBQWxEO0FBQ0EsTUFBTUMsY0FBYyxHQUFHO0FBQ3JCQyxFQUFBQSxNQUFNLEVBQUU7QUFBRUMsSUFBQUEsU0FBUyxFQUFFO0FBQUVDLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQWI7QUFBaUNDLElBQUFBLFFBQVEsRUFBRTtBQUFFRCxNQUFBQSxJQUFJLEVBQUU7QUFBUjtBQUEzQztBQURhLENBQXZCOztBQUlPLE1BQU1FLFlBQU4sU0FBMkJDLHNCQUEzQixDQUF5QztBQUM5Q0MsRUFBQUEsZUFBZSxDQUFDQyxHQUFELEVBQU1DLElBQU4sRUFBWUMsY0FBWixFQUE0QkMsS0FBNUIsRUFBbUNDLElBQW5DLEVBQXlDQyxLQUF6QyxFQUFnRDtBQUM3RCxVQUFNQyxrQkFBa0IsR0FBR04sR0FBRyxDQUFDTyxNQUFKLENBQVdDLFFBQXRDO0FBRUEsVUFBTUMsT0FBTyxHQUFHO0FBQ2RMLE1BQUFBLElBRGM7QUFFZEMsTUFBQUE7QUFGYyxLQUFoQjtBQUtB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VixZQUFXbUcsS0FBTSxFQUhtQjtBQUlyQ0osUUFBQUEsRUFBRSxFQUFFaEcsR0FBRyxDQUFDNkQsSUFBSixDQUFTb0MsYUFKd0I7QUFLckNDLFFBQUFBLE9BQU8sRUFBRTtBQUw0QixPQUFoQyxDQUFQO0FBT0QsS0E1RUgsRUE2RUdsRixJQTdFSCxDQTZFUSxNQUFNO0FBQ1YsYUFBT1Ysa0JBQWtCLENBQUMrRixPQUFuQixDQUNMOUcseUNBREssRUFFTG9FLGNBRkssQ0FBUDtBQUlELEtBbEZIO0FBb0ZBLFdBQU9sQixPQUFPLENBQUNDLE9BQVIsQ0FBZ0I7QUFDckJXLE1BQUFBLFFBQVEsRUFDTjtBQUZtQixLQUFoQixDQUFQO0FBSUQ7O0FBRURpRCxFQUFBQSxXQUFXLEdBQUc7QUFDWixTQUFLQyxLQUFMLENBQVcsS0FBWCxFQUFrQixjQUFsQixFQUFrQ3ZHLEdBQUcsSUFBSTtBQUN2QyxhQUFPLEtBQUtzRCxZQUFMLENBQWtCdEQsR0FBbEIsQ0FBUDtBQUNELEtBRkQ7QUFJQSxTQUFLdUcsS0FBTCxDQUFXLEtBQVgsRUFBa0Isa0JBQWxCLEVBQXNDdkcsR0FBRyxJQUFJO0FBQzNDLGFBQU8sS0FBSytDLG9CQUFMLENBQTBCL0MsR0FBMUIsQ0FBUDtBQUNELEtBRkQ7QUFHRDs7QUEzTjZDOzs7ZUE4TmpDSCxZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgeyBsb2FkQWRhcHRlciB9IGZyb20gJy4uL0FkYXB0ZXJzL0FkYXB0ZXJMb2FkZXInO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi4vcmVzdCc7XG5pbXBvcnQgYXJjaGl2ZXIgZnJvbSAnYXJjaGl2ZXInO1xuaW1wb3J0IHRtcCBmcm9tICd0bXAnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcblxuY29uc3QgRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUgPSAnX0V4cG9ydFByb2dyZXNzJztcbmNvbnN0IHJlbGF0aW9uU2NoZW1hID0ge1xuICBmaWVsZHM6IHsgcmVsYXRlZElkOiB7IHR5cGU6ICdTdHJpbmcnIH0sIG93bmluZ0lkOiB7IHR5cGU6ICdTdHJpbmcnIH0gfSxcbn07XG5cbmV4cG9ydCBjbGFzcyBFeHBvcnRSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgZXhwb3J0Q2xhc3NQYWdlKHJlcSwgbmFtZSwganNvbkZpbGVTdHJlYW0sIHdoZXJlLCBza2lwLCBsaW1pdCkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG5cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgIH07XG5cbiAgICBjb25zdCBmaW5kUHJvbWlzZSA9XG4gICAgICBuYW1lLmluZGV4T2YoJ19Kb2luJykgPT09IDBcbiAgICAgICAgPyBkYXRhYmFzZUNvbnRyb2xsZXIuYWRhcHRlci5maW5kKG5hbWUsIHJlbGF0aW9uU2NoZW1hLCB3aGVyZSwgb3B0aW9ucylcbiAgICAgICAgOiByZXN0LmZpbmQocmVxLmNvbmZpZywgcmVxLmF1dGgsIG5hbWUsIHdoZXJlLCBvcHRpb25zKTtcblxuICAgIHJldHVybiBmaW5kUHJvbWlzZS50aGVuKGRhdGEgPT4ge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgICAgZGF0YSA9IHsgcmVzdWx0czogZGF0YSB9O1xuICAgICAgfVxuXG4gICAgICBpZiAoc2tpcCAmJiBkYXRhLnJlc3VsdHMubGVuZ3RoKSB7XG4gICAgICAgIGpzb25GaWxlU3RyZWFtLndyaXRlKCcsXFxuJyk7XG4gICAgICB9XG5cbiAgICAgIGpzb25GaWxlU3RyZWFtLndyaXRlKFxuICAgICAgICBKU09OLnN0cmluZ2lmeShkYXRhLnJlc3VsdHMsIG51bGwsIDIpXG4gICAgICAgICAgLnN1YnN0cigxKVxuICAgICAgICAgIC5zbGljZSgwLCAtMSlcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBleHBvcnRDbGFzcyhyZXEsIGRhdGEpIHtcbiAgICBjb25zdCBkYXRhYmFzZUNvbnRyb2xsZXIgPSByZXEuY29uZmlnLmRhdGFiYXNlO1xuICAgIGNvbnN0IHRtcEpzb25GaWxlID0gdG1wLmZpbGVTeW5jKCk7XG4gICAgY29uc3QganNvbkZpbGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSh0bXBKc29uRmlsZS5uYW1lKTtcblxuICAgIGpzb25GaWxlU3RyZWFtLndyaXRlKCd7XFxuXCJyZXN1bHRzXCIgOiBbXFxuJyk7XG4gICAgY29uc3QgaGFzSm9pbiA9IGRhdGEubmFtZS5pbmRleE9mKCdfSm9pbicpID09PSAwO1xuICAgIGxldCBmaW5kUHJvbWlzZSA9IG51bGw7XG4gICAgaWYgKGhhc0pvaW4pIHtcbiAgICAgIGZpbmRQcm9taXNlID0gZGF0YWJhc2VDb250cm9sbGVyLmFkYXB0ZXIuY291bnQoXG4gICAgICAgIGRhdGEubmFtZSxcbiAgICAgICAgcmVsYXRpb25TY2hlbWEsXG4gICAgICAgIGRhdGEud2hlcmVcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpbmRQcm9taXNlID0gcmVzdC5maW5kKHJlcS5jb25maWcsIHJlcS5hdXRoLCBkYXRhLm5hbWUsIGRhdGEud2hlcmUsIHtcbiAgICAgICAgY291bnQ6IHRydWUsXG4gICAgICAgIGxpbWl0OiAwLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbmRQcm9taXNlXG4gICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihyZXN1bHQpKSB7XG4gICAgICAgICAgcmVzdWx0ID0geyBjb3VudDogcmVzdWx0IH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgIGNvbnN0IHBhZ2VMaW1pdCA9IDEwMDA7XG4gICAgICAgIGxldCBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJlc3VsdC5jb3VudDsgaSArPSBwYWdlTGltaXQpIHtcbiAgICAgICAgICBjb25zdCBza2lwID0gaTtcbiAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmV4cG9ydENsYXNzUGFnZShcbiAgICAgICAgICAgICAgcmVxLFxuICAgICAgICAgICAgICBkYXRhLm5hbWUsXG4gICAgICAgICAgICAgIGpzb25GaWxlU3RyZWFtLFxuICAgICAgICAgICAgICBkYXRhLndoZXJlLFxuICAgICAgICAgICAgICBza2lwLFxuICAgICAgICAgICAgICBwYWdlTGltaXRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGpzb25GaWxlU3RyZWFtLmVuZCgnXVxcbn0nKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAganNvbkZpbGVTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgdG1wSnNvbkZpbGUuX25hbWUgPSBgJHtkYXRhLm5hbWUucmVwbGFjZSgvOi9nLCAn6p6JJyl9Lmpzb25gO1xuXG4gICAgICAgICAgICByZXNvbHZlKHRtcEpzb25GaWxlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUV4cG9ydFByb2dyZXNzKHJlcSkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG5cbiAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgIG1hc3RlcktleTogcmVxLmluZm8ubWFzdGVyS2V5LFxuICAgICAgYXBwbGljYXRpb25JZDogcmVxLmluZm8uYXBwSWQsXG4gICAgfTtcblxuICAgIHJldHVybiBkYXRhYmFzZUNvbnRyb2xsZXJcbiAgICAgIC5maW5kKERlZmF1bHRFeHBvcnRFeHBvcnRQcm9ncmVzc0NvbGxlY3Rpb25OYW1lLCBxdWVyeSlcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgcmV0dXJuIHsgcmVzcG9uc2UgfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlRXhwb3J0KHJlcSkge1xuICAgIGNvbnN0IGRhdGFiYXNlQ29udHJvbGxlciA9IHJlcS5jb25maWcuZGF0YWJhc2U7XG5cbiAgICBjb25zdCBlbWFpbENvbnRyb2xsZXJBZGFwdGVyID0gbG9hZEFkYXB0ZXIocmVxLmNvbmZpZy5lbWFpbEFkYXB0ZXIpO1xuXG4gICAgaWYgKCFlbWFpbENvbnRyb2xsZXJBZGFwdGVyKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCdZb3UgaGF2ZSB0byBzZXR1cCBhIE1haWwgQWRhcHRlci4nKSk7XG4gICAgfVxuXG4gICAgY29uc3QgZXhwb3J0UHJvZ3Jlc3MgPSB7XG4gICAgICBpZDogcmVxLmJvZHkubmFtZSxcbiAgICAgIG1hc3RlcktleTogcmVxLmluZm8ubWFzdGVyS2V5LFxuICAgICAgYXBwbGljYXRpb25JZDogcmVxLmluZm8uYXBwSWQsXG4gICAgfTtcblxuICAgIGRhdGFiYXNlQ29udHJvbGxlclxuICAgICAgLmNyZWF0ZShEZWZhdWx0RXhwb3J0RXhwb3J0UHJvZ3Jlc3NDb2xsZWN0aW9uTmFtZSwgZXhwb3J0UHJvZ3Jlc3MpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiBkYXRhYmFzZUNvbnRyb2xsZXIubG9hZFNjaGVtYSh7IGNsZWFyQ2FjaGU6IHRydWUgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oc2NoZW1hQ29udHJvbGxlciA9PlxuICAgICAgICBzY2hlbWFDb250cm9sbGVyLmdldE9uZVNjaGVtYShyZXEuYm9keS5uYW1lLCB0cnVlKVxuICAgICAgKVxuICAgICAgLnRoZW4oc2NoZW1hID0+IHtcbiAgICAgICAgY29uc3QgY2xhc3NOYW1lcyA9IFtyZXEuYm9keS5uYW1lXTtcbiAgICAgICAgT2JqZWN0LmtleXMoc2NoZW1hLmZpZWxkcykuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkID0gc2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuXG4gICAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdSZWxhdGlvbicpIHtcbiAgICAgICAgICAgIGNsYXNzTmFtZXMucHVzaChgX0pvaW46JHtmaWVsZE5hbWV9OiR7cmVxLmJvZHkubmFtZX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHByb21pc3NlcyA9IGNsYXNzTmFtZXMubWFwKG5hbWUgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLmV4cG9ydENsYXNzKHJlcSwgeyBuYW1lIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzc2VzKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihqc29uRmlsZXMgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgY29uc3QgdG1wWmlwRmlsZSA9IHRtcC5maWxlU3luYygpO1xuICAgICAgICAgIGNvbnN0IHRtcFppcFN0cmVhbSA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRtcFppcEZpbGUubmFtZSk7XG5cbiAgICAgICAgICBjb25zdCB6aXAgPSBhcmNoaXZlcignemlwJyk7XG4gICAgICAgICAgemlwLnBpcGUodG1wWmlwU3RyZWFtKTtcblxuICAgICAgICAgIGpzb25GaWxlcy5mb3JFYWNoKHRtcEpzb25GaWxlID0+IHtcbiAgICAgICAgICAgIHppcC5hcHBlbmQoZnMucmVhZEZpbGVTeW5jKHRtcEpzb25GaWxlLm5hbWUpLCB7XG4gICAgICAgICAgICAgIG5hbWU6IHRtcEpzb25GaWxlLl9uYW1lLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0bXBKc29uRmlsZS5yZW1vdmVDYWxsYmFjaygpO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgemlwLmZpbmFsaXplKCk7XG5cbiAgICAgICAgICB0bXBaaXBTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYnVmID0gZnMucmVhZEZpbGVTeW5jKHRtcFppcEZpbGUubmFtZSk7XG4gICAgICAgICAgICB0bXBaaXBGaWxlLnJlbW92ZUNhbGxiYWNrKCk7XG4gICAgICAgICAgICByZXNvbHZlKGJ1Zik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKHppcHBlZEZpbGUgPT4ge1xuICAgICAgICBjb25zdCBmaWxlc0NvbnRyb2xsZXIgPSByZXEuY29uZmlnLmZpbGVzQ29udHJvbGxlcjtcbiAgICAgICAgcmV0dXJuIGZpbGVzQ29udHJvbGxlci5jcmVhdGVGaWxlKFxuICAgICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgICAgcmVxLmJvZHkubmFtZSxcbiAgICAgICAgICB6aXBwZWRGaWxlLFxuICAgICAgICAgICdhcHBsaWNhdGlvbi96aXAnXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oZmlsZURhdGEgPT4ge1xuICAgICAgICByZXR1cm4gZW1haWxDb250cm9sbGVyQWRhcHRlci5zZW5kTWFpbCh7XG4gICAgICAgICAgdGV4dDogYFdlIGhhdmUgc3VjY2Vzc2Z1bGx5IGV4cG9ydGVkIHlvdXIgZGF0YSBmcm9tIHRoZSBjbGFzcyAke1xuICAgICAgICAgICAgcmVxLmJvZHkubmFtZVxuICAgICAgICAgIH0uXFxuXG4gICAgICAgIFBsZWFzZSBkb3dubG9hZCBmcm9tICR7ZmlsZURhdGEudXJsfWAsXG4gICAgICAgICAgbGluazogZmlsZURhdGEudXJsLFxuICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgIHN1YmplY3Q6ICdFeHBvcnQgY29tcGxldGVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIGVtYWlsQ29udHJvbGxlckFkYXB0ZXIuc2VuZE1haWwoe1xuICAgICAgICAgIHRleHQ6IGBXZSBjb3VsZCBub3QgZXhwb3J0IHlvdXIgZGF0YSB0byB0aGUgY2xhc3MgJHtcbiAgICAgICAgICAgIHJlcS5ib2R5Lm5hbWVcbiAgICAgICAgICB9LiBFcnJvcjogJHtlcnJvcn1gLFxuICAgICAgICAgIHRvOiByZXEuYm9keS5mZWVkYmFja0VtYWlsLFxuICAgICAgICAgIHN1YmplY3Q6ICdFeHBvcnQgZmFpbGVkJyxcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gZGF0YWJhc2VDb250cm9sbGVyLmRlc3Ryb3koXG4gICAgICAgICAgRGVmYXVsdEV4cG9ydEV4cG9ydFByb2dyZXNzQ29sbGVjdGlvbk5hbWUsXG4gICAgICAgICAgZXhwb3J0UHJvZ3Jlc3NcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICByZXNwb25zZTpcbiAgICAgICAgJ1dlIGFyZSBleHBvcnRpbmcgeW91ciBkYXRhLiBZb3Ugd2lsbCBiZSBub3RpZmllZCBieSBlLW1haWwgb25jZSBpdCBpcyBjb21wbGV0ZWQuJyxcbiAgICB9KTtcbiAgfVxuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoJ1BVVCcsICcvZXhwb3J0X2RhdGEnLCByZXEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlRXhwb3J0KHJlcSk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAnL2V4cG9ydF9wcm9ncmVzcycsIHJlcSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVFeHBvcnRQcm9ncmVzcyhyZXEpO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEV4cG9ydFJvdXRlcjtcbiJdfQ==