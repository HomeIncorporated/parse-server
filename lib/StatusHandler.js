"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.flatten = flatten;
exports.jobStatusHandler = jobStatusHandler;
exports.pushStatusHandler = pushStatusHandler;

var _cryptoUtils = require("./cryptoUtils");

var _logger = require("./logger");

var _rest = _interopRequireDefault(require("./rest"));

var _Auth = _interopRequireDefault(require("./Auth"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const PUSH_STATUS_COLLECTION = '_PushStatus';
const JOB_STATUS_COLLECTION = '_JobStatus';

const incrementOp = function (object = {}, key, amount = 1) {
  if (!object[key]) {
    object[key] = {
      __op: 'Increment',
      amount: amount
    };
  } else {
    object[key].amount += amount;
  }

  return object[key];
};

function flatten(array) {
  var flattened = [];

  for (var i = 0; i < array.length; i++) {
    if (Array.isArray(array[i])) {
      flattened = flattened.concat(flatten(array[i]));
    } else {
      flattened.push(array[i]);
    }
  }

  return flattened;
}

function statusHandler(className, database) {
  let lastPromise = Promise.resolve();

  function create(object) {
    lastPromise = lastPromise.then(() => {
      return database.create(className, object).then(() => {
        return Promise.resolve(object);
      });
    });
    return lastPromise;
  }

  function update(where, object) {
    lastPromise = lastPromise.then(() => {
      return database.update(className, where, object);
    });
    return lastPromise;
  }

  return Object.freeze({
    create,
    update
  });
}

function restStatusHandler(className, config) {
  let lastPromise = Promise.resolve();

  const auth = _Auth.default.master(config);

  function create(object) {
    lastPromise = lastPromise.then(() => {
      return _rest.default.create(config, auth, className, object).then(({
        response
      }) => {
        // merge the objects
        return Promise.resolve(Object.assign({}, object, response));
      });
    });
    return lastPromise;
  }

  function update(where, object) {
    // TODO: when we have updateWhere, use that for proper interfacing
    lastPromise = lastPromise.then(() => {
      return _rest.default.update(config, auth, className, {
        objectId: where.objectId
      }, object).then(({
        response
      }) => {
        // merge the objects
        return Promise.resolve(Object.assign({}, object, response));
      });
    });
    return lastPromise;
  }

  return Object.freeze({
    create,
    update
  });
}

function jobStatusHandler(config) {
  let jobStatus;
  const objectId = (0, _cryptoUtils.newObjectId)(config.objectIdSize);
  const database = config.database;
  const handler = statusHandler(JOB_STATUS_COLLECTION, database);

  const setRunning = function (jobName, params) {
    const now = new Date();
    jobStatus = {
      objectId,
      jobName,
      params,
      status: 'running',
      source: 'api',
      createdAt: now,
      // lockdown!
      ACL: {}
    };
    return handler.create(jobStatus);
  };

  const setMessage = function (message) {
    if (!message || typeof message !== 'string') {
      return Promise.resolve();
    }

    return handler.update({
      objectId
    }, {
      message
    });
  };

  const setSucceeded = function (message) {
    return setFinalStatus('succeeded', message);
  };

  const setFailed = function (message) {
    return setFinalStatus('failed', message);
  };

  const setFinalStatus = function (status, message = undefined) {
    const finishedAt = new Date();
    const update = {
      status,
      finishedAt
    };

    if (message && typeof message === 'string') {
      update.message = message;
    }

    return handler.update({
      objectId
    }, update);
  };

  return Object.freeze({
    setRunning,
    setSucceeded,
    setMessage,
    setFailed
  });
}

function pushStatusHandler(config, existingObjectId) {
  let pushStatus;
  const database = config.database;
  const handler = restStatusHandler(PUSH_STATUS_COLLECTION, config);
  let objectId = existingObjectId;

  const setInitial = function (body = {}, where, options = {
    source: 'rest'
  }) {
    const now = new Date();
    let pushTime = now.toISOString();
    let status = 'pending';

    if (body.hasOwnProperty('push_time')) {
      if (config.hasPushScheduledSupport) {
        pushTime = body.push_time;
        status = 'scheduled';
      } else {
        _logger.logger.warn('Trying to schedule a push while server is not configured.');

        _logger.logger.warn('Push will be sent immediately');
      }
    }

    const data = body.data || {};
    const payloadString = JSON.stringify(data);
    let pushHash;

    if (typeof data.alert === 'string') {
      pushHash = (0, _cryptoUtils.md5Hash)(data.alert);
    } else if (typeof data.alert === 'object') {
      pushHash = (0, _cryptoUtils.md5Hash)(JSON.stringify(data.alert));
    } else {
      pushHash = 'd41d8cd98f00b204e9800998ecf8427e';
    }

    const object = {
      pushTime,
      query: JSON.stringify(where),
      payload: payloadString,
      source: options.source,
      title: options.title,
      expiry: body.expiration_time,
      expiration_interval: body.expiration_interval,
      status: status,
      numSent: 0,
      pushHash,
      // lockdown!
      ACL: {}
    };
    return handler.create(object).then(result => {
      objectId = result.objectId;
      pushStatus = {
        objectId
      };
      return Promise.resolve(pushStatus);
    });
  };

  const setRunning = function (batches) {
    _logger.logger.verbose(`_PushStatus ${objectId}: sending push to installations with %d batches`, batches);

    return handler.update({
      status: 'pending',
      objectId: objectId
    }, {
      status: 'running',
      count: batches
    });
  };

  const update = function (update) {
    _logger.logger.verbose(`_PushStatus ${objectId}: updating values %j`, update);

    return handler.update({
      objectId
    }, update);
  };

  const trackSent = function (results, UTCOffset, cleanupInstallations = process.env.PARSE_SERVER_CLEANUP_INVALID_INSTALLATIONS) {
    const update = {
      numSent: 0,
      numFailed: 0
    };
    const devicesToRemove = [];

    if (Array.isArray(results)) {
      results = flatten(results);
      results.reduce((memo, result) => {
        // Cannot handle that
        if (!result || !result.device || !result.device.deviceType) {
          return memo;
        }

        const deviceType = result.device.deviceType;
        const key = result.transmitted ? `sentPerType.${deviceType}` : `failedPerType.${deviceType}`;
        memo[key] = incrementOp(memo, key);

        if (typeof UTCOffset !== 'undefined') {
          const offsetKey = result.transmitted ? `sentPerUTCOffset.${UTCOffset}` : `failedPerUTCOffset.${UTCOffset}`;
          memo[offsetKey] = incrementOp(memo, offsetKey);
        }

        if (result.transmitted) {
          memo.numSent++;
        } else {
          if (result && result.response && result.response.error && result.device && result.device.deviceToken) {
            const token = result.device.deviceToken;
            const error = result.response.error; // GCM errors

            if (error === 'NotRegistered' || error === 'InvalidRegistration') {
              devicesToRemove.push(token);
            } // APNS errors


            if (error === 'Unregistered' || error === 'BadDeviceToken') {
              devicesToRemove.push(token);
            }
          }

          memo.numFailed++;
        }

        return memo;
      }, update);
    }

    _logger.logger.verbose(`_PushStatus ${objectId}: sent push! %d success, %d failures`, update.numSent, update.numFailed);

    _logger.logger.verbose(`_PushStatus ${objectId}: needs cleanup`, {
      devicesToRemove
    });

    ['numSent', 'numFailed'].forEach(key => {
      if (update[key] > 0) {
        update[key] = {
          __op: 'Increment',
          amount: update[key]
        };
      } else {
        delete update[key];
      }
    });

    if (devicesToRemove.length > 0 && cleanupInstallations) {
      _logger.logger.info(`Removing device tokens on ${devicesToRemove.length} _Installations`);

      database.update('_Installation', {
        deviceToken: {
          $in: devicesToRemove
        }
      }, {
        deviceToken: {
          __op: 'Delete'
        }
      }, {
        acl: undefined,
        many: true
      });
    } // indicate this batch is complete


    incrementOp(update, 'count', -1);
    return handler.update({
      objectId
    }, update).then(res => {
      if (res && res.count === 0) {
        return this.complete();
      }
    });
  };

  const complete = function () {
    return handler.update({
      objectId
    }, {
      status: 'succeeded',
      count: {
        __op: 'Delete'
      }
    });
  };

  const fail = function (err) {
    if (typeof err === 'string') {
      err = {
        message: err
      };
    }

    const update = {
      errorMessage: err,
      status: 'failed'
    };
    return handler.update({
      objectId
    }, update);
  };

  const rval = {
    setInitial,
    setRunning,
    trackSent,
    complete,
    update,
    fail
  }; // define objectId to be dynamic

  Object.defineProperty(rval, 'objectId', {
    get: () => objectId
  });
  return Object.freeze(rval);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0dXNIYW5kbGVyLmpzIl0sIm5hbWVzIjpbIlBVU0hfU1RBVFVTX0NPTExFQ1RJT04iLCJKT0JfU1RBVFVTX0NPTExFQ1RJT04iLCJpbmNyZW1lbnRPcCIsIm9iamVjdCIsImtleSIsImFtb3VudCIsIl9fb3AiLCJmbGF0dGVuIiwiYXJyYXkiLCJmbGF0dGVuZWQiLCJpIiwibGVuZ3RoIiwiQXJyYXkiLCJpc0FycmF5IiwiY29uY2F0IiwicHVzaCIsInN0YXR1c0hhbmRsZXIiLCJjbGFzc05hbWUiLCJkYXRhYmFzZSIsImxhc3RQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjcmVhdGUiLCJ0aGVuIiwidXBkYXRlIiwid2hlcmUiLCJPYmplY3QiLCJmcmVlemUiLCJyZXN0U3RhdHVzSGFuZGxlciIsImNvbmZpZyIsImF1dGgiLCJBdXRoIiwibWFzdGVyIiwicmVzdCIsInJlc3BvbnNlIiwiYXNzaWduIiwib2JqZWN0SWQiLCJqb2JTdGF0dXNIYW5kbGVyIiwiam9iU3RhdHVzIiwib2JqZWN0SWRTaXplIiwiaGFuZGxlciIsInNldFJ1bm5pbmciLCJqb2JOYW1lIiwicGFyYW1zIiwibm93IiwiRGF0ZSIsInN0YXR1cyIsInNvdXJjZSIsImNyZWF0ZWRBdCIsIkFDTCIsInNldE1lc3NhZ2UiLCJtZXNzYWdlIiwic2V0U3VjY2VlZGVkIiwic2V0RmluYWxTdGF0dXMiLCJzZXRGYWlsZWQiLCJ1bmRlZmluZWQiLCJmaW5pc2hlZEF0IiwicHVzaFN0YXR1c0hhbmRsZXIiLCJleGlzdGluZ09iamVjdElkIiwicHVzaFN0YXR1cyIsInNldEluaXRpYWwiLCJib2R5Iiwib3B0aW9ucyIsInB1c2hUaW1lIiwidG9JU09TdHJpbmciLCJoYXNPd25Qcm9wZXJ0eSIsImhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0IiwicHVzaF90aW1lIiwibG9nZ2VyIiwid2FybiIsImRhdGEiLCJwYXlsb2FkU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsInB1c2hIYXNoIiwiYWxlcnQiLCJxdWVyeSIsInBheWxvYWQiLCJ0aXRsZSIsImV4cGlyeSIsImV4cGlyYXRpb25fdGltZSIsImV4cGlyYXRpb25faW50ZXJ2YWwiLCJudW1TZW50IiwicmVzdWx0IiwiYmF0Y2hlcyIsInZlcmJvc2UiLCJjb3VudCIsInRyYWNrU2VudCIsInJlc3VsdHMiLCJVVENPZmZzZXQiLCJjbGVhbnVwSW5zdGFsbGF0aW9ucyIsInByb2Nlc3MiLCJlbnYiLCJQQVJTRV9TRVJWRVJfQ0xFQU5VUF9JTlZBTElEX0lOU1RBTExBVElPTlMiLCJudW1GYWlsZWQiLCJkZXZpY2VzVG9SZW1vdmUiLCJyZWR1Y2UiLCJtZW1vIiwiZGV2aWNlIiwiZGV2aWNlVHlwZSIsInRyYW5zbWl0dGVkIiwib2Zmc2V0S2V5IiwiZXJyb3IiLCJkZXZpY2VUb2tlbiIsInRva2VuIiwiZm9yRWFjaCIsImluZm8iLCIkaW4iLCJhY2wiLCJtYW55IiwicmVzIiwiY29tcGxldGUiLCJmYWlsIiwiZXJyIiwiZXJyb3JNZXNzYWdlIiwicnZhbCIsImRlZmluZVByb3BlcnR5IiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLHNCQUFzQixHQUFHLGFBQS9CO0FBQ0EsTUFBTUMscUJBQXFCLEdBQUcsWUFBOUI7O0FBRUEsTUFBTUMsV0FBVyxHQUFHLFVBQVNDLE1BQU0sR0FBRyxFQUFsQixFQUFzQkMsR0FBdEIsRUFBMkJDLE1BQU0sR0FBRyxDQUFwQyxFQUF1QztBQUN6RCxNQUFJLENBQUNGLE1BQU0sQ0FBQ0MsR0FBRCxDQUFYLEVBQWtCO0FBQ2hCRCxJQUFBQSxNQUFNLENBQUNDLEdBQUQsQ0FBTixHQUFjO0FBQUVFLE1BQUFBLElBQUksRUFBRSxXQUFSO0FBQXFCRCxNQUFBQSxNQUFNLEVBQUVBO0FBQTdCLEtBQWQ7QUFDRCxHQUZELE1BRU87QUFDTEYsSUFBQUEsTUFBTSxDQUFDQyxHQUFELENBQU4sQ0FBWUMsTUFBWixJQUFzQkEsTUFBdEI7QUFD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QUEsVUFEVztBQUVYbkIsSUFBQUEsVUFGVztBQUdYOEMsSUFBQUEsU0FIVztBQUlYd0IsSUFBQUEsUUFKVztBQUtYdkYsSUFBQUEsTUFMVztBQU1Yd0YsSUFBQUE7QUFOVyxHQUFiLENBck0wRCxDQThNMUQ7O0FBQ0F0RixFQUFBQSxNQUFNLENBQUMwRixjQUFQLENBQXNCRCxJQUF0QixFQUE0QixVQUE1QixFQUF3QztBQUN0Q0UsSUFBQUEsR0FBRyxFQUFFLE1BQU1qRjtBQUQyQixHQUF4QztBQUlBLFNBQU9WLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjd0YsSUFBZCxDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZDVIYXNoLCBuZXdPYmplY3RJZCB9IGZyb20gJy4vY3J5cHRvVXRpbHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi9yZXN0JztcbmltcG9ydCBBdXRoIGZyb20gJy4vQXV0aCc7XG5cbmNvbnN0IFBVU0hfU1RBVFVTX0NPTExFQ1RJT04gPSAnX1B1c2hTdGF0dXMnO1xuY29uc3QgSk9CX1NUQVRVU19DT0xMRUNUSU9OID0gJ19Kb2JTdGF0dXMnO1xuXG5jb25zdCBpbmNyZW1lbnRPcCA9IGZ1bmN0aW9uKG9iamVjdCA9IHt9LCBrZXksIGFtb3VudCA9IDEpIHtcbiAgaWYgKCFvYmplY3Rba2V5XSkge1xuICAgIG9iamVjdFtrZXldID0geyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiBhbW91bnQgfTtcbiAgfSBlbHNlIHtcbiAgICBvYmplY3Rba2V5XS5hbW91bnQgKz0gYW1vdW50O1xuICB9XG4gIHJldHVybiBvYmplY3Rba2V5XTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBmbGF0dGVuKGFycmF5KSB7XG4gIHZhciBmbGF0dGVuZWQgPSBbXTtcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGFycmF5W2ldKSkge1xuICAgICAgZmxhdHRlbmVkID0gZmxhdHRlbmVkLmNvbmNhdChmbGF0dGVuKGFycmF5W2ldKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZsYXR0ZW5lZC5wdXNoKGFycmF5W2ldKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZsYXR0ZW5lZDtcbn1cblxuZnVuY3Rpb24gc3RhdHVzSGFuZGxlcihjbGFzc05hbWUsIGRhdGFiYXNlKSB7XG4gIGxldCBsYXN0UHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZShvYmplY3QpIHtcbiAgICBsYXN0UHJvbWlzZSA9IGxhc3RQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGRhdGFiYXNlLmNyZWF0ZShjbGFzc05hbWUsIG9iamVjdCkudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob2JqZWN0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBsYXN0UHJvbWlzZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZSh3aGVyZSwgb2JqZWN0KSB7XG4gICAgbGFzdFByb21pc2UgPSBsYXN0UHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBkYXRhYmFzZS51cGRhdGUoY2xhc3NOYW1lLCB3aGVyZSwgb2JqZWN0KTtcbiAgICB9KTtcbiAgICByZXR1cm4gbGFzdFByb21pc2U7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgY3JlYXRlLFxuICAgIHVwZGF0ZSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc3RTdGF0dXNIYW5kbGVyKGNsYXNzTmFtZSwgY29uZmlnKSB7XG4gIGxldCBsYXN0UHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpO1xuICBjb25zdCBhdXRoID0gQXV0aC5tYXN0ZXIoY29uZmlnKTtcbiAgZnVuY3Rpb24gY3JlYXRlKG9iamVjdCkge1xuICAgIGxhc3RQcm9taXNlID0gbGFzdFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gcmVzdFxuICAgICAgICAuY3JlYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCBvYmplY3QpXG4gICAgICAgIC50aGVuKCh7IHJlc3BvbnNlIH0pID0+IHtcbiAgICAgICAgICAvLyBtZXJnZSB0aGUgb2JqZWN0c1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoT2JqZWN0LmFzc2lnbih7fSwgb2JqZWN0LCByZXNwb25zZSkpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gbGFzdFByb21pc2U7XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGUod2hlcmUsIG9iamVjdCkge1xuICAgIC8vIFRPRE86IHdoZW4gd2UgaGF2ZSB1cGRhdGVXaGVyZSwgdXNlIHRoYXQgZm9yIHByb3BlciBpbnRlcmZhY2luZ1xuICAgIGxhc3RQcm9taXNlID0gbGFzdFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gcmVzdFxuICAgICAgICAudXBkYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCB7IG9iamVjdElkOiB3aGVyZS5vYmplY3RJZCB9LCBvYmplY3QpXG4gICAgICAgIC50aGVuKCh7IHJlc3BvbnNlIH0pID0+IHtcbiAgICAgICAgICAvLyBtZXJnZSB0aGUgb2JqZWN0c1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoT2JqZWN0LmFzc2lnbih7fSwgb2JqZWN0LCByZXNwb25zZSkpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gbGFzdFByb21pc2U7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgY3JlYXRlLFxuICAgIHVwZGF0ZSxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2JTdGF0dXNIYW5kbGVyKGNvbmZpZykge1xuICBsZXQgam9iU3RhdHVzO1xuICBjb25zdCBvYmplY3RJZCA9IG5ld09iamVjdElkKGNvbmZpZy5vYmplY3RJZFNpemUpO1xuICBjb25zdCBkYXRhYmFzZSA9IGNvbmZpZy5kYXRhYmFzZTtcbiAgY29uc3QgaGFuZGxlciA9IHN0YXR1c0hhbmRsZXIoSk9CX1NUQVRVU19DT0xMRUNUSU9OLCBkYXRhYmFzZSk7XG4gIGNvbnN0IHNldFJ1bm5pbmcgPSBmdW5jdGlvbihqb2JOYW1lLCBwYXJhbXMpIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGpvYlN0YXR1cyA9IHtcbiAgICAgIG9iamVjdElkLFxuICAgICAgam9iTmFtZSxcbiAgICAgIHBhcmFtcyxcbiAgICAgIHN0YXR1czogJ3J1bm5pbmcnLFxuICAgICAgc291cmNlOiAnYXBpJyxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgLy8gbG9ja2Rvd24hXG4gICAgICBBQ0w6IHt9LFxuICAgIH07XG5cbiAgICByZXR1cm4gaGFuZGxlci5jcmVhdGUoam9iU3RhdHVzKTtcbiAgfTtcblxuICBjb25zdCBzZXRNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgIGlmICghbWVzc2FnZSB8fCB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKHsgb2JqZWN0SWQgfSwgeyBtZXNzYWdlIH0pO1xuICB9O1xuXG4gIGNvbnN0IHNldFN1Y2NlZWRlZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgICByZXR1cm4gc2V0RmluYWxTdGF0dXMoJ3N1Y2NlZWRlZCcsIG1lc3NhZ2UpO1xuICB9O1xuXG4gIGNvbnN0IHNldEZhaWxlZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgICByZXR1cm4gc2V0RmluYWxTdGF0dXMoJ2ZhaWxlZCcsIG1lc3NhZ2UpO1xuICB9O1xuXG4gIGNvbnN0IHNldEZpbmFsU3RhdHVzID0gZnVuY3Rpb24oc3RhdHVzLCBtZXNzYWdlID0gdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgZmluaXNoZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgdXBkYXRlID0geyBzdGF0dXMsIGZpbmlzaGVkQXQgfTtcbiAgICBpZiAobWVzc2FnZSAmJiB0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHVwZGF0ZS5tZXNzYWdlID0gbWVzc2FnZTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKHsgb2JqZWN0SWQgfSwgdXBkYXRlKTtcbiAgfTtcblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgc2V0UnVubmluZyxcbiAgICBzZXRTdWNjZWVkZWQsXG4gICAgc2V0TWVzc2FnZSxcbiAgICBzZXRGYWlsZWQsXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHVzaFN0YXR1c0hhbmRsZXIoY29uZmlnLCBleGlzdGluZ09iamVjdElkKSB7XG4gIGxldCBwdXNoU3RhdHVzO1xuICBjb25zdCBkYXRhYmFzZSA9IGNvbmZpZy5kYXRhYmFzZTtcbiAgY29uc3QgaGFuZGxlciA9IHJlc3RTdGF0dXNIYW5kbGVyKFBVU0hfU1RBVFVTX0NPTExFQ1RJT04sIGNvbmZpZyk7XG4gIGxldCBvYmplY3RJZCA9IGV4aXN0aW5nT2JqZWN0SWQ7XG4gIGNvbnN0IHNldEluaXRpYWwgPSBmdW5jdGlvbihib2R5ID0ge30sIHdoZXJlLCBvcHRpb25zID0geyBzb3VyY2U6ICdyZXN0JyB9KSB7XG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgICBsZXQgcHVzaFRpbWUgPSBub3cudG9JU09TdHJpbmcoKTtcbiAgICBsZXQgc3RhdHVzID0gJ3BlbmRpbmcnO1xuICAgIGlmIChib2R5Lmhhc093blByb3BlcnR5KCdwdXNoX3RpbWUnKSkge1xuICAgICAgaWYgKGNvbmZpZy5oYXNQdXNoU2NoZWR1bGVkU3VwcG9ydCkge1xuICAgICAgICBwdXNoVGltZSA9IGJvZHkucHVzaF90aW1lO1xuICAgICAgICBzdGF0dXMgPSAnc2NoZWR1bGVkJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICAgICdUcnlpbmcgdG8gc2NoZWR1bGUgYSBwdXNoIHdoaWxlIHNlcnZlciBpcyBub3QgY29uZmlndXJlZC4nXG4gICAgICAgICk7XG4gICAgICAgIGxvZ2dlci53YXJuKCdQdXNoIHdpbGwgYmUgc2VudCBpbW1lZGlhdGVseScpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBib2R5LmRhdGEgfHwge307XG4gICAgY29uc3QgcGF5bG9hZFN0cmluZyA9IEpTT04uc3RyaW5naWZ5KGRhdGEpO1xuICAgIGxldCBwdXNoSGFzaDtcbiAgICBpZiAodHlwZW9mIGRhdGEuYWxlcnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBwdXNoSGFzaCA9IG1kNUhhc2goZGF0YS5hbGVydCk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YS5hbGVydCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHB1c2hIYXNoID0gbWQ1SGFzaChKU09OLnN0cmluZ2lmeShkYXRhLmFsZXJ0KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHB1c2hIYXNoID0gJ2Q0MWQ4Y2Q5OGYwMGIyMDRlOTgwMDk5OGVjZjg0MjdlJztcbiAgICB9XG4gICAgY29uc3Qgb2JqZWN0ID0ge1xuICAgICAgcHVzaFRpbWUsXG4gICAgICBxdWVyeTogSlNPTi5zdHJpbmdpZnkod2hlcmUpLFxuICAgICAgcGF5bG9hZDogcGF5bG9hZFN0cmluZyxcbiAgICAgIHNvdXJjZTogb3B0aW9ucy5zb3VyY2UsXG4gICAgICB0aXRsZTogb3B0aW9ucy50aXRsZSxcbiAgICAgIGV4cGlyeTogYm9keS5leHBpcmF0aW9uX3RpbWUsXG4gICAgICBleHBpcmF0aW9uX2ludGVydmFsOiBib2R5LmV4cGlyYXRpb25faW50ZXJ2YWwsXG4gICAgICBzdGF0dXM6IHN0YXR1cyxcbiAgICAgIG51bVNlbnQ6IDAsXG4gICAgICBwdXNoSGFzaCxcbiAgICAgIC8vIGxvY2tkb3duIVxuICAgICAgQUNMOiB7fSxcbiAgICB9O1xuICAgIHJldHVybiBoYW5kbGVyLmNyZWF0ZShvYmplY3QpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIG9iamVjdElkID0gcmVzdWx0Lm9iamVjdElkO1xuICAgICAgcHVzaFN0YXR1cyA9IHtcbiAgICAgICAgb2JqZWN0SWQsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwdXNoU3RhdHVzKTtcbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBzZXRSdW5uaW5nID0gZnVuY3Rpb24oYmF0Y2hlcykge1xuICAgIGxvZ2dlci52ZXJib3NlKFxuICAgICAgYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiBzZW5kaW5nIHB1c2ggdG8gaW5zdGFsbGF0aW9ucyB3aXRoICVkIGJhdGNoZXNgLFxuICAgICAgYmF0Y2hlc1xuICAgICk7XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKFxuICAgICAge1xuICAgICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcbiAgICAgICAgb2JqZWN0SWQ6IG9iamVjdElkLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgc3RhdHVzOiAncnVubmluZycsXG4gICAgICAgIGNvdW50OiBiYXRjaGVzLFxuICAgICAgfVxuICAgICk7XG4gIH07XG5cbiAgY29uc3QgdXBkYXRlID0gZnVuY3Rpb24odXBkYXRlKSB7XG4gICAgbG9nZ2VyLnZlcmJvc2UoYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiB1cGRhdGluZyB2YWx1ZXMgJWpgLCB1cGRhdGUpO1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSk7XG4gIH07XG5cbiAgY29uc3QgdHJhY2tTZW50ID0gZnVuY3Rpb24oXG4gICAgcmVzdWx0cyxcbiAgICBVVENPZmZzZXQsXG4gICAgY2xlYW51cEluc3RhbGxhdGlvbnMgPSBwcm9jZXNzLmVudlxuICAgICAgLlBBUlNFX1NFUlZFUl9DTEVBTlVQX0lOVkFMSURfSU5TVEFMTEFUSU9OU1xuICApIHtcbiAgICBjb25zdCB1cGRhdGUgPSB7XG4gICAgICBudW1TZW50OiAwLFxuICAgICAgbnVtRmFpbGVkOiAwLFxuICAgIH07XG4gICAgY29uc3QgZGV2aWNlc1RvUmVtb3ZlID0gW107XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0cykpIHtcbiAgICAgIHJlc3VsdHMgPSBmbGF0dGVuKHJlc3VsdHMpO1xuICAgICAgcmVzdWx0cy5yZWR1Y2UoKG1lbW8sIHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyBDYW5ub3QgaGFuZGxlIHRoYXRcbiAgICAgICAgaWYgKCFyZXN1bHQgfHwgIXJlc3VsdC5kZXZpY2UgfHwgIXJlc3VsdC5kZXZpY2UuZGV2aWNlVHlwZSkge1xuICAgICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRldmljZVR5cGUgPSByZXN1bHQuZGV2aWNlLmRldmljZVR5cGU7XG4gICAgICAgIGNvbnN0IGtleSA9IHJlc3VsdC50cmFuc21pdHRlZFxuICAgICAgICAgID8gYHNlbnRQZXJUeXBlLiR7ZGV2aWNlVHlwZX1gXG4gICAgICAgICAgOiBgZmFpbGVkUGVyVHlwZS4ke2RldmljZVR5cGV9YDtcbiAgICAgICAgbWVtb1trZXldID0gaW5jcmVtZW50T3AobWVtbywga2V5KTtcbiAgICAgICAgaWYgKHR5cGVvZiBVVENPZmZzZXQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgY29uc3Qgb2Zmc2V0S2V5ID0gcmVzdWx0LnRyYW5zbWl0dGVkXG4gICAgICAgICAgICA/IGBzZW50UGVyVVRDT2Zmc2V0LiR7VVRDT2Zmc2V0fWBcbiAgICAgICAgICAgIDogYGZhaWxlZFBlclVUQ09mZnNldC4ke1VUQ09mZnNldH1gO1xuICAgICAgICAgIG1lbW9bb2Zmc2V0S2V5XSA9IGluY3JlbWVudE9wKG1lbW8sIG9mZnNldEtleSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdC50cmFuc21pdHRlZCkge1xuICAgICAgICAgIG1lbW8ubnVtU2VudCsrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHJlc3VsdCAmJlxuICAgICAgICAgICAgcmVzdWx0LnJlc3BvbnNlICYmXG4gICAgICAgICAgICByZXN1bHQucmVzcG9uc2UuZXJyb3IgJiZcbiAgICAgICAgICAgIHJlc3VsdC5kZXZpY2UgJiZcbiAgICAgICAgICAgIHJlc3VsdC5kZXZpY2UuZGV2aWNlVG9rZW5cbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gcmVzdWx0LmRldmljZS5kZXZpY2VUb2tlbjtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gcmVzdWx0LnJlc3BvbnNlLmVycm9yO1xuICAgICAgICAgICAgLy8gR0NNIGVycm9yc1xuICAgICAgICAgICAgaWYgKGVycm9yID09PSAnTm90UmVnaXN0ZXJlZCcgfHwgZXJyb3IgPT09ICdJbnZhbGlkUmVnaXN0cmF0aW9uJykge1xuICAgICAgICAgICAgICBkZXZpY2VzVG9SZW1vdmUucHVzaCh0b2tlbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBBUE5TIGVycm9yc1xuICAgICAgICAgICAgaWYgKGVycm9yID09PSAnVW5yZWdpc3RlcmVkJyB8fCBlcnJvciA9PT0gJ0JhZERldmljZVRva2VuJykge1xuICAgICAgICAgICAgICBkZXZpY2VzVG9SZW1vdmUucHVzaCh0b2tlbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIG1lbW8ubnVtRmFpbGVkKys7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICB9LCB1cGRhdGUpO1xuICAgIH1cblxuICAgIGxvZ2dlci52ZXJib3NlKFxuICAgICAgYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiBzZW50IHB1c2ghICVkIHN1Y2Nlc3MsICVkIGZhaWx1cmVzYCxcbiAgICAgIHVwZGF0ZS5udW1TZW50LFxuICAgICAgdXBkYXRlLm51bUZhaWxlZFxuICAgICk7XG4gICAgbG9nZ2VyLnZlcmJvc2UoYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiBuZWVkcyBjbGVhbnVwYCwge1xuICAgICAgZGV2aWNlc1RvUmVtb3ZlLFxuICAgIH0pO1xuICAgIFsnbnVtU2VudCcsICdudW1GYWlsZWQnXS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAodXBkYXRlW2tleV0gPiAwKSB7XG4gICAgICAgIHVwZGF0ZVtrZXldID0ge1xuICAgICAgICAgIF9fb3A6ICdJbmNyZW1lbnQnLFxuICAgICAgICAgIGFtb3VudDogdXBkYXRlW2tleV0sXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkZWxldGUgdXBkYXRlW2tleV07XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBpZiAoZGV2aWNlc1RvUmVtb3ZlLmxlbmd0aCA+IDAgJiYgY2xlYW51cEluc3RhbGxhdGlvbnMpIHtcbiAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICBgUmVtb3ZpbmcgZGV2aWNlIHRva2VucyBvbiAke2RldmljZXNUb1JlbW92ZS5sZW5ndGh9IF9JbnN0YWxsYXRpb25zYFxuICAgICAgKTtcbiAgICAgIGRhdGFiYXNlLnVwZGF0ZShcbiAgICAgICAgJ19JbnN0YWxsYXRpb24nLFxuICAgICAgICB7IGRldmljZVRva2VuOiB7ICRpbjogZGV2aWNlc1RvUmVtb3ZlIH0gfSxcbiAgICAgICAgeyBkZXZpY2VUb2tlbjogeyBfX29wOiAnRGVsZXRlJyB9IH0sXG4gICAgICAgIHtcbiAgICAgICAgICBhY2w6IHVuZGVmaW5lZCxcbiAgICAgICAgICBtYW55OiB0cnVlLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGluZGljYXRlIHRoaXMgYmF0Y2ggaXMgY29tcGxldGVcbiAgICBpbmNyZW1lbnRPcCh1cGRhdGUsICdjb3VudCcsIC0xKTtcblxuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSkudGhlbihyZXMgPT4ge1xuICAgICAgaWYgKHJlcyAmJiByZXMuY291bnQgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29tcGxldGUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxuICBjb25zdCBjb21wbGV0ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZShcbiAgICAgIHsgb2JqZWN0SWQgfSxcbiAgICAgIHtcbiAgICAgICAgc3RhdHVzOiAnc3VjY2VlZGVkJyxcbiAgICAgICAgY291bnQ6IHsgX19vcDogJ0RlbGV0ZScgfSxcbiAgICAgIH1cbiAgICApO1xuICB9O1xuXG4gIGNvbnN0IGZhaWwgPSBmdW5jdGlvbihlcnIpIHtcbiAgICBpZiAodHlwZW9mIGVyciA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVyciA9IHsgbWVzc2FnZTogZXJyIH07XG4gICAgfVxuICAgIGNvbnN0IHVwZGF0ZSA9IHtcbiAgICAgIGVycm9yTWVzc2FnZTogZXJyLFxuICAgICAgc3RhdHVzOiAnZmFpbGVkJyxcbiAgICB9O1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSk7XG4gIH07XG5cbiAgY29uc3QgcnZhbCA9IHtcbiAgICBzZXRJbml0aWFsLFxuICAgIHNldFJ1bm5pbmcsXG4gICAgdHJhY2tTZW50LFxuICAgIGNvbXBsZXRlLFxuICAgIHVwZGF0ZSxcbiAgICBmYWlsLFxuICB9O1xuXG4gIC8vIGRlZmluZSBvYmplY3RJZCB0byBiZSBkeW5hbWljXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShydmFsLCAnb2JqZWN0SWQnLCB7XG4gICAgZ2V0OiAoKSA9PiBvYmplY3RJZCxcbiAgfSk7XG5cbiAgcmV0dXJuIE9iamVjdC5mcmVlemUocnZhbCk7XG59XG4iXX0=