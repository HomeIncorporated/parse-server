"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PushController = void 0;

var _node = require("parse/node");

var _RestQuery = _interopRequireDefault(require("../RestQuery"));

var _RestWrite = _interopRequireDefault(require("../RestWrite"));

var _Auth = require("../Auth");

var _StatusHandler = require("../StatusHandler");

var _utils = require("../Push/utils");

var _logger = require("../logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class PushController {
  sendPush(body = {}, where = {}, config, auth, onPushStatusSaved = () => {}, now = new Date()) {
    if (!config.hasPushSupport) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Missing push configuration');
    } // Replace the expiration_time and push_time with a valid Unix epoch milliseconds time


    body.expiration_time = PushController.getExpirationTime(body);
    body.expiration_interval = PushController.getExpirationInterval(body);

    if (body.expiration_time && body.expiration_interval) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Both expiration_time and expiration_interval cannot be set');
    } // Immediate push


    if (body.expiration_interval && !body.hasOwnProperty('push_time')) {
      const ttlMs = body.expiration_interval * 1000;
      body.expiration_time = new Date(now.valueOf() + ttlMs).valueOf();
    }

    const pushTime = PushController.getPushTime(body);

    if (pushTime && pushTime.date !== 'undefined') {
      body['push_time'] = PushController.formatPushTime(pushTime);
    } // TODO: If the req can pass the checking, we return immediately instead of waiting
    // pushes to be sent. We probably change this behaviour in the future.


    let badgeUpdate = () => {
      return Promise.resolve();
    };

    if (body.data && body.data.badge) {
      const badge = body.data.badge;
      let restUpdate = {};

      if (typeof badge == 'string' && badge.toLowerCase() === 'increment') {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: 1
          }
        };
      } else if (typeof badge == 'object' && typeof badge.__op == 'string' && badge.__op.toLowerCase() == 'increment' && Number(badge.amount)) {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: badge.amount
          }
        };
      } else if (Number(badge)) {
        restUpdate = {
          badge: badge
        };
      } else {
        throw "Invalid value for badge, expected number or 'Increment' or {increment: number}";
      } // Force filtering on only valid device tokens


      const updateWhere = (0, _utils.applyDeviceTokenExists)(where);

      badgeUpdate = () => {
        // Build a real RestQuery so we can use it in RestWrite
        const restQuery = new _RestQuery.default(config, (0, _Auth.master)(config), '_Installation', updateWhere);
        return restQuery.buildRestWhere().then(() => {
          const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Installation', restQuery.restWhere, restUpdate);
          write.runOptions.many = true;
          return write.execute();
        });
      };
    }

    const pushStatus = (0, _StatusHandler.pushStatusHandler)(config);
    return Promise.resolve().then(() => {
      return pushStatus.setInitial(body, where);
    }).then(() => {
      onPushStatusSaved(pushStatus.objectId);
      return badgeUpdate().catch(err => {
        // add this to ignore badge update errors as default
        if (config.stopOnBadgeUpdateError) throw err;

        _logger.logger.info(`Badge update error will be ignored for push status ${pushStatus.objectId}`);

        _logger.logger.info(err && err.stack && err.stack.toString() || err && err.message || err.toString());

        return Promise.resolve();
      });
    }).then(() => {
      // Update audience lastUsed and timesUsed
      if (body.audience_id) {
        const audienceId = body.audience_id;
        var updateAudience = {
          lastUsed: {
            __type: 'Date',
            iso: new Date().toISOString()
          },
          timesUsed: {
            __op: 'Increment',
            amount: 1
          }
        };
        const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Audience', {
          objectId: audienceId
        }, updateAudience);
        write.execute();
      } // Don't wait for the audience update promise to resolve.


      return Promise.resolve();
    }).then(() => {
      if (body.hasOwnProperty('push_time') && config.hasPushScheduledSupport) {
        return Promise.resolve();
      }

      return config.pushControllerQueue.enqueue(body, where, config, auth, pushStatus);
    }).catch(err => {
      return pushStatus.fail(err).then(() => {
        throw err;
      });
    });
  }
  /**
   * Get expiration time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The expiration time if it exists in the request
   */


  static getExpirationTime(body = {}) {
    var hasExpirationTime = body.hasOwnProperty('expiration_time');

    if (!hasExpirationTime) {
      return;
    }

    var expirationTimeParam = body['expiration_time'];
    var expirationTime;

    if (typeof expirationTimeParam === 'number') {
      expirationTime = new Date(expirationTimeParam * 1000);
    } else if (typeof expirationTimeParam === 'string') {
      expirationTime = new Date(expirationTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    } // Check expirationTime is valid or not, if it is not valid, expirationTime is NaN


    if (!isFinite(expirationTime)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }

    return expirationTime.valueOf();
  }

  static getExpirationInterval(body = {}) {
    const hasExpirationInterval = body.hasOwnProperty('expiration_interval');

    if (!hasExpirationInterval) {
      return;
    }

    var expirationIntervalParam = body['expiration_interval'];

    if (typeof expirationIntervalParam !== 'number' || expirationIntervalParam <= 0) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, `expiration_interval must be a number greater than 0`);
    }

    return expirationIntervalParam;
  }
  /**
   * Get push time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The push time if it exists in the request
   */


  static getPushTime(body = {}) {
    var hasPushTime = body.hasOwnProperty('push_time');

    if (!hasPushTime) {
      return;
    }

    var pushTimeParam = body['push_time'];
    var date;
    var isLocalTime = true;

    if (typeof pushTimeParam === 'number') {
      date = new Date(pushTimeParam * 1000);
    } else if (typeof pushTimeParam === 'string') {
      isLocalTime = !PushController.pushTimeHasTimezoneComponent(pushTimeParam);
      date = new Date(pushTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    } // Check pushTime is valid or not, if it is not valid, pushTime is NaN


    if (!isFinite(date)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }

    return {
      date,
      isLocalTime
    };
  }
  /**
   * Checks if a ISO8601 formatted date contains a timezone component
   * @param pushTimeParam {string}
   * @returns {boolean}
   */


  static pushTimeHasTimezoneComponent(pushTimeParam) {
    const offsetPattern = /(.+)([+-])\d\d:\d\d$/;
    return pushTimeParam.indexOf('Z') === pushTimeParam.length - 1 || // 2007-04-05T12:30Z
    offsetPattern.test(pushTimeParam); // 2007-04-05T12:30.000+02:00, 2007-04-05T12:30.000-02:00
  }
  /**
   * Converts a date to ISO format in UTC time and strips the timezone if `isLocalTime` is true
   * @param date {Date}
   * @param isLocalTime {boolean}
   * @returns {string}
   */


  static formatPushTime({
    date,
    isLocalTime
  }) {
    if (isLocalTime) {
      // Strip 'Z'
      const isoString = date.toISOString();
      return isoString.substring(0, isoString.indexOf('Z'));
    }

    return date.toISOString();
  }

}

exports.PushController = PushController;
var _default = PushController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db250cm9sbGVycy9QdXNoQ29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJQdXNoQ29udHJvbGxlciIsInNlbmRQdXNoIiwiYm9keSIsIndoZXJlIiwiY29uZmlnIiwiYXV0aCIsIm9uUHVzaFN0YXR1c1NhdmVkIiwibm93IiwiRGF0ZSIsImhhc1B1c2hTdXBwb3J0IiwiUGFyc2UiLCJFcnJvciIsIlBVU0hfTUlTQ09ORklHVVJFRCIsImV4cGlyYXRpb25fdGltZSIsImdldEV4cGlyYXRpb25UaW1lIiwiZXhwaXJhdGlvbl9pbnRlcnZhbCIsImdldEV4cGlyYXRpb25JbnRlcnZhbCIsImhhc093blByb3BlcnR5IiwidHRsTXMiLCJ2YWx1ZU9mIiwicHVzaFRpbWUiLCJnZXRQdXNoVGltZSIsImRhdGUiLCJmb3JtYXRQdXNoVGltZSIsImJhZGdlVXBkYXRlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJkYXRhIiwiYmFkZ2UiLCJyZXN0VXBkYXRlIiwidG9Mb3dlckNhc2UiLCJfX29wIiwiYW1vdW50IiwiTnVtYmVyIiwidXBkYXRlV2hlcmUiLCJyZXN0UXVlcnkiLCJSZXN0UXVlcnkiLCJidWlsZFJlc3RXaGVyZSIsInRoZW4iLCJ3cml0ZSIsIlJlc3RXcml0ZSIsInJlc3RXaGVyZSIsInJ1bk9wdGlvbnMiLCJtYW55IiwiZXhlY3V0ZSIsInB1c2hTdGF0dXMiLCJzZXRJbml0aWFsIiwib2JqZWN0SWQiLCJjYXRjaCIsImVyciIsInN0b3BPbkJhZGdlVXBkYXRlRXJyb3IiLCJsb2dnZXIiLCJpbmZvIiwic3RhY2siLCJ0b1N0cmluZyIsIm1lc3NhZ2UiLCJhdWRpZW5jZV9pZCIsImF1ZGllbmNlSWQiLCJ1cGRhdGVBdWRpZW5jZSIsImxhc3RVc2VkIiwiX190eXBlIiwiaXNvIiwidG9JU09TdHJpbmciLCJ0aW1lc1VzZWQiLCJoYXNQdXNoU2NoZWR1bGVkU3VwcG9ydCIsInB1c2hDb250cm9sbGVyUXVldWUiLCJlbnF1ZXVlIiwiZmFpbCIsImhhc0V4cGlyYXRpb25UaW1lIiwiZXhwaXJhdGlvblRpbWVQYXJhbSIsImV4cGlyYXRpb25UaW1lIiwiaXNGaW5pdGUiLCJoYXNFeHBpcmF0aW9uSW50ZXJ2YWwiLCJleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSIsImhhc1B1c2hUaW1lIiwicHVzaFRpbWVQYXJhbSIsImlzTG9jYWxUaW1lIiwicHVzaFRpbWVIYXNUaW1lem9uZUNvbXBvbmVudCIsIm9mZnNldFBhdHRlcm4iLCJpbmRleE9mIiwibGVuZ3RoIiwidGVzdCIsImlzb1N0cmluZyIsInN1YnN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRU8sTUFBTUEsY0FBTixDQUFxQjtBQUMxQkMsRUFBQUEsUUFBUSxDQUNOQyxJQUFJLEdBQUcsRUFERCxFQUVOQyxLQUFLLEdBQUcsRUFGRixFQUdOQyxNQUhNLEVBSU5DLElBSk0sRUFLTkMsaUJBQWlCLEdBQUcsTUFBTSxDQUFFLENBTHRCLEVBTU5DLEdBQUcsR0FBRyxJQUFJQyxJQUFKLEVBTkEsRUFPTjtBQUNBLFFBQUksQ0FBQ0osTUFBTSxDQUFDSyxjQUFaLEVBQTRCO0FBQzFCLFlBQU0sSUFBSUMsWUFBTUMsS0FBVixDQUNKRCxZQUFNQyxLQUFOLENBQVlDLGtCQURSLEVBRUosNEJBRkksQ0FBTjtBQUlELEtBTkQsQ0FRQTs7O0FBQ0FWLElBQUFBLElBQUksQ0FBQ1csZUFBTCxHQUF1QmIsY0FBYyxDQUFDYyxpQkFBZixDQUFpQ1osSUFBakMsQ0FBdkI7QUFDQUEsSUFBQUEsSUFBSSxDQUFDYSxtQkFBTCxHQUEyQmYsY0FBYyxDQUFDZ0IscUJBQWYsQ0FBcUNkLElBQXJDLENBQTNCOztBQUNBLFFBQUlBLElBQUksQ0FBQ1csZUFBTCxJQUF3QlgsSUFBSSxDQUFDYSxtQkFBakMsRUFBc0Q7QUFDcEQsWUFBTSxJQUFJTCxZQUFNQyxLQUFWLENBQ0pELFlBQU1DLEtBQU4sQ0FBWUMsa0JBRFIsRUFFSiw0REFGSSxDQUFO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YSxHQUFHLHNCQUF0QjtBQUNBLFdBQ0VILGFBQWEsQ0FBQ0ksT0FBZCxDQUFzQixHQUF0QixNQUErQkosYUFBYSxDQUFDSyxNQUFkLEdBQXVCLENBQXRELElBQTJEO0FBQzNERixJQUFBQSxhQUFhLENBQUNHLElBQWQsQ0FBbUJOLGFBQW5CLENBRkYsQ0FGa0UsQ0FLL0Q7QUFDSjtBQUVEOzs7Ozs7OztBQU1BLFNBQU9wRCxjQUFQLENBQXNCO0FBQ3BCRCxJQUFBQSxJQURvQjtBQUVwQnNELElBQUFBO0FBRm9CLEdBQXRCLEVBTUc7QUFDRCxRQUFJQSxXQUFKLEVBQWlCO0FBQ2Y7QUFDQSxZQUFNTSxTQUFTLEdBQUc1RCxJQUFJLENBQUN3QyxXQUFMLEVBQWxCO0FBQ0EsYUFBT29CLFNBQVMsQ0FBQ0MsU0FBVixDQUFvQixDQUFwQixFQUF1QkQsU0FBUyxDQUFDSCxPQUFWLENBQWtCLEdBQWxCLENBQXZCLENBQVA7QUFDRDs7QUFDRCxXQUFPekQsSUFBSSxDQUFDd0MsV0FBTCxFQUFQO0FBQ0Q7O0FBeFF5Qjs7O2VBMlFiOUQsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcnNlIH0gZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgUmVzdFF1ZXJ5IGZyb20gJy4uL1Jlc3RRdWVyeSc7XG5pbXBvcnQgUmVzdFdyaXRlIGZyb20gJy4uL1Jlc3RXcml0ZSc7XG5pbXBvcnQgeyBtYXN0ZXIgfSBmcm9tICcuLi9BdXRoJztcbmltcG9ydCB7IHB1c2hTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgeyBhcHBseURldmljZVRva2VuRXhpc3RzIH0gZnJvbSAnLi4vUHVzaC91dGlscyc7XG5pbXBvcnQgeyBsb2dnZXIgfSAgICAgICAgICAgICAgIGZyb20gJy4uL2xvZ2dlcic7XG5cbmV4cG9ydCBjbGFzcyBQdXNoQ29udHJvbGxlciB7XG4gIHNlbmRQdXNoKFxuICAgIGJvZHkgPSB7fSxcbiAgICB3aGVyZSA9IHt9LFxuICAgIGNvbmZpZyxcbiAgICBhdXRoLFxuICAgIG9uUHVzaFN0YXR1c1NhdmVkID0gKCkgPT4ge30sXG4gICAgbm93ID0gbmV3IERhdGUoKVxuICApIHtcbiAgICBpZiAoIWNvbmZpZy5oYXNQdXNoU3VwcG9ydCkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgICdNaXNzaW5nIHB1c2ggY29uZmlndXJhdGlvbidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gUmVwbGFjZSB0aGUgZXhwaXJhdGlvbl90aW1lIGFuZCBwdXNoX3RpbWUgd2l0aCBhIHZhbGlkIFVuaXggZXBvY2ggbWlsbGlzZWNvbmRzIHRpbWVcbiAgICBib2R5LmV4cGlyYXRpb25fdGltZSA9IFB1c2hDb250cm9sbGVyLmdldEV4cGlyYXRpb25UaW1lKGJvZHkpO1xuICAgIGJvZHkuZXhwaXJhdGlvbl9pbnRlcnZhbCA9IFB1c2hDb250cm9sbGVyLmdldEV4cGlyYXRpb25JbnRlcnZhbChib2R5KTtcbiAgICBpZiAoYm9keS5leHBpcmF0aW9uX3RpbWUgJiYgYm9keS5leHBpcmF0aW9uX2ludGVydmFsKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgJ0JvdGggZXhwaXJhdGlvbl90aW1lIGFuZCBleHBpcmF0aW9uX2ludGVydmFsIGNhbm5vdCBiZSBzZXQnXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEltbWVkaWF0ZSBwdXNoXG4gICAgaWYgKGJvZHkuZXhwaXJhdGlvbl9pbnRlcnZhbCAmJiAhYm9keS5oYXNPd25Qcm9wZXJ0eSgncHVzaF90aW1lJykpIHtcbiAgICAgIGNvbnN0IHR0bE1zID0gYm9keS5leHBpcmF0aW9uX2ludGVydmFsICogMTAwMDtcbiAgICAgIGJvZHkuZXhwaXJhdGlvbl90aW1lID0gbmV3IERhdGUobm93LnZhbHVlT2YoKSArIHR0bE1zKS52YWx1ZU9mKCk7XG4gICAgfVxuXG4gICAgY29uc3QgcHVzaFRpbWUgPSBQdXNoQ29udHJvbGxlci5nZXRQdXNoVGltZShib2R5KTtcbiAgICBpZiAocHVzaFRpbWUgJiYgcHVzaFRpbWUuZGF0ZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGJvZHlbJ3B1c2hfdGltZSddID0gUHVzaENvbnRyb2xsZXIuZm9ybWF0UHVzaFRpbWUocHVzaFRpbWUpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IElmIHRoZSByZXEgY2FuIHBhc3MgdGhlIGNoZWNraW5nLCB3ZSByZXR1cm4gaW1tZWRpYXRlbHkgaW5zdGVhZCBvZiB3YWl0aW5nXG4gICAgLy8gcHVzaGVzIHRvIGJlIHNlbnQuIFdlIHByb2JhYmx5IGNoYW5nZSB0aGlzIGJlaGF2aW91ciBpbiB0aGUgZnV0dXJlLlxuICAgIGxldCBiYWRnZVVwZGF0ZSA9ICgpID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9O1xuXG4gICAgaWYgKGJvZHkuZGF0YSAmJiBib2R5LmRhdGEuYmFkZ2UpIHtcbiAgICAgIGNvbnN0IGJhZGdlID0gYm9keS5kYXRhLmJhZGdlO1xuICAgICAgbGV0IHJlc3RVcGRhdGUgPSB7fTtcbiAgICAgIGlmICh0eXBlb2YgYmFkZ2UgPT0gJ3N0cmluZycgJiYgYmFkZ2UudG9Mb3dlckNhc2UoKSA9PT0gJ2luY3JlbWVudCcpIHtcbiAgICAgICAgcmVzdFVwZGF0ZSA9IHsgYmFkZ2U6IHsgX19vcDogJ0luY3JlbWVudCcsIGFtb3VudDogMSB9IH07XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB0eXBlb2YgYmFkZ2UgPT0gJ29iamVjdCcgJiZcbiAgICAgICAgdHlwZW9mIGJhZGdlLl9fb3AgPT0gJ3N0cmluZycgJiZcbiAgICAgICAgYmFkZ2UuX19vcC50b0xvd2VyQ2FzZSgpID09ICdpbmNyZW1lbnQnICYmXG4gICAgICAgIE51bWJlcihiYWRnZS5hbW91bnQpXG4gICAgICApIHtcbiAgICAgICAgcmVzdFVwZGF0ZSA9IHsgYmFkZ2U6IHsgX19vcDogJ0luY3JlbWVudCcsIGFtb3VudDogYmFkZ2UuYW1vdW50IH0gfTtcbiAgICAgIH0gZWxzZSBpZiAoTnVtYmVyKGJhZGdlKSkge1xuICAgICAgICByZXN0VXBkYXRlID0geyBiYWRnZTogYmFkZ2UgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IFwiSW52YWxpZCB2YWx1ZSBmb3IgYmFkZ2UsIGV4cGVjdGVkIG51bWJlciBvciAnSW5jcmVtZW50JyBvciB7aW5jcmVtZW50OiBudW1iZXJ9XCI7XG4gICAgICB9XG5cbiAgICAgIC8vIEZvcmNlIGZpbHRlcmluZyBvbiBvbmx5IHZhbGlkIGRldmljZSB0b2tlbnNcbiAgICAgIGNvbnN0IHVwZGF0ZVdoZXJlID0gYXBwbHlEZXZpY2VUb2tlbkV4aXN0cyh3aGVyZSk7XG4gICAgICBiYWRnZVVwZGF0ZSA9ICgpID0+IHtcbiAgICAgICAgLy8gQnVpbGQgYSByZWFsIFJlc3RRdWVyeSBzbyB3ZSBjYW4gdXNlIGl0IGluIFJlc3RXcml0ZVxuICAgICAgICBjb25zdCByZXN0UXVlcnkgPSBuZXcgUmVzdFF1ZXJ5KFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBtYXN0ZXIoY29uZmlnKSxcbiAgICAgICAgICAnX0luc3RhbGxhdGlvbicsXG4gICAgICAgICAgdXBkYXRlV2hlcmVcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHJlc3RRdWVyeS5idWlsZFJlc3RXaGVyZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHdyaXRlID0gbmV3IFJlc3RXcml0ZShcbiAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgIG1hc3Rlcihjb25maWcpLFxuICAgICAgICAgICAgJ19JbnN0YWxsYXRpb24nLFxuICAgICAgICAgICAgcmVzdFF1ZXJ5LnJlc3RXaGVyZSxcbiAgICAgICAgICAgIHJlc3RVcGRhdGVcbiAgICAgICAgICApO1xuICAgICAgICAgIHdyaXRlLnJ1bk9wdGlvbnMubWFueSA9IHRydWU7XG4gICAgICAgICAgcmV0dXJuIHdyaXRlLmV4ZWN1dGUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgIH1cbiAgICBjb25zdCBwdXNoU3RhdHVzID0gcHVzaFN0YXR1c0hhbmRsZXIoY29uZmlnKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHB1c2hTdGF0dXMuc2V0SW5pdGlhbChib2R5LCB3aGVyZSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBvblB1c2hTdGF0dXNTYXZlZChwdXNoU3RhdHVzLm9iamVjdElkKTtcbiAgICAgICAgcmV0dXJuIGJhZGdlVXBkYXRlKCkuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAvLyBhZGQgdGhpcyB0byBpZ25vcmUgYmFkZ2UgdXBkYXRlIGVycm9ycyBhcyBkZWZhdWx0XG4gICAgICAgICAgaWYgKGNvbmZpZy5zdG9wT25CYWRnZVVwZGF0ZUVycm9yKSB0aHJvdyBlcnI7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oYEJhZGdlIHVwZGF0ZSBlcnJvciB3aWxsIGJlIGlnbm9yZWQgZm9yIHB1c2ggc3RhdHVzICR7cHVzaFN0YXR1cy5vYmplY3RJZH1gKTtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhlcnIgJiYgZXJyLnN0YWNrICYmIGVyci5zdGFjay50b1N0cmluZygpIHx8IGVyciAmJiBlcnIubWVzc2FnZSB8fCBlcnIudG9TdHJpbmcoKSk7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIC8vIFVwZGF0ZSBhdWRpZW5jZSBsYXN0VXNlZCBhbmQgdGltZXNVc2VkXG4gICAgICAgIGlmIChib2R5LmF1ZGllbmNlX2lkKSB7XG4gICAgICAgICAgY29uc3QgYXVkaWVuY2VJZCA9IGJvZHkuYXVkaWVuY2VfaWQ7XG5cbiAgICAgICAgICB2YXIgdXBkYXRlQXVkaWVuY2UgPSB7XG4gICAgICAgICAgICBsYXN0VXNlZDogeyBfX3R5cGU6ICdEYXRlJywgaXNvOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSxcbiAgICAgICAgICAgIHRpbWVzVXNlZDogeyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiAxIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgICBjb25zdCB3cml0ZSA9IG5ldyBSZXN0V3JpdGUoXG4gICAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgICBtYXN0ZXIoY29uZmlnKSxcbiAgICAgICAgICAgICdfQXVkaWVuY2UnLFxuICAgICAgICAgICAgeyBvYmplY3RJZDogYXVkaWVuY2VJZCB9LFxuICAgICAgICAgICAgdXBkYXRlQXVkaWVuY2VcbiAgICAgICAgICApO1xuICAgICAgICAgIHdyaXRlLmV4ZWN1dGUoKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBEb24ndCB3YWl0IGZvciB0aGUgYXVkaWVuY2UgdXBkYXRlIHByb21pc2UgdG8gcmVzb2x2ZS5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGJvZHkuaGFzT3duUHJvcGVydHkoJ3B1c2hfdGltZScpICYmXG4gICAgICAgICAgY29uZmlnLmhhc1B1c2hTY2hlZHVsZWRTdXBwb3J0XG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29uZmlnLnB1c2hDb250cm9sbGVyUXVldWUuZW5xdWV1ZShcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIHdoZXJlLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIHB1c2hTdGF0dXNcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgcmV0dXJuIHB1c2hTdGF0dXMuZmFpbChlcnIpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZXhwaXJhdGlvbiB0aW1lIGZyb20gdGhlIHJlcXVlc3QgYm9keS5cbiAgICogQHBhcmFtIHtPYmplY3R9IHJlcXVlc3QgQSByZXF1ZXN0IG9iamVjdFxuICAgKiBAcmV0dXJucyB7TnVtYmVyfHVuZGVmaW5lZH0gVGhlIGV4cGlyYXRpb24gdGltZSBpZiBpdCBleGlzdHMgaW4gdGhlIHJlcXVlc3RcbiAgICovXG4gIHN0YXRpYyBnZXRFeHBpcmF0aW9uVGltZShib2R5ID0ge30pIHtcbiAgICB2YXIgaGFzRXhwaXJhdGlvblRpbWUgPSBib2R5Lmhhc093blByb3BlcnR5KCdleHBpcmF0aW9uX3RpbWUnKTtcbiAgICBpZiAoIWhhc0V4cGlyYXRpb25UaW1lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBleHBpcmF0aW9uVGltZVBhcmFtID0gYm9keVsnZXhwaXJhdGlvbl90aW1lJ107XG4gICAgdmFyIGV4cGlyYXRpb25UaW1lO1xuICAgIGlmICh0eXBlb2YgZXhwaXJhdGlvblRpbWVQYXJhbSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGV4cGlyYXRpb25UaW1lID0gbmV3IERhdGUoZXhwaXJhdGlvblRpbWVQYXJhbSAqIDEwMDApO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cGlyYXRpb25UaW1lUGFyYW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICBleHBpcmF0aW9uVGltZSA9IG5ldyBEYXRlKGV4cGlyYXRpb25UaW1lUGFyYW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgYm9keVsnZXhwaXJhdGlvbl90aW1lJ10gKyAnIGlzIG5vdCB2YWxpZCB0aW1lLidcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIENoZWNrIGV4cGlyYXRpb25UaW1lIGlzIHZhbGlkIG9yIG5vdCwgaWYgaXQgaXMgbm90IHZhbGlkLCBleHBpcmF0aW9uVGltZSBpcyBOYU5cbiAgICBpZiAoIWlzRmluaXRlKGV4cGlyYXRpb25UaW1lKSkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ2V4cGlyYXRpb25fdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZXhwaXJhdGlvblRpbWUudmFsdWVPZigpO1xuICB9XG5cbiAgc3RhdGljIGdldEV4cGlyYXRpb25JbnRlcnZhbChib2R5ID0ge30pIHtcbiAgICBjb25zdCBoYXNFeHBpcmF0aW9uSW50ZXJ2YWwgPSBib2R5Lmhhc093blByb3BlcnR5KCdleHBpcmF0aW9uX2ludGVydmFsJyk7XG4gICAgaWYgKCFoYXNFeHBpcmF0aW9uSW50ZXJ2YWwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgZXhwaXJhdGlvbkludGVydmFsUGFyYW0gPSBib2R5WydleHBpcmF0aW9uX2ludGVydmFsJ107XG4gICAgaWYgKFxuICAgICAgdHlwZW9mIGV4cGlyYXRpb25JbnRlcnZhbFBhcmFtICE9PSAnbnVtYmVyJyB8fFxuICAgICAgZXhwaXJhdGlvbkludGVydmFsUGFyYW0gPD0gMFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGBleHBpcmF0aW9uX2ludGVydmFsIG11c3QgYmUgYSBudW1iZXIgZ3JlYXRlciB0aGFuIDBgXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZXhwaXJhdGlvbkludGVydmFsUGFyYW07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHB1c2ggdGltZSBmcm9tIHRoZSByZXF1ZXN0IGJvZHkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IEEgcmVxdWVzdCBvYmplY3RcbiAgICogQHJldHVybnMge051bWJlcnx1bmRlZmluZWR9IFRoZSBwdXNoIHRpbWUgaWYgaXQgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gICAqL1xuICBzdGF0aWMgZ2V0UHVzaFRpbWUoYm9keSA9IHt9KSB7XG4gICAgdmFyIGhhc1B1c2hUaW1lID0gYm9keS5oYXNPd25Qcm9wZXJ0eSgncHVzaF90aW1lJyk7XG4gICAgaWYgKCFoYXNQdXNoVGltZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgcHVzaFRpbWVQYXJhbSA9IGJvZHlbJ3B1c2hfdGltZSddO1xuICAgIHZhciBkYXRlO1xuICAgIHZhciBpc0xvY2FsVGltZSA9IHRydWU7XG5cbiAgICBpZiAodHlwZW9mIHB1c2hUaW1lUGFyYW0gPT09ICdudW1iZXInKSB7XG4gICAgICBkYXRlID0gbmV3IERhdGUocHVzaFRpbWVQYXJhbSAqIDEwMDApO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHB1c2hUaW1lUGFyYW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICBpc0xvY2FsVGltZSA9ICFQdXNoQ29udHJvbGxlci5wdXNoVGltZUhhc1RpbWV6b25lQ29tcG9uZW50KHB1c2hUaW1lUGFyYW0pO1xuICAgICAgZGF0ZSA9IG5ldyBEYXRlKHB1c2hUaW1lUGFyYW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgYm9keVsncHVzaF90aW1lJ10gKyAnIGlzIG5vdCB2YWxpZCB0aW1lLidcbiAgICAgICk7XG4gICAgfVxuICAgIC8vIENoZWNrIHB1c2hUaW1lIGlzIHZhbGlkIG9yIG5vdCwgaWYgaXQgaXMgbm90IHZhbGlkLCBwdXNoVGltZSBpcyBOYU5cbiAgICBpZiAoIWlzRmluaXRlKGRhdGUpKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgYm9keVsncHVzaF90aW1lJ10gKyAnIGlzIG5vdCB2YWxpZCB0aW1lLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGUsXG4gICAgICBpc0xvY2FsVGltZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBhIElTTzg2MDEgZm9ybWF0dGVkIGRhdGUgY29udGFpbnMgYSB0aW1lem9uZSBjb21wb25lbnRcbiAgICogQHBhcmFtIHB1c2hUaW1lUGFyYW0ge3N0cmluZ31cbiAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAqL1xuICBzdGF0aWMgcHVzaFRpbWVIYXNUaW1lem9uZUNvbXBvbmVudChwdXNoVGltZVBhcmFtOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBvZmZzZXRQYXR0ZXJuID0gLyguKykoWystXSlcXGRcXGQ6XFxkXFxkJC87XG4gICAgcmV0dXJuIChcbiAgICAgIHB1c2hUaW1lUGFyYW0uaW5kZXhPZignWicpID09PSBwdXNoVGltZVBhcmFtLmxlbmd0aCAtIDEgfHwgLy8gMjAwNy0wNC0wNVQxMjozMFpcbiAgICAgIG9mZnNldFBhdHRlcm4udGVzdChwdXNoVGltZVBhcmFtKVxuICAgICk7IC8vIDIwMDctMDQtMDVUMTI6MzAuMDAwKzAyOjAwLCAyMDA3LTA0LTA1VDEyOjMwLjAwMC0wMjowMFxuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIGEgZGF0ZSB0byBJU08gZm9ybWF0IGluIFVUQyB0aW1lIGFuZCBzdHJpcHMgdGhlIHRpbWV6b25lIGlmIGBpc0xvY2FsVGltZWAgaXMgdHJ1ZVxuICAgKiBAcGFyYW0gZGF0ZSB7RGF0ZX1cbiAgICogQHBhcmFtIGlzTG9jYWxUaW1lIHtib29sZWFufVxuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgc3RhdGljIGZvcm1hdFB1c2hUaW1lKHtcbiAgICBkYXRlLFxuICAgIGlzTG9jYWxUaW1lLFxuICB9OiB7XG4gICAgZGF0ZTogRGF0ZSxcbiAgICBpc0xvY2FsVGltZTogYm9vbGVhbixcbiAgfSkge1xuICAgIGlmIChpc0xvY2FsVGltZSkge1xuICAgICAgLy8gU3RyaXAgJ1onXG4gICAgICBjb25zdCBpc29TdHJpbmcgPSBkYXRlLnRvSVNPU3RyaW5nKCk7XG4gICAgICByZXR1cm4gaXNvU3RyaW5nLnN1YnN0cmluZygwLCBpc29TdHJpbmcuaW5kZXhPZignWicpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQdXNoQ29udHJvbGxlcjtcbiJdfQ==