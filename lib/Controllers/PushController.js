"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.PushController = void 0;

var _node = require("parse/node");

var _RestQuery = _interopRequireDefault(require("../RestQuery"));

var _RestWrite = _interopRequireDefault(require("../RestWrite"));

var _Auth = require("../Auth");

var _StatusHandler = require("../StatusHandler");

var _utils = require("../Push/utils");

var _logger = require("../logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class PushController {
  sendPush(body = {}, where = {}, config, auth, onPushStatusSaved = () => {}, now = new Date()) {
    if (!config.hasPushSupport) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Missing push configuration');
    } // Replace the expiration_time and push_time with a valid Unix epoch milliseconds time


    body.expiration_time = PushController.getExpirationTime(body);
    body.expiration_interval = PushController.getExpirationInterval(body);

    if (body.expiration_time && body.expiration_interval) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Both expiration_time and expiration_interval cannot be set');
    } // Immediate push


    if (body.expiration_interval && !body.hasOwnProperty('push_time')) {
      const ttlMs = body.expiration_interval * 1000;
      body.expiration_time = new Date(now.valueOf() + ttlMs).valueOf();
    }

    const pushTime = PushController.getPushTime(body);

    if (pushTime && pushTime.date !== 'undefined') {
      body['push_time'] = PushController.formatPushTime(pushTime);
    } // TODO: If the req can pass the checking, we return immediately instead of waiting
    // pushes to be sent. We probably change this behaviour in the future.


    let badgeUpdate = () => {
      return Promise.resolve();
    };

    if (body.data && body.data.badge) {
      const badge = body.data.badge;
      let restUpdate = {};

      if (typeof badge == 'string' && badge.toLowerCase() === 'increment') {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: 1
          }
        };
      } else if (typeof badge == 'object' && typeof badge.__op == 'string' && badge.__op.toLowerCase() == 'increment' && Number(badge.amount)) {
        restUpdate = {
          badge: {
            __op: 'Increment',
            amount: badge.amount
          }
        };
      } else if (Number(badge)) {
        restUpdate = {
          badge: badge
        };
      } else {
        throw "Invalid value for badge, expected number or 'Increment' or {increment: number}";
      } // Force filtering on only valid device tokens


      const updateWhere = (0, _utils.applyDeviceTokenExists)(where);

      badgeUpdate = () => {
        // Build a real RestQuery so we can use it in RestWrite
        const restQuery = new _RestQuery.default(config, (0, _Auth.master)(config), '_Installation', updateWhere);
        return restQuery.buildRestWhere().then(() => {
          const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Installation', restQuery.restWhere, restUpdate);
          write.runOptions.many = true;
          return write.execute();
        });
      };
    }

    const pushStatus = (0, _StatusHandler.pushStatusHandler)(config);
    return Promise.resolve().then(() => {
      return pushStatus.setInitial(body, where);
    }).then(() => {
      onPushStatusSaved(pushStatus.objectId);
      return badgeUpdate().catch(err => {
        // add this to ignore badge update errors as default
        if (config.stopOnBadgeUpdateError) throw err;

        _logger.logger.info(`Badge update error will be ignored for push status ${pushStatus.objectId}`);

        _logger.logger.info(err && err.stack && err.stack.toString() || err && err.message || err.toString());

        return Promise.resolve();
      });
    }).then(() => {
      // Update audience lastUsed and timesUsed
      if (body.audience_id) {
        const audienceId = body.audience_id;
        var updateAudience = {
          lastUsed: {
            __type: 'Date',
            iso: new Date().toISOString()
          },
          timesUsed: {
            __op: 'Increment',
            amount: 1
          }
        };
        const write = new _RestWrite.default(config, (0, _Auth.master)(config), '_Audience', {
          objectId: audienceId
        }, updateAudience);
        write.execute();
      } // Don't wait for the audience update promise to resolve.


      return Promise.resolve();
    }).then(() => {
      if (body.hasOwnProperty('push_time') && config.hasPushScheduledSupport) {
        return Promise.resolve();
      }

      return config.pushControllerQueue.enqueue(body, where, config, auth, pushStatus);
    }).catch(err => {
      return pushStatus.fail(err).then(() => {
        throw err;
      });
    });
  }
  /**
   * Get expiration time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The expiration time if it exists in the request
   */


  static getExpirationTime(body = {}) {
    var hasExpirationTime = body.hasOwnProperty('expiration_time');

    if (!hasExpirationTime) {
      return;
    }

    var expirationTimeParam = body['expiration_time'];
    var expirationTime;

    if (typeof expirationTimeParam === 'number') {
      expirationTime = new Date(expirationTimeParam * 1000);
    } else if (typeof expirationTimeParam === 'string') {
      expirationTime = new Date(expirationTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    } // Check expirationTime is valid or not, if it is not valid, expirationTime is NaN


    if (!isFinite(expirationTime)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['expiration_time'] + ' is not valid time.');
    }

    return expirationTime.valueOf();
  }

  static getExpirationInterval(body = {}) {
    const hasExpirationInterval = body.hasOwnProperty('expiration_interval');

    if (!hasExpirationInterval) {
      return;
    }

    var expirationIntervalParam = body['expiration_interval'];

    if (typeof expirationIntervalParam !== 'number' || expirationIntervalParam <= 0) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, `expiration_interval must be a number greater than 0`);
    }

    return expirationIntervalParam;
  }
  /**
   * Get push time from the request body.
   * @param {Object} request A request object
   * @returns {Number|undefined} The push time if it exists in the request
   */


  static getPushTime(body = {}) {
    var hasPushTime = body.hasOwnProperty('push_time');

    if (!hasPushTime) {
      return;
    }

    var pushTimeParam = body['push_time'];
    var date;
    var isLocalTime = true;

    if (typeof pushTimeParam === 'number') {
      date = new Date(pushTimeParam * 1000);
    } else if (typeof pushTimeParam === 'string') {
      isLocalTime = !PushController.pushTimeHasTimezoneComponent(pushTimeParam);
      date = new Date(pushTimeParam);
    } else {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    } // Check pushTime is valid or not, if it is not valid, pushTime is NaN


    if (!isFinite(date)) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, body['push_time'] + ' is not valid time.');
    }

    return {
      date,
      isLocalTime
    };
  }
  /**
   * Checks if a ISO8601 formatted date contains a timezone component
   * @param pushTimeParam {string}
   * @returns {boolean}
   */


  static pushTimeHasTimezoneComponent(pushTimeParam) {
    const offsetPattern = /(.+)([+-])\d\d:\d\d$/;
    return pushTimeParam.indexOf('Z') === pushTimeParam.length - 1 || // 2007-04-05T12:30Z
    offsetPattern.test(pushTimeParam); // 2007-04-05T12:30.000+02:00, 2007-04-05T12:30.000-02:00
  }
  /**
   * Converts a date to ISO format in UTC time and strips the timezone if `isLocalTime` is true
   * @param date {Date}
   * @param isLocalTime {boolean}
   * @returns {string}
   */


  static formatPushTime({
    date,
    isLocalTime
  }) {
    if (isLocalTime) {
      // Strip 'Z'
      const isoString = date.toISOString();
      return isoString.substring(0, isoString.indexOf('Z'));
    }

    return date.toISOString();
  }

}

exports.PushController = PushController;
var _default = PushController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db250cm9sbGVycy9QdXNoQ29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJQdXNoQ29udHJvbGxlciIsInNlbmRQdXNoIiwiYm9keSIsIndoZXJlIiwiY29uZmlnIiwiYXV0aCIsIm9uUHVzaFN0YXR1c1NhdmVkIiwibm93IiwiRGF0ZSIsImhhc1B1c2hTdXBwb3J0IiwiUGFyc2UiLCJFcnJvciIsIlBVU0hfTUlTQ09ORklHVVJFRCIsImV4cGlyYXRpb25fdGltZSIsImdldEV4cGlyYXRpb25UaW1lIiwiZXhwaXJhdGlvbl9pbnRlcnZhbCIsImdldEV4cGlyYXRpb25JbnRlcnZhbCIsImhhc093blByb3BlcnR5IiwidHRsTXMiLCJ2YWx1ZU9mIiwicHVzaFRpbWUiLCJnZXRQdXNoVGltZSIsImRhdGUiLCJmb3JtYXRQdXNoVGltZSIsImJhZGdlVXBkYXRlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJkYXRhIiwiYmFkZ2UiLCJyZXN0VXBkYXRlIiwidG9Mb3dlckNhc2UiLCJfX29wIiwiYW1vdW50IiwiTnVtYmVyIiwidXBkYXRlV2hlcmUiLCJyZXN0UXVlcnkiLCJSZXN0UXVlcnkiLCJidWlsZFJlc3RXaGVyZSIsInRoZW4iLCJ3cml0ZSIsIlJlc3RXcml0ZSIsInJlc3RXaGVyZSIsInJ1bk9wdGlvbnMiLCJtYW55IiwiZXhlY3V0ZSIsInB1c2hTdGF0dXMiLCJzZXRJbml0aWFsIiwib2JqZWN0SWQiLCJjYXRjaCIsImVyciIsInN0b3BPbkJhZGdlVXBkYXRlRXJyb3IiLCJsb2dnZXIiLCJpbmZvIiwic3RhY2siLCJ0b1N0cmluZyIsIm1lc3NhZ2UiLCJhdWRpZW5jZV9pZCIsImF1ZGllbmNlSWQiLCJ1cGRhdGVBdWRpZW5jZSIsImxhc3RVc2VkIiwiX190eXBlIiwiaXNvIiwidG9JU09TdHJpbmciLCJ0aW1lc1VzZWQiLCJoYXNQdXNoU2NoZWR1bGVkU3VwcG9ydCIsInB1c2hDb250cm9sbGVyUXVldWUiLCJlbnF1ZXVlIiwiZmFpbCIsImhhc0V4cGlyYXRpb25UaW1lIiwiZXhwaXJhdGlvblRpbWVQYXJhbSIsImV4cGlyYXRpb25UaW1lIiwiaXNGaW5pdGUiLCJoYXNFeHBpcmF0aW9uSW50ZXJ2YWwiLCJleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSIsImhhc1B1c2hUaW1lIiwicHVzaFRpbWVQYXJhbSIsImlzTG9jYWxUaW1lIiwicHVzaFRpbWVIYXNUaW1lem9uZUNvbXBvbmVudCIsIm9mZnNldFBhdHRlcm4iLCJpbmRleE9mIiwibGVuZ3RoIiwidGVzdCIsImlzb1N0cmluZyIsInN1YnN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRU8sTUFBTUEsY0FBTixDQUFxQjtBQUMxQkMsRUFBQUEsUUFBUSxDQUNOQyxJQUFJLEdBQUcsRUFERCxFQUVOQyxLQUFLLEdBQUcsRUFGRixFQUdOQyxNQUhNLEVBSU5DLElBSk0sRUFLTkMsaUJBQWlCLEdBQUcsTUFBTSxDQUFFLENBTHRCLEVBTU5DLEdBQUcsR0FBRyxJQUFJQyxJQUFKLEVBTkEsRUFPTjtBQUNBLFFBQUksQ0FBQ0osTUFBTSxDQUFDSyxjQUFaLEVBQTRCO0FBQzFCLFlBQU0sSUFBSUMsWUFBTUMsS0FBVixDQUNKRCxZQUFNQyxLQUFOLENBQVlDLGtCQURSLEVBRUosNEJBRkksQ0FBTjtBQUlELEtBTkQsQ0FRQTs7O0FBQ0FWLElBQUFBLElBQUksQ0FBQ1csZUFBTCxHQUF1QmIsY0FBYyxDQUFDYyxpQkFBZixDQUFpQ1osSUFBakMsQ0FBdkI7QUFDQUEsSUFBQUEsSUFBSSxDQUFDYSxtQkFBTCxHQUEyQmYsY0FBYyxDQUFDZ0IscUJBQWYsQ0FBcUNkLElBQXJDLENBQTNCOztBQUNBLFFBQUlBLElBQUksQ0FBQ1csZUFBTCxJQUF3QlgsSUFBSSxDQUFDYSxtQkFBakMsRUFBc0Q7QUFDcEQsWUFBTSxJQUFJTCxZQUFNQyxLQUFWLENBQ0pELFlBQU1DLEtBQU4sQ0FBWUMsa0JBRFIsRUFFSiw0REFGSSxDQUFO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R0FBRyxzQkFBdEI7QUFDQSxXQUNFSCxhQUFhLENBQUNJLE9BQWQsQ0FBc0IsR0FBdEIsTUFBK0JKLGFBQWEsQ0FBQ0ssTUFBZCxHQUF1QixDQUF0RCxJQUEyRDtBQUMzREYsSUFBQUEsYUFBYSxDQUFDRyxJQUFkLENBQW1CTixhQUFuQixDQUZGLENBRmtFLENBSy9EO0FBQ0o7QUFFRDs7Ozs7Ozs7QUFNQSxTQUFPcEQsY0FBUCxDQUFzQjtBQUNwQkQsSUFBQUEsSUFEb0I7QUFFcEJzRCxJQUFBQTtBQUZvQixHQUF0QixFQU1HO0FBQ0QsUUFBSUEsV0FBSixFQUFpQjtBQUNmO0FBQ0EsWUFBTU0sU0FBUyxHQUFHNUQsSUFBSSxDQUFDd0MsV0FBTCxFQUFsQjtBQUNBLGFBQU9vQixTQUFTLENBQUNDLFNBQVYsQ0FBb0IsQ0FBcEIsRUFBdUJELFNBQVMsQ0FBQ0gsT0FBVixDQUFrQixHQUFsQixDQUF2QixDQUFQO0FBQ0Q7O0FBQ0QsV0FBT3pELElBQUksQ0FBQ3dDLFdBQUwsRUFBUDtBQUNEOztBQWhSeUI7OztlQW1SYjlELGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJzZSB9IGZyb20gJ3BhcnNlL25vZGUnO1xuaW1wb3J0IFJlc3RRdWVyeSBmcm9tICcuLi9SZXN0UXVlcnknO1xuaW1wb3J0IFJlc3RXcml0ZSBmcm9tICcuLi9SZXN0V3JpdGUnO1xuaW1wb3J0IHsgbWFzdGVyIH0gZnJvbSAnLi4vQXV0aCc7XG5pbXBvcnQgeyBwdXNoU3RhdHVzSGFuZGxlciB9IGZyb20gJy4uL1N0YXR1c0hhbmRsZXInO1xuaW1wb3J0IHsgYXBwbHlEZXZpY2VUb2tlbkV4aXN0cyB9IGZyb20gJy4uL1B1c2gvdXRpbHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIFB1c2hDb250cm9sbGVyIHtcbiAgc2VuZFB1c2goXG4gICAgYm9keSA9IHt9LFxuICAgIHdoZXJlID0ge30sXG4gICAgY29uZmlnLFxuICAgIGF1dGgsXG4gICAgb25QdXNoU3RhdHVzU2F2ZWQgPSAoKSA9PiB7fSxcbiAgICBub3cgPSBuZXcgRGF0ZSgpXG4gICkge1xuICAgIGlmICghY29uZmlnLmhhc1B1c2hTdXBwb3J0KSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgIFBhcnNlLkVycm9yLlBVU0hfTUlTQ09ORklHVVJFRCxcbiAgICAgICAgJ01pc3NpbmcgcHVzaCBjb25maWd1cmF0aW9uJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIHRoZSBleHBpcmF0aW9uX3RpbWUgYW5kIHB1c2hfdGltZSB3aXRoIGEgdmFsaWQgVW5peCBlcG9jaCBtaWxsaXNlY29uZHMgdGltZVxuICAgIGJvZHkuZXhwaXJhdGlvbl90aW1lID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvblRpbWUoYm9keSk7XG4gICAgYm9keS5leHBpcmF0aW9uX2ludGVydmFsID0gUHVzaENvbnRyb2xsZXIuZ2V0RXhwaXJhdGlvbkludGVydmFsKGJvZHkpO1xuICAgIGlmIChib2R5LmV4cGlyYXRpb25fdGltZSAmJiBib2R5LmV4cGlyYXRpb25faW50ZXJ2YWwpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICAnQm90aCBleHBpcmF0aW9uX3RpbWUgYW5kIGV4cGlyYXRpb25faW50ZXJ2YWwgY2Fubm90IGJlIHNldCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gSW1tZWRpYXRlIHB1c2hcbiAgICBpZiAoYm9keS5leHBpcmF0aW9uX2ludGVydmFsICYmICFib2R5Lmhhc093blByb3BlcnR5KCdwdXNoX3RpbWUnKSkge1xuICAgICAgY29uc3QgdHRsTXMgPSBib2R5LmV4cGlyYXRpb25faW50ZXJ2YWwgKiAxMDAwO1xuICAgICAgYm9keS5leHBpcmF0aW9uX3RpbWUgPSBuZXcgRGF0ZShub3cudmFsdWVPZigpICsgdHRsTXMpLnZhbHVlT2YoKTtcbiAgICB9XG5cbiAgICBjb25zdCBwdXNoVGltZSA9IFB1c2hDb250cm9sbGVyLmdldFB1c2hUaW1lKGJvZHkpO1xuICAgIGlmIChwdXNoVGltZSAmJiBwdXNoVGltZS5kYXRlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgYm9keVsncHVzaF90aW1lJ10gPSBQdXNoQ29udHJvbGxlci5mb3JtYXRQdXNoVGltZShwdXNoVGltZSk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogSWYgdGhlIHJlcSBjYW4gcGFzcyB0aGUgY2hlY2tpbmcsIHdlIHJldHVybiBpbW1lZGlhdGVseSBpbnN0ZWFkIG9mIHdhaXRpbmdcbiAgICAvLyBwdXNoZXMgdG8gYmUgc2VudC4gV2UgcHJvYmFibHkgY2hhbmdlIHRoaXMgYmVoYXZpb3VyIGluIHRoZSBmdXR1cmUuXG4gICAgbGV0IGJhZGdlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH07XG5cbiAgICBpZiAoYm9keS5kYXRhICYmIGJvZHkuZGF0YS5iYWRnZSkge1xuICAgICAgY29uc3QgYmFkZ2UgPSBib2R5LmRhdGEuYmFkZ2U7XG4gICAgICBsZXQgcmVzdFVwZGF0ZSA9IHt9O1xuICAgICAgaWYgKHR5cGVvZiBiYWRnZSA9PSAnc3RyaW5nJyAmJiBiYWRnZS50b0xvd2VyQ2FzZSgpID09PSAnaW5jcmVtZW50Jykge1xuICAgICAgICByZXN0VXBkYXRlID0geyBiYWRnZTogeyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiAxIH0gfTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIHR5cGVvZiBiYWRnZSA9PSAnb2JqZWN0JyAmJlxuICAgICAgICB0eXBlb2YgYmFkZ2UuX19vcCA9PSAnc3RyaW5nJyAmJlxuICAgICAgICBiYWRnZS5fX29wLnRvTG93ZXJDYXNlKCkgPT0gJ2luY3JlbWVudCcgJiZcbiAgICAgICAgTnVtYmVyKGJhZGdlLmFtb3VudClcbiAgICAgICkge1xuICAgICAgICByZXN0VXBkYXRlID0geyBiYWRnZTogeyBfX29wOiAnSW5jcmVtZW50JywgYW1vdW50OiBiYWRnZS5hbW91bnQgfSB9O1xuICAgICAgfSBlbHNlIGlmIChOdW1iZXIoYmFkZ2UpKSB7XG4gICAgICAgIHJlc3RVcGRhdGUgPSB7IGJhZGdlOiBiYWRnZSB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgXCJJbnZhbGlkIHZhbHVlIGZvciBiYWRnZSwgZXhwZWN0ZWQgbnVtYmVyIG9yICdJbmNyZW1lbnQnIG9yIHtpbmNyZW1lbnQ6IG51bWJlcn1cIjtcbiAgICAgIH1cblxuICAgICAgLy8gRm9yY2UgZmlsdGVyaW5nIG9uIG9ubHkgdmFsaWQgZGV2aWNlIHRva2Vuc1xuICAgICAgY29uc3QgdXBkYXRlV2hlcmUgPSBhcHBseURldmljZVRva2VuRXhpc3RzKHdoZXJlKTtcbiAgICAgIGJhZGdlVXBkYXRlID0gKCkgPT4ge1xuICAgICAgICAvLyBCdWlsZCBhIHJlYWwgUmVzdFF1ZXJ5IHNvIHdlIGNhbiB1c2UgaXQgaW4gUmVzdFdyaXRlXG4gICAgICAgIGNvbnN0IHJlc3RRdWVyeSA9IG5ldyBSZXN0UXVlcnkoXG4gICAgICAgICAgY29uZmlnLFxuICAgICAgICAgIG1hc3Rlcihjb25maWcpLFxuICAgICAgICAgICdfSW5zdGFsbGF0aW9uJyxcbiAgICAgICAgICB1cGRhdGVXaGVyZVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gcmVzdFF1ZXJ5LmJ1aWxkUmVzdFdoZXJlKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgY29uc3Qgd3JpdGUgPSBuZXcgUmVzdFdyaXRlKFxuICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgbWFzdGVyKGNvbmZpZyksXG4gICAgICAgICAgICAnX0luc3RhbGxhdGlvbicsXG4gICAgICAgICAgICByZXN0UXVlcnkucmVzdFdoZXJlLFxuICAgICAgICAgICAgcmVzdFVwZGF0ZVxuICAgICAgICAgICk7XG4gICAgICAgICAgd3JpdGUucnVuT3B0aW9ucy5tYW55ID0gdHJ1ZTtcbiAgICAgICAgICByZXR1cm4gd3JpdGUuZXhlY3V0ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IHB1c2hTdGF0dXMgPSBwdXNoU3RhdHVzSGFuZGxlcihjb25maWcpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gcHVzaFN0YXR1cy5zZXRJbml0aWFsKGJvZHksIHdoZXJlKTtcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIG9uUHVzaFN0YXR1c1NhdmVkKHB1c2hTdGF0dXMub2JqZWN0SWQpO1xuICAgICAgICByZXR1cm4gYmFkZ2VVcGRhdGUoKS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIC8vIGFkZCB0aGlzIHRvIGlnbm9yZSBiYWRnZSB1cGRhdGUgZXJyb3JzIGFzIGRlZmF1bHRcbiAgICAgICAgICBpZiAoY29uZmlnLnN0b3BPbkJhZGdlVXBkYXRlRXJyb3IpIHRocm93IGVycjtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICAgIGBCYWRnZSB1cGRhdGUgZXJyb3Igd2lsbCBiZSBpZ25vcmVkIGZvciBwdXNoIHN0YXR1cyAke1xuICAgICAgICAgICAgICBwdXNoU3RhdHVzLm9iamVjdElkXG4gICAgICAgICAgICB9YFxuICAgICAgICAgICk7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oXG4gICAgICAgICAgICAoZXJyICYmIGVyci5zdGFjayAmJiBlcnIuc3RhY2sudG9TdHJpbmcoKSkgfHxcbiAgICAgICAgICAgICAgKGVyciAmJiBlcnIubWVzc2FnZSkgfHxcbiAgICAgICAgICAgICAgZXJyLnRvU3RyaW5nKClcbiAgICAgICAgICApO1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAvLyBVcGRhdGUgYXVkaWVuY2UgbGFzdFVzZWQgYW5kIHRpbWVzVXNlZFxuICAgICAgICBpZiAoYm9keS5hdWRpZW5jZV9pZCkge1xuICAgICAgICAgIGNvbnN0IGF1ZGllbmNlSWQgPSBib2R5LmF1ZGllbmNlX2lkO1xuXG4gICAgICAgICAgdmFyIHVwZGF0ZUF1ZGllbmNlID0ge1xuICAgICAgICAgICAgbGFzdFVzZWQ6IHsgX190eXBlOiAnRGF0ZScsIGlzbzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0sXG4gICAgICAgICAgICB0aW1lc1VzZWQ6IHsgX19vcDogJ0luY3JlbWVudCcsIGFtb3VudDogMSB9LFxuICAgICAgICAgIH07XG4gICAgICAgICAgY29uc3Qgd3JpdGUgPSBuZXcgUmVzdFdyaXRlKFxuICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgbWFzdGVyKGNvbmZpZyksXG4gICAgICAgICAgICAnX0F1ZGllbmNlJyxcbiAgICAgICAgICAgIHsgb2JqZWN0SWQ6IGF1ZGllbmNlSWQgfSxcbiAgICAgICAgICAgIHVwZGF0ZUF1ZGllbmNlXG4gICAgICAgICAgKTtcbiAgICAgICAgICB3cml0ZS5leGVjdXRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRG9uJ3Qgd2FpdCBmb3IgdGhlIGF1ZGllbmNlIHVwZGF0ZSBwcm9taXNlIHRvIHJlc29sdmUuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBib2R5Lmhhc093blByb3BlcnR5KCdwdXNoX3RpbWUnKSAmJlxuICAgICAgICAgIGNvbmZpZy5oYXNQdXNoU2NoZWR1bGVkU3VwcG9ydFxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbmZpZy5wdXNoQ29udHJvbGxlclF1ZXVlLmVucXVldWUoXG4gICAgICAgICAgYm9keSxcbiAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgYXV0aCxcbiAgICAgICAgICBwdXNoU3RhdHVzXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIHJldHVybiBwdXNoU3RhdHVzLmZhaWwoZXJyKS50aGVuKCgpID0+IHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGV4cGlyYXRpb24gdGltZSBmcm9tIHRoZSByZXF1ZXN0IGJvZHkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSByZXF1ZXN0IEEgcmVxdWVzdCBvYmplY3RcbiAgICogQHJldHVybnMge051bWJlcnx1bmRlZmluZWR9IFRoZSBleHBpcmF0aW9uIHRpbWUgaWYgaXQgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gICAqL1xuICBzdGF0aWMgZ2V0RXhwaXJhdGlvblRpbWUoYm9keSA9IHt9KSB7XG4gICAgdmFyIGhhc0V4cGlyYXRpb25UaW1lID0gYm9keS5oYXNPd25Qcm9wZXJ0eSgnZXhwaXJhdGlvbl90aW1lJyk7XG4gICAgaWYgKCFoYXNFeHBpcmF0aW9uVGltZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZXhwaXJhdGlvblRpbWVQYXJhbSA9IGJvZHlbJ2V4cGlyYXRpb25fdGltZSddO1xuICAgIHZhciBleHBpcmF0aW9uVGltZTtcbiAgICBpZiAodHlwZW9mIGV4cGlyYXRpb25UaW1lUGFyYW0gPT09ICdudW1iZXInKSB7XG4gICAgICBleHBpcmF0aW9uVGltZSA9IG5ldyBEYXRlKGV4cGlyYXRpb25UaW1lUGFyYW0gKiAxMDAwKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBpcmF0aW9uVGltZVBhcmFtID09PSAnc3RyaW5nJykge1xuICAgICAgZXhwaXJhdGlvblRpbWUgPSBuZXcgRGF0ZShleHBpcmF0aW9uVGltZVBhcmFtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ2V4cGlyYXRpb25fdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBDaGVjayBleHBpcmF0aW9uVGltZSBpcyB2YWxpZCBvciBub3QsIGlmIGl0IGlzIG5vdCB2YWxpZCwgZXhwaXJhdGlvblRpbWUgaXMgTmFOXG4gICAgaWYgKCFpc0Zpbml0ZShleHBpcmF0aW9uVGltZSkpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICBib2R5WydleHBpcmF0aW9uX3RpbWUnXSArICcgaXMgbm90IHZhbGlkIHRpbWUuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGV4cGlyYXRpb25UaW1lLnZhbHVlT2YoKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRFeHBpcmF0aW9uSW50ZXJ2YWwoYm9keSA9IHt9KSB7XG4gICAgY29uc3QgaGFzRXhwaXJhdGlvbkludGVydmFsID0gYm9keS5oYXNPd25Qcm9wZXJ0eSgnZXhwaXJhdGlvbl9pbnRlcnZhbCcpO1xuICAgIGlmICghaGFzRXhwaXJhdGlvbkludGVydmFsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIGV4cGlyYXRpb25JbnRlcnZhbFBhcmFtID0gYm9keVsnZXhwaXJhdGlvbl9pbnRlcnZhbCddO1xuICAgIGlmIChcbiAgICAgIHR5cGVvZiBleHBpcmF0aW9uSW50ZXJ2YWxQYXJhbSAhPT0gJ251bWJlcicgfHxcbiAgICAgIGV4cGlyYXRpb25JbnRlcnZhbFBhcmFtIDw9IDBcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICBgZXhwaXJhdGlvbl9pbnRlcnZhbCBtdXN0IGJlIGEgbnVtYmVyIGdyZWF0ZXIgdGhhbiAwYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGV4cGlyYXRpb25JbnRlcnZhbFBhcmFtO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBwdXNoIHRpbWUgZnJvbSB0aGUgcmVxdWVzdCBib2R5LlxuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxdWVzdCBBIHJlcXVlc3Qgb2JqZWN0XG4gICAqIEByZXR1cm5zIHtOdW1iZXJ8dW5kZWZpbmVkfSBUaGUgcHVzaCB0aW1lIGlmIGl0IGV4aXN0cyBpbiB0aGUgcmVxdWVzdFxuICAgKi9cbiAgc3RhdGljIGdldFB1c2hUaW1lKGJvZHkgPSB7fSkge1xuICAgIHZhciBoYXNQdXNoVGltZSA9IGJvZHkuaGFzT3duUHJvcGVydHkoJ3B1c2hfdGltZScpO1xuICAgIGlmICghaGFzUHVzaFRpbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIHB1c2hUaW1lUGFyYW0gPSBib2R5WydwdXNoX3RpbWUnXTtcbiAgICB2YXIgZGF0ZTtcbiAgICB2YXIgaXNMb2NhbFRpbWUgPSB0cnVlO1xuXG4gICAgaWYgKHR5cGVvZiBwdXNoVGltZVBhcmFtID09PSAnbnVtYmVyJykge1xuICAgICAgZGF0ZSA9IG5ldyBEYXRlKHB1c2hUaW1lUGFyYW0gKiAxMDAwKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwdXNoVGltZVBhcmFtID09PSAnc3RyaW5nJykge1xuICAgICAgaXNMb2NhbFRpbWUgPSAhUHVzaENvbnRyb2xsZXIucHVzaFRpbWVIYXNUaW1lem9uZUNvbXBvbmVudChwdXNoVGltZVBhcmFtKTtcbiAgICAgIGRhdGUgPSBuZXcgRGF0ZShwdXNoVGltZVBhcmFtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ3B1c2hfdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBDaGVjayBwdXNoVGltZSBpcyB2YWxpZCBvciBub3QsIGlmIGl0IGlzIG5vdCB2YWxpZCwgcHVzaFRpbWUgaXMgTmFOXG4gICAgaWYgKCFpc0Zpbml0ZShkYXRlKSkge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgIGJvZHlbJ3B1c2hfdGltZSddICsgJyBpcyBub3QgdmFsaWQgdGltZS4nXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBkYXRlLFxuICAgICAgaXNMb2NhbFRpbWUsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgYSBJU084NjAxIGZvcm1hdHRlZCBkYXRlIGNvbnRhaW5zIGEgdGltZXpvbmUgY29tcG9uZW50XG4gICAqIEBwYXJhbSBwdXNoVGltZVBhcmFtIHtzdHJpbmd9XG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgc3RhdGljIHB1c2hUaW1lSGFzVGltZXpvbmVDb21wb25lbnQocHVzaFRpbWVQYXJhbTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgb2Zmc2V0UGF0dGVybiA9IC8oLispKFsrLV0pXFxkXFxkOlxcZFxcZCQvO1xuICAgIHJldHVybiAoXG4gICAgICBwdXNoVGltZVBhcmFtLmluZGV4T2YoJ1onKSA9PT0gcHVzaFRpbWVQYXJhbS5sZW5ndGggLSAxIHx8IC8vIDIwMDctMDQtMDVUMTI6MzBaXG4gICAgICBvZmZzZXRQYXR0ZXJuLnRlc3QocHVzaFRpbWVQYXJhbSlcbiAgICApOyAvLyAyMDA3LTA0LTA1VDEyOjMwLjAwMCswMjowMCwgMjAwNy0wNC0wNVQxMjozMC4wMDAtMDI6MDBcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyBhIGRhdGUgdG8gSVNPIGZvcm1hdCBpbiBVVEMgdGltZSBhbmQgc3RyaXBzIHRoZSB0aW1lem9uZSBpZiBgaXNMb2NhbFRpbWVgIGlzIHRydWVcbiAgICogQHBhcmFtIGRhdGUge0RhdGV9XG4gICAqIEBwYXJhbSBpc0xvY2FsVGltZSB7Ym9vbGVhbn1cbiAgICogQHJldHVybnMge3N0cmluZ31cbiAgICovXG4gIHN0YXRpYyBmb3JtYXRQdXNoVGltZSh7XG4gICAgZGF0ZSxcbiAgICBpc0xvY2FsVGltZSxcbiAgfToge1xuICAgIGRhdGU6IERhdGUsXG4gICAgaXNMb2NhbFRpbWU6IGJvb2xlYW4sXG4gIH0pIHtcbiAgICBpZiAoaXNMb2NhbFRpbWUpIHtcbiAgICAgIC8vIFN0cmlwICdaJ1xuICAgICAgY29uc3QgaXNvU3RyaW5nID0gZGF0ZS50b0lTT1N0cmluZygpO1xuICAgICAgcmV0dXJuIGlzb1N0cmluZy5zdWJzdHJpbmcoMCwgaXNvU3RyaW5nLmluZGV4T2YoJ1onKSk7XG4gICAgfVxuICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHVzaENvbnRyb2xsZXI7XG4iXX0=