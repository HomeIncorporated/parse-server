'use strict';

// This file contains helpers for running operations in REST format.
// The goal is that handlers that explicitly handle an express route
// should just be shallow wrappers around things in this file, but
// these functions should not explicitly depend on the request
// object.
// This means that one of these handlers can support multiple
// routes. That's useful for the routes that do really similar
// things.

var Parse = require('parse/node').Parse;

var RestQuery = require('./RestQuery');
var RestWrite = require('./RestWrite');
var triggers = require('./triggers');

function checkTriggers(className, config, types) {
  return types.some(triggerType => {
    return triggers.getTrigger(className, triggers.Types[triggerType], config.applicationId);
  });
}

function checkLiveQuery(className, config) {
  return config.liveQueryController && config.liveQueryController.hasLiveQuery(className);
}

// Returns a promise for an object with optional keys 'results' and 'count'.
function find(config, auth, className, restWhere, restOptions, clientSDK) {
  enforceRoleSecurity('find', className, auth);
  return triggers.maybeRunQueryTrigger(triggers.Types.beforeFind, className, restWhere, restOptions, config, auth).then(result => {
    restWhere = result.restWhere || restWhere;
    restOptions = result.restOptions || restOptions;
    const query = new RestQuery(config, auth, className, restWhere, restOptions, clientSDK);
    return query.execute();
  });
}

// get is just like find but only queries an objectId.
const get = (config, auth, className, objectId, restOptions, clientSDK) => {
  var restWhere = { objectId };
  enforceRoleSecurity('get', className, auth);
  return triggers.maybeRunQueryTrigger(triggers.Types.beforeFind, className, restWhere, restOptions, config, auth, true).then(result => {
    restWhere = result.restWhere || restWhere;
    restOptions = result.restOptions || restOptions;
    const query = new RestQuery(config, auth, className, restWhere, restOptions, clientSDK);
    return query.execute();
  });
};

// Returns a promise that doesn't resolve to any useful value.
function del(config, auth, className, objectId) {
  if (typeof objectId !== 'string') {
    throw new Parse.Error(Parse.Error.INVALID_JSON, 'bad objectId');
  }

  if (className === '_User' && auth.isUnauthenticated()) {
    throw new Parse.Error(Parse.Error.SESSION_MISSING, 'Insufficient auth to delete user');
  }

  enforceRoleSecurity('delete', className, auth);

  var inflatedObject;

  return Promise.resolve().then(() => {
    const hasTriggers = checkTriggers(className, config, ['beforeDelete', 'afterDelete']);
    const hasLiveQuery = checkLiveQuery(className, config);
    if (hasTriggers || hasLiveQuery || className == '_Session') {
      return new RestQuery(config, auth, className, { objectId }).forWrite().execute().then(response => {
        if (response && response.results && response.results.length) {
          const firstResult = response.results[0];
          firstResult.className = className;
          if (className === '_Session' && !auth.isMaster) {
            if (!auth.user || firstResult.user.objectId !== auth.user.id) {
              throw new Parse.Error(Parse.Error.INVALID_SESSION_TOKEN, 'Invalid session token');
            }
          }
          var cacheAdapter = config.cacheController;
          cacheAdapter.user.del(firstResult.sessionToken);
          inflatedObject = Parse.Object.fromJSON(firstResult);
          // Notify LiveQuery server if possible
          config.liveQueryController.onAfterDelete(inflatedObject.className, inflatedObject);
          return triggers.maybeRunTrigger(triggers.Types.beforeDelete, auth, inflatedObject, null, config);
        }
        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Object not found for delete.');
      });
    }
    return Promise.resolve({});
  }).then(() => {
    if (!auth.isMaster) {
      return auth.getUserRoles();
    } else {
      return;
    }
  }).then(() => {
    var options = {};
    if (!auth.isMaster) {
      options.acl = ['*'];
      if (auth.user) {
        options.acl.push(auth.user.id);
        options.acl = options.acl.concat(auth.userRoles);
      }
    }

    return config.database.destroy(className, {
      objectId: objectId
    }, options);
  }).then(() => {
    return triggers.maybeRunTrigger(triggers.Types.afterDelete, auth, inflatedObject, null, config);
  }).catch(error => {
    handleSessionMissingError(error, className, auth);
  });
}

// Returns a promise for a {response, status, location} object.
function create(config, auth, className, restObject, clientSDK, options) {
  enforceRoleSecurity('create', className, auth);
  var write = new RestWrite(config, auth, className, null, restObject, null, clientSDK, options);
  return write.execute();
}

// Returns a promise that contains the fields of the update that the
// REST API is supposed to return.
// Usually, this is just updatedAt.
function update(config, auth, className, restWhere, restObject, clientSDK) {
  enforceRoleSecurity('update', className, auth);

  return Promise.resolve().then(() => {
    const hasTriggers = checkTriggers(className, config, ['beforeSave', 'afterSave']);
    const hasLiveQuery = checkLiveQuery(className, config);
    if (hasTriggers || hasLiveQuery) {
      // Do not use find, as it runs the before finds
      return new RestQuery(config, auth, className, restWhere).forWrite().execute();
    }
    return Promise.resolve({});
  }).then(({ results }) => {
    var originalRestObject;
    if (results && results.length) {
      originalRestObject = results[0];
    }
    return new RestWrite(config, auth, className, restWhere, restObject, originalRestObject, clientSDK).execute();
  }).catch(error => {
    handleSessionMissingError(error, className, auth);
  });
}

function handleSessionMissingError(error, className) {
  // If we're trying to update a user without / with bad session token
  if (className === '_User' && error.code === Parse.Error.OBJECT_NOT_FOUND) {
    throw new Parse.Error(Parse.Error.SESSION_MISSING, 'Insufficient auth.');
  }
  throw error;
}

const classesWithMasterOnlyAccess = ['_JobStatus', '_PushStatus', '_Hooks', '_GlobalConfig', '_JobSchedule'];
// Disallowing access to the _Role collection except by master key
function enforceRoleSecurity(method, className, auth) {
  if (className === '_Installation' && !auth.isMaster) {
    if (method === 'delete' || method === 'find') {
      const error = `Clients aren't allowed to perform the ${method} operation on the installation collection.`;
      throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
    }
  }

  //all volatileClasses are masterKey only
  if (classesWithMasterOnlyAccess.indexOf(className) >= 0 && !auth.isMaster) {
    const error = `Clients aren't allowed to perform the ${method} operation on the ${className} collection.`;
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
  }

  // readOnly masterKey is not allowed
  if (auth.isReadOnly && (method === 'delete' || method === 'create' || method === 'update')) {
    const error = `read-only masterKey isn't allowed to perform the ${method} operation.`;
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
  }
}

module.exports = {
  create,
  del,
  find,
  get,
  update
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXN0LmpzIl0sIm5hbWVzIjpbIlBhcnNlIiwicmVxdWlyZSIsIlJlc3RRdWVyeSIsIlJlc3RXcml0ZSIsInRyaWdnZXJzIiwiY2hlY2tUcmlnZ2VycyIsImNsYXNzTmFtZSIsImNvbmZpZyIsInR5cGVzIiwic29tZSIsInRyaWdnZXJUeXBlIiwiZ2V0VHJpZ2dlciIsIlR5cGVzIiwiYXBwbGljYXRpb25JZCIsImNoZWNrTGl2ZVF1ZXJ5IiwibGl2ZVF1ZXJ5Q29udHJvbGxlciIsImhhc0xpdmVRdWVyeSIsImZpbmQiLCJhdXRoIiwicmVzdFdoZXJlIiwicmVzdE9wdGlvbnMiLCJjbGllbnRTREsiLCJlbmZvcmNlUm9sZVNlY3VyaXR5IiwibWF5YmVSdW5RdWVyeVRyaWdnZXIiLCJiZWZvcmVGaW5kIiwidGhlbiIsInJlc3VsdCIsInF1ZXJ5IiwiZXhlY3V0ZSIsImdldCIsIm9iamVjdElkIiwiZGVsIiwiRXJyb3IiLCJJTlZBTElEX0pTT04iLCJpc1VuYXV0aGVudGljYXRlZCIsIlNFU1NJT05fTUlTU0lORyIsImluZmxhdGVkT2JqZWN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJoYXNUcmlnZ2VycyIsImZvcldyaXRlIiwicmVzcG9uc2UiLCJyZXN1bHRzIiwibGVuZ3RoIiwiZmlyc3RSZXN1bHQiLCJpc01hc3RlciIsInVzZXIiLCJpZCIsIklOVkFMSURfU0VTU0lPTl9UT0tFTiIsImNhY2hlQWRhcHRlciIsImNhY2hlQ29udHJvbGxlciIsInNlc3Npb25Ub2tlbiIsIk9iamVjdCIsImZyb21KU09OIiwib25BZnRlckRlbGV0ZSIsIm1heWJlUnVuVHJpZ2dlciIsImJlZm9yZURlbGV0ZSIsIk9CSkVDVF9OT1RfRk9VTkQiLCJnZXRVc2VyUm9sZXMiLCJvcHRpb25zIiwiYWNsIiwicHVzaCIsImNvbmNhdCIsInVzZXJSb2xlcyIsImRhdGFiYXNlIiwiZGVzdHJveSIsImFmdGVyRGVsZXRlIiwiY2F0Y2giLCJlcnJvciIsImhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IiLCJjcmVhdGUiLCJyZXN0T2JqZWN0Iiwid3JpdGUiLCJ1cGRhdGUiLCJvcmlnaW5hbFJlc3RPYmplY3QiLCJjb2RlIiwiY2xhc3Nlc1dpdGhNYXN0ZXJPbmx5QWNjZXNzIiwibWV0aG9kIiwiT1BFUkFUSU9OX0ZPUkJJRERFTiIsImluZGV4T2YiLCJpc1JlYWRPbmx5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLElBQUlBLFFBQVFDLFFBQVEsWUFBUixFQUFzQkQsS0FBbEM7O0FBRUEsSUFBSUUsWUFBWUQsUUFBUSxhQUFSLENBQWhCO0FBQ0EsSUFBSUUsWUFBWUYsUUFBUSxhQUFSLENBQWhCO0FBQ0EsSUFBSUcsV0FBV0gsUUFBUSxZQUFSLENBQWY7O0FBRUEsU0FBU0ksYUFBVCxDQUF1QkMsU0FBdkIsRUFBa0NDLE1BQWxDLEVBQTBDQyxLQUExQyxFQUFpRDtBQUMvQyxTQUFPQSxNQUFNQyxJQUFOLENBQVlDLFdBQUQsSUFBaUI7QUFDakMsV0FBT04sU0FBU08sVUFBVCxDQUFvQkwsU0FBcEIsRUFBK0JGLFNBQVNRLEtBQVQsQ0FBZUYsV0FBZixDQUEvQixFQUE0REgsT0FBT00sYUFBbkUsQ0FBUDtBQUNELEdBRk0sQ0FBUDtBQUdEOztBQUVELFNBQVNDLGNBQVQsQ0FBd0JSLFNBQXhCLEVBQW1DQyxNQUFuQyxFQUEyQztBQUN6QyxTQUFPQSxPQUFPUSxtQkFBUCxJQUE4QlIsT0FBT1EsbUJBQVAsQ0FBMkJDLFlBQTNCLENBQXdDVixTQUF4QyxDQUFyQztBQUNEOztBQUVEO0FBQ0EsU0FBU1csSUFBVCxDQUFjVixNQUFkLEVBQXNCVyxJQUF0QixFQUE0QlosU0FBNUIsRUFBdUNhLFNBQXZDLEVBQWtEQyxXQUFsRCxFQUErREMsU0FBL0QsRUFBMEU7QUFDeEVDLHNCQUFvQixNQUFwQixFQUE0QmhCLFNBQTVCLEVBQXVDWSxJQUF2QztBQUNBLFNBQU9kLFNBQVNtQixvQkFB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QU1nQyxLQUFOLENBQVk4QyxtQkFBNUIsRUFBaURWLEtBQWpELENBQU47QUFDRDs7QUFFRDtBQUNBLE1BQUlsRCxLQUFLOEQsVUFBTCxLQUFvQkgsV0FBVyxRQUFYLElBQXVCQSxXQUFXLFFBQWxDLElBQThDQSxXQUFXLFFBQTdFLENBQUosRUFBNEY7QUFDMUYsVUFBTVQsUUFBUyxvREFBbURTLE1BQU8sYUFBekU7QUFDQSxVQUFNLElBQUk3RSxNQUFNZ0MsS0FBVixDQUFnQmhDLE1BQU1nQyxLQUFOLENBQVk4QyxtQkFBNUIsRUFBaURWLEtBQWpELENBQU47QUFDRDtBQUNGOztBQUVEYSxPQUFPQyxPQUFQLEdBQWlCO0FBQ2ZaLFFBRGU7QUFFZnZDLEtBRmU7QUFHZmQsTUFIZTtBQUlmWSxLQUplO0FBS2Y0QztBQUxlLENBQWpCIiwiZmlsZSI6InJlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGlzIGZpbGUgY29udGFpbnMgaGVscGVycyBmb3IgcnVubmluZyBvcGVyYXRpb25zIGluIFJFU1QgZm9ybWF0LlxuLy8gVGhlIGdvYWwgaXMgdGhhdCBoYW5kbGVycyB0aGF0IGV4cGxpY2l0bHkgaGFuZGxlIGFuIGV4cHJlc3Mgcm91dGVcbi8vIHNob3VsZCBqdXN0IGJlIHNoYWxsb3cgd3JhcHBlcnMgYXJvdW5kIHRoaW5ncyBpbiB0aGlzIGZpbGUsIGJ1dFxuLy8gdGhlc2UgZnVuY3Rpb25zIHNob3VsZCBub3QgZXhwbGljaXRseSBkZXBlbmQgb24gdGhlIHJlcXVlc3Rcbi8vIG9iamVjdC5cbi8vIFRoaXMgbWVhbnMgdGhhdCBvbmUgb2YgdGhlc2UgaGFuZGxlcnMgY2FuIHN1cHBvcnQgbXVsdGlwbGVcbi8vIHJvdXRlcy4gVGhhdCdzIHVzZWZ1bCBmb3IgdGhlIHJvdXRlcyB0aGF0IGRvIHJlYWxseSBzaW1pbGFyXG4vLyB0aGluZ3MuXG5cbnZhciBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZTtcblxudmFyIFJlc3RRdWVyeSA9IHJlcXVpcmUoJy4vUmVzdFF1ZXJ5Jyk7XG52YXIgUmVzdFdyaXRlID0gcmVxdWlyZSgnLi9SZXN0V3JpdGUnKTtcbnZhciB0cmlnZ2VycyA9IHJlcXVpcmUoJy4vdHJpZ2dlcnMnKTtcblxuZnVuY3Rpb24gY2hlY2tUcmlnZ2VycyhjbGFzc05hbWUsIGNvbmZpZywgdHlwZXMpIHtcbiAgcmV0dXJuIHR5cGVzLnNvbWUoKHRyaWdnZXJUeXBlKSA9PiB7XG4gICAgcmV0dXJuIHRyaWdnZXJzLmdldFRyaWdnZXIoY2xhc3NOYW1lLCB0cmlnZ2Vycy5UeXBlc1t0cmlnZ2VyVHlwZV0sIGNvbmZpZy5hcHBsaWNhdGlvbklkKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrTGl2ZVF1ZXJ5KGNsYXNzTmFtZSwgY29uZmlnKSB7XG4gIHJldHVybiBjb25maWcubGl2ZVF1ZXJ5Q29udHJvbGxlciAmJiBjb25maWcubGl2ZVF1ZXJ5Q29udHJvbGxlci5oYXNMaXZlUXVlcnkoY2xhc3NOYW1lKVxufVxuXG4vLyBSZXR1cm5zIGEgcHJvbWlzZSBmb3IgYW4gb2JqZWN0IHdpdGggb3B0aW9uYWwga2V5cyAncmVzdWx0cycgYW5kICdjb3VudCcuXG5mdW5jdGlvbiBmaW5kKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUsIHJlc3RPcHRpb25zLCBjbGllbnRTREspIHtcbiAgZW5mb3JjZVJvbGVTZWN1cml0eSgnZmluZCcsIGNsYXNzTmFtZSwgYXV0aCk7XG4gIHJldHVybiB0cmlnZ2Vycy5tYXliZVJ1blF1ZXJ5VHJpZ2dlcih0cmlnZ2Vycy5UeXBlcy5iZWZvcmVGaW5kLCBjbGFzc05hbWUsIHJlc3RXaGVyZSwgcmVzdE9wdGlvbnMsIGNvbmZpZywgYXV0aCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgcmVzdFdoZXJlID0gcmVzdWx0LnJlc3RXaGVyZSB8fCByZXN0V2hlcmU7XG4gICAgcmVzdE9wdGlvbnMgPSByZXN1bHQucmVzdE9wdGlvbnMgfHwgcmVzdE9wdGlvbnM7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgUmVzdFF1ZXJ5KGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUsIHJlc3RPcHRpb25zLCBjbGllbnRTREspO1xuICAgIHJldHVybiBxdWVyeS5leGVjdXRlKCk7XG4gIH0pO1xufVxuXG4vLyBnZXQgaXMganVzdCBsaWtlIGZpbmQgYnV0IG9ubHkgcXVlcmllcyBhbiBvYmplY3RJZC5cbmNvbnN0IGdldCA9IChjb25maWcsIGF1dGgsIGNsYXNzTmFtZSwgb2JqZWN0SWQsIHJlc3RPcHRpb25zLCBjbGllbnRTREspID0+IHtcbiAgdmFyIHJlc3RXaGVyZSA9IHsgb2JqZWN0SWQgfTtcbiAgZW5mb3JjZVJvbGVTZWN1cml0eSgnZ2V0JywgY2xhc3NOYW1lLCBhdXRoKTtcbiAgcmV0dXJuIHRyaWdnZXJzLm1heWJlUnVuUXVlcnlUcmlnZ2VyKHRyaWdnZXJzLlR5cGVzLmJlZm9yZUZpbmQsIGNsYXNzTmFtZSwgcmVzdFdoZXJlLCByZXN0T3B0aW9ucywgY29uZmlnLCBhdXRoLCB0cnVlKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICByZXN0V2hlcmUgPSByZXN1bHQucmVzdFdoZXJlIHx8IHJlc3RXaGVyZTtcbiAgICByZXN0T3B0aW9ucyA9IHJlc3VsdC5yZXN0T3B0aW9ucyB8fCByZXN0T3B0aW9ucztcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBSZXN0UXVlcnkoY29uZmlnLCBhdXRoLCBjbGFzc05hbWUsIHJlc3RXaGVyZSwgcmVzdE9wdGlvbnMsIGNsaWVudFNESyk7XG4gICAgcmV0dXJuIHF1ZXJ5LmV4ZWN1dGUoKTtcbiAgfSk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgZG9lc24ndCByZXNvbHZlIHRvIGFueSB1c2VmdWwgdmFsdWUuXG5mdW5jdGlvbiBkZWwoY29uZmlnLCBhdXRoLCBjbGFzc05hbWUsIG9iamVjdElkKSB7XG4gIGlmICh0eXBlb2Ygb2JqZWN0SWQgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfSlNPTixcbiAgICAgICdiYWQgb2JqZWN0SWQnKTtcbiAgfVxuXG4gIGlmIChjbGFzc05hbWUgPT09ICdfVXNlcicgJiYgYXV0aC5pc1VuYXV0aGVudGljYXRlZCgpKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlNFU1NJT05fTUlTU0lORyxcbiAgICAgICdJbnN1ZmZpY2llbnQgYXV0aCB0byBkZWxldGUgdXNlcicpO1xuICB9XG5cbiAgZW5mb3JjZVJvbGVTZWN1cml0eSgnZGVsZXRlJywgY2xhc3NOYW1lLCBhdXRoKTtcblxuICB2YXIgaW5mbGF0ZWRPYmplY3Q7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgIGNvbnN0IGhhc1RyaWdnZXJzID0gY2hlY2tUcmlnZ2VycyhjbGFzc05hbWUsIGNvbmZpZywgWydiZWZvcmVEZWxldGUnLCAnYWZ0ZXJEZWxldGUnXSk7XG4gICAgY29uc3QgaGFzTGl2ZVF1ZXJ5ID0gY2hlY2tMaXZlUXVlcnkoY2xhc3NOYW1lLCBjb25maWcpO1xuICAgIGlmIChoYXNUcmlnZ2VycyB8fCBoYXNMaXZlUXVlcnkgfHwgY2xhc3NOYW1lID09ICdfU2Vzc2lvbicpIHtcbiAgICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5KGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCB7IG9iamVjdElkIH0pXG4gICAgICAgIC5mb3JXcml0ZSgpXG4gICAgICAgIC5leGVjdXRlKClcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnJlc3VsdHMgJiYgcmVzcG9uc2UucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0UmVzdWx0ID0gcmVzcG9uc2UucmVzdWx0c1swXTtcbiAgICAgICAgICAgIGZpcnN0UmVzdWx0LmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcbiAgICAgICAgICAgIGlmIChjbGFzc05hbWUgPT09ICdfU2Vzc2lvbicgJiYgIWF1dGguaXNNYXN0ZXIpIHtcbiAgICAgICAgICAgICAgaWYgKCFhdXRoLnVzZXIgfHwgZmlyc3RSZXN1bHQudXNlci5vYmplY3RJZCAhPT0gYXV0aC51c2VyLmlkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfU0VTU0lPTl9UT0tFTiwgJ0ludmFsaWQgc2Vzc2lvbiB0b2tlbicpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgY2FjaGVBZGFwdGVyID0gY29uZmlnLmNhY2hlQ29udHJvbGxlcjtcbiAgICAgICAgICAgIGNhY2hlQWRhcHRlci51c2VyLmRlbChmaXJzdFJlc3VsdC5zZXNzaW9uVG9rZW4pO1xuICAgICAgICAgICAgaW5mbGF0ZWRPYmplY3QgPSBQYXJzZS5PYmplY3QuZnJvbUpTT04oZmlyc3RSZXN1bHQpO1xuICAgICAgICAgICAgLy8gTm90aWZ5IExpdmVRdWVyeSBzZXJ2ZXIgaWYgcG9zc2libGVcbiAgICAgICAgICAgIGNvbmZpZy5saXZlUXVlcnlDb250cm9sbGVyLm9uQWZ0ZXJEZWxldGUoaW5mbGF0ZWRPYmplY3QuY2xhc3NOYW1lLCBpbmZsYXRlZE9iamVjdCk7XG4gICAgICAgICAgICByZXR1cm4gdHJpZ2dlcnMubWF5YmVSdW5UcmlnZ2VyKHRyaWdnZXJzLlR5cGVzLmJlZm9yZURlbGV0ZSwgYXV0aCwgaW5mbGF0ZWRPYmplY3QsIG51bGwsICBjb25maWcpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICAgICAgICdPYmplY3Qgbm90IGZvdW5kIGZvciBkZWxldGUuJyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt9KTtcbiAgfSkudGhlbigoKSA9PiB7XG4gICAgaWYgKCFhdXRoLmlzTWFzdGVyKSB7XG4gICAgICByZXR1cm4gYXV0aC5nZXRVc2VyUm9sZXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfSkudGhlbigoKSA9PiB7XG4gICAgdmFyIG9wdGlvbnMgPSB7fTtcbiAgICBpZiAoIWF1dGguaXNNYXN0ZXIpIHtcbiAgICAgIG9wdGlvbnMuYWNsID0gWycqJ107XG4gICAgICBpZiAoYXV0aC51c2VyKSB7XG4gICAgICAgIG9wdGlvbnMuYWNsLnB1c2goYXV0aC51c2VyLmlkKTtcbiAgICAgICAgb3B0aW9ucy5hY2wgPSBvcHRpb25zLmFjbC5jb25jYXQoYXV0aC51c2VyUm9sZXMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb25maWcuZGF0YWJhc2UuZGVzdHJveShjbGFzc05hbWUsIHtcbiAgICAgIG9iamVjdElkOiBvYmplY3RJZFxuICAgIH0sIG9wdGlvbnMpO1xuICB9KS50aGVuKCgpID0+IHtcbiAgICByZXR1cm4gdHJpZ2dlcnMubWF5YmVSdW5UcmlnZ2VyKHRyaWdnZXJzLlR5cGVzLmFmdGVyRGVsZXRlLCBhdXRoLCBpbmZsYXRlZE9iamVjdCwgbnVsbCwgY29uZmlnKTtcbiAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgaGFuZGxlU2Vzc2lvbk1pc3NpbmdFcnJvcihlcnJvciwgY2xhc3NOYW1lLCBhdXRoKTtcbiAgfSk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIGZvciBhIHtyZXNwb25zZSwgc3RhdHVzLCBsb2NhdGlvbn0gb2JqZWN0LlxuZnVuY3Rpb24gY3JlYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0T2JqZWN0LCBjbGllbnRTREssIG9wdGlvbnMpIHtcbiAgZW5mb3JjZVJvbGVTZWN1cml0eSgnY3JlYXRlJywgY2xhc3NOYW1lLCBhdXRoKTtcbiAgdmFyIHdyaXRlID0gbmV3IFJlc3RXcml0ZShjb25maWcsIGF1dGgsIGNsYXNzTmFtZSwgbnVsbCwgcmVzdE9iamVjdCwgbnVsbCwgY2xpZW50U0RLLCBvcHRpb25zKTtcbiAgcmV0dXJuIHdyaXRlLmV4ZWN1dGUoKTtcbn1cblxuLy8gUmV0dXJucyBhIHByb21pc2UgdGhhdCBjb250YWlucyB0aGUgZmllbGRzIG9mIHRoZSB1cGRhdGUgdGhhdCB0aGVcbi8vIFJFU1QgQVBJIGlzIHN1cHBvc2VkIHRvIHJldHVybi5cbi8vIFVzdWFsbHksIHRoaXMgaXMganVzdCB1cGRhdGVkQXQuXG5mdW5jdGlvbiB1cGRhdGUoY29uZmlnLCBhdXRoLCBjbGFzc05hbWUsIHJlc3RXaGVyZSwgcmVzdE9iamVjdCwgY2xpZW50U0RLKSB7XG4gIGVuZm9yY2VSb2xlU2VjdXJpdHkoJ3VwZGF0ZScsIGNsYXNzTmFtZSwgYXV0aCk7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgIGNvbnN0IGhhc1RyaWdnZXJzID0gY2hlY2tUcmlnZ2VycyhjbGFzc05hbWUsIGNvbmZpZywgWydiZWZvcmVTYXZlJywgJ2FmdGVyU2F2ZSddKTtcbiAgICBjb25zdCBoYXNMaXZlUXVlcnkgPSBjaGVja0xpdmVRdWVyeShjbGFzc05hbWUsIGNvbmZpZyk7XG4gICAgaWYgKGhhc1RyaWdnZXJzIHx8IGhhc0xpdmVRdWVyeSkge1xuICAgICAgLy8gRG8gbm90IHVzZSBmaW5kLCBhcyBpdCBydW5zIHRoZSBiZWZvcmUgZmluZHNcbiAgICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5KGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUpXG4gICAgICAgIC5mb3JXcml0ZSgpXG4gICAgICAgIC5leGVjdXRlKCk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe30pO1xuICB9KS50aGVuKCh7IHJlc3VsdHMgfSkgPT4ge1xuICAgIHZhciBvcmlnaW5hbFJlc3RPYmplY3Q7XG4gICAgaWYgKHJlc3VsdHMgJiYgcmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgIG9yaWdpbmFsUmVzdE9iamVjdCA9IHJlc3VsdHNbMF07XG4gICAgfVxuICAgIHJldHVybiBuZXcgUmVzdFdyaXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUsIHJlc3RPYmplY3QsIG9yaWdpbmFsUmVzdE9iamVjdCwgY2xpZW50U0RLKVxuICAgICAgLmV4ZWN1dGUoKTtcbiAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgaGFuZGxlU2Vzc2lvbk1pc3NpbmdFcnJvcihlcnJvciwgY2xhc3NOYW1lLCBhdXRoKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IoZXJyb3IsIGNsYXNzTmFtZSkge1xuICAvLyBJZiB3ZSdyZSB0cnlpbmcgdG8gdXBkYXRlIGEgdXNlciB3aXRob3V0IC8gd2l0aCBiYWQgc2Vzc2lvbiB0b2tlblxuICBpZiAoY2xhc3NOYW1lID09PSAnX1VzZXInXG4gICAgICAmJiBlcnJvci5jb2RlID09PSBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5EKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlNFU1NJT05fTUlTU0lORywgJ0luc3VmZmljaWVudCBhdXRoLicpO1xuICB9XG4gIHRocm93IGVycm9yO1xufVxuXG5jb25zdCBjbGFzc2VzV2l0aE1hc3Rlck9ubHlBY2Nlc3MgPSBbJ19Kb2JTdGF0dXMnLCAnX1B1c2hTdGF0dXMnLCAnX0hvb2tzJywgJ19HbG9iYWxDb25maWcnLCAnX0pvYlNjaGVkdWxlJ107XG4vLyBEaXNhbGxvd2luZyBhY2Nlc3MgdG8gdGhlIF9Sb2xlIGNvbGxlY3Rpb24gZXhjZXB0IGJ5IG1hc3RlciBrZXlcbmZ1bmN0aW9uIGVuZm9yY2VSb2xlU2VjdXJpdHkobWV0aG9kLCBjbGFzc05hbWUsIGF1dGgpIHtcbiAgaWYgKGNsYXNzTmFtZSA9PT0gJ19JbnN0YWxsYXRpb24nICYmICFhdXRoLmlzTWFzdGVyKSB7XG4gICAgaWYgKG1ldGhvZCA9PT0gJ2RlbGV0ZScgfHwgbWV0aG9kID09PSAnZmluZCcpIHtcbiAgICAgIGNvbnN0IGVycm9yID0gYENsaWVudHMgYXJlbid0IGFsbG93ZWQgdG8gcGVyZm9ybSB0aGUgJHttZXRob2R9IG9wZXJhdGlvbiBvbiB0aGUgaW5zdGFsbGF0aW9uIGNvbGxlY3Rpb24uYFxuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvL2FsbCB2b2xhdGlsZUNsYXNzZXMgYXJlIG1hc3RlcktleSBvbmx5XG4gIGlmKGNsYXNzZXNXaXRoTWFzdGVyT25seUFjY2Vzcy5pbmRleE9mKGNsYXNzTmFtZSkgPj0gMCAmJiAhYXV0aC5pc01hc3Rlcil7XG4gICAgY29uc3QgZXJyb3IgPSBgQ2xpZW50cyBhcmVuJ3QgYWxsb3dlZCB0byBwZXJmb3JtIHRoZSAke21ldGhvZH0gb3BlcmF0aW9uIG9uIHRoZSAke2NsYXNzTmFtZX0gY29sbGVjdGlvbi5gXG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sIGVycm9yKTtcbiAgfVxuXG4gIC8vIHJlYWRPbmx5IG1hc3RlcktleSBpcyBub3QgYWxsb3dlZFxuICBpZiAoYXV0aC5pc1JlYWRPbmx5ICYmIChtZXRob2QgPT09ICdkZWxldGUnIHx8IG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJykpIHtcbiAgICBjb25zdCBlcnJvciA9IGByZWFkLW9ubHkgbWFzdGVyS2V5IGlzbid0IGFsbG93ZWQgdG8gcGVyZm9ybSB0aGUgJHttZXRob2R9IG9wZXJhdGlvbi5gXG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sIGVycm9yKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY3JlYXRlLFxuICBkZWwsXG4gIGZpbmQsXG4gIGdldCxcbiAgdXBkYXRlXG59O1xuIl19